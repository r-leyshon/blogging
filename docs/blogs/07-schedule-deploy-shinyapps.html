<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.3.450">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="author" content="Rich Leyshon">
<meta name="dcterms.date" content="2023-12-30">
<meta name="description" content="How to ingest data using Python requests &amp; ArcGIS REST API.">

<title>The Data Savvy Corner - Scheduled Deployment to Shinyapps.io</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
/* CSS for citations */
div.csl-bib-body { }
div.csl-entry {
  clear: both;
}
.hanging-indent div.csl-entry {
  margin-left:2em;
  text-indent:-2em;
}
div.csl-left-margin {
  min-width:2em;
  float:left;
}
div.csl-right-inline {
  margin-left:2em;
  padding-left:1em;
}
div.csl-indent {
  margin-left: 2em;
}</style>


<script src="../site_libs/quarto-nav/quarto-nav.js"></script>
<script src="../site_libs/quarto-nav/headroom.min.js"></script>
<link href="..//./www/favicon.ico" rel="icon">
<script src="../site_libs/clipboard/clipboard.min.js"></script>
<script src="../site_libs/quarto-html/quarto.js"></script>
<script src="../site_libs/quarto-html/popper.min.js"></script>
<script src="../site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="../site_libs/quarto-html/anchor.min.js"></script>
<link href="../site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="../site_libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="../site_libs/bootstrap/bootstrap.min.js"></script>
<link href="../site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="../site_libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>
<meta name="mermaid-theme" content="forest">
<script src="../site_libs/quarto-diagram/mermaid.min.js"></script>
<script src="../site_libs/quarto-diagram/mermaid-init.js"></script>
<link href="../site_libs/quarto-diagram/mermaid.css" rel="stylesheet">
<script async="" src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-6658778373981809" crossorigin="anonymous"></script>


<link rel="stylesheet" href="../www/styles.css">
<meta property="og:title" content="The Data Savvy Corner - Scheduled Deployment to Shinyapps.io">
<meta property="og:description" content="How to ingest data using Python requests &amp; ArcGIS REST API.">
<meta property="og:image" content="https://upload.wikimedia.org/wikipedia/commons/thumb/1/15/Prague_astronomical_clock_%286365120743%29.jpg/800px-Prague_astronomical_clock_%286365120743%29.jpg?20150530221207">
<meta property="og:site-name" content="The Data Savvy Corner">
<meta property="og:image:alt" content="Prague astronomical clock">
<meta name="twitter:title" content="The Data Savvy Corner - Scheduled Deployment to Shinyapps.io">
<meta name="twitter:description" content="How to ingest data using Python requests &amp; ArcGIS REST API.">
<meta name="twitter:image" content="https://upload.wikimedia.org/wikipedia/commons/thumb/1/15/Prague_astronomical_clock_%286365120743%29.jpg/800px-Prague_astronomical_clock_%286365120743%29.jpg?20150530221207">
<meta name="twitter:site" content="@Rich_L1984">
<meta name="twitter:image:alt" content="Prague astronomical clock">
<meta name="twitter:card" content="summary_large_image">
</head>

<body class="nav-fixed">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
    <nav class="navbar navbar-expand-lg navbar-dark ">
      <div class="navbar-container container-fluid">
      <div class="navbar-brand-container">
    <a class="navbar-brand" href="../index.html">
    <span class="navbar-title">The Data Savvy Corner</span>
    </a>
  </div>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse" aria-controls="navbarCollapse" aria-expanded="false" aria-label="Toggle navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
  <span class="navbar-toggler-icon"></span>
</button>
          <div class="collapse navbar-collapse" id="navbarCollapse">
            <ul class="navbar-nav navbar-nav-scroll me-auto">
  <li class="nav-item compact">
    <a class="nav-link" href="../index.xml" rel="" target=""><i class="bi bi-rss" role="img">
</i> 
 <span class="menu-text"></span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../blogs/index.html" rel="" target="">
 <span class="menu-text">Byte-Wise Musings</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../music-reviews/index.html" rel="" target="">
 <span class="menu-text">Productivity Pulse</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../book-reviews/index.html" rel="" target="">
 <span class="menu-text">Bookmarked Insights</span></a>
  </li>  
</ul>
            <div class="quarto-navbar-tools ms-auto">
</div>
          </div> <!-- /navcollapse -->
      </div> <!-- /container-fluid -->
    </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article page-navbar">
<!-- sidebar -->
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">On this page</h2>
   
  <ul>
  <li><a href="#introduction" id="toc-introduction" class="nav-link active" data-scroll-target="#introduction">Introduction</a>
  <ul class="collapse">
  <li><a href="#intended-audience" id="toc-intended-audience" class="nav-link" data-scroll-target="#intended-audience">Intended Audience</a></li>
  <li><a href="#the-scenario" id="toc-the-scenario" class="nav-link" data-scroll-target="#the-scenario">The Scenario</a></li>
  <li><a href="#what-youll-need" id="toc-what-youll-need" class="nav-link" data-scroll-target="#what-youll-need">What You’ll Need:</a></li>
  </ul></li>
  <li><a href="#develop-the-application" id="toc-develop-the-application" class="nav-link" data-scroll-target="#develop-the-application">Develop the Application</a>
  <ul class="collapse">
  <li><a href="#configure-the-development-environment" id="toc-configure-the-development-environment" class="nav-link" data-scroll-target="#configure-the-development-environment">Configure the Development Environment</a></li>
  <li><a href="#prepare-the-data" id="toc-prepare-the-data" class="nav-link" data-scroll-target="#prepare-the-data">Prepare the Data</a></li>
  <li><a href="#present-the-data" id="toc-present-the-data" class="nav-link" data-scroll-target="#present-the-data">Present the Data</a></li>
  </ul></li>
  <li><a href="#deploy-the-application" id="toc-deploy-the-application" class="nav-link" data-scroll-target="#deploy-the-application">Deploy the Application</a>
  <ul class="collapse">
  <li><a href="#local-deploy" id="toc-local-deploy" class="nav-link" data-scroll-target="#local-deploy">Local Deploy</a></li>
  <li><a href="#remote-deploy" id="toc-remote-deploy" class="nav-link" data-scroll-target="#remote-deploy">Remote Deploy</a></li>
  </ul></li>
  <li><a href="#tips-troubleshooting" id="toc-tips-troubleshooting" class="nav-link" data-scroll-target="#tips-troubleshooting">Tips &amp; Troubleshooting</a></li>
  <li><a href="#conclusion" id="toc-conclusion" class="nav-link" data-scroll-target="#conclusion">Conclusion</a></li>
  </ul>
</nav>
    </div>
<!-- main -->
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title">Scheduled Deployment to Shinyapps.io</h1>
  <div class="quarto-categories">
    <div class="quarto-category">How-to</div>
    <div class="quarto-category">Python Shiny</div>
    <div class="quarto-category">CI/CD</div>
    <div class="quarto-category">GitHub</div>
  </div>
  </div>

<div>
  <div class="description">
    How to ingest data using Python requests &amp; ArcGIS REST API.
  </div>
</div>


<div class="quarto-title-meta">

    <div>
    <div class="quarto-title-meta-heading">Author</div>
    <div class="quarto-title-meta-contents">
             <p>Rich Leyshon </p>
          </div>
  </div>
    
    <div>
    <div class="quarto-title-meta-heading">Published</div>
    <div class="quarto-title-meta-contents">
      <p class="date">December 30, 2023</p>
    </div>
  </div>
  
    
  </div>
  

</header>

<figure class="center figure">
<img class="shaded_box figure-img" width="400px" src="https://upload.wikimedia.org/wikipedia/commons/thumb/1/15/Prague_astronomical_clock_%286365120743%29.jpg/800px-Prague_astronomical_clock_%286365120743%29.jpg?20150530221207">
<figcaption style="text-align:center;" class="figure-caption">
<a href="https://commons.wikimedia.org/wiki/File:Prague_astronomical_clock_(6365120743).jpg">Wikimedia commons</a>: <a href="https://creativecommons.org/licenses/by/2.0/deed.en">Creative Commons</a>
</figcaption>
</figure>
<section id="introduction" class="level2">
<h2 class="anchored" data-anchor-id="introduction">Introduction</h2>
<p>This guide will walk you through the process of using GitHub Actions to schedule the update of a python shiny application and subsequent publication to the shinyapps.io <span class="citation" data-cites="ShinyAppsIO"><a href="#ref-ShinyAppsIO" role="doc-biblioref">[1]</a></span> service. The example used in this article is trivial and the <a href="https://github.com/r-leyshon/automate-shinyapps-deploy">source code can be inspected here</a>. This guide intends to help the casual developer keep their application data up-to-date.</p>
<div class="callout callout-style-default callout-caution callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Caution
</div>
</div>
<div class="callout-body-container callout-body">
<p>The tooling used in this article may not suit all requirements. GitHub Actions and Shinyapps.io all provide free tier services, allowing for equitable access. These services are ideal for prototyping purposes but come with limitations that may render them unsuitable for your purposes. For more information on the features of these services, please consult the Shinyapps.io features <span class="citation" data-cites="ShinyAppsIOFeatures"><a href="#ref-ShinyAppsIOFeatures" role="doc-biblioref">[2]</a></span> and the GitHub Actions documentation <span class="citation" data-cites="GitHubActions"><a href="#ref-GitHubActions" role="doc-biblioref">[3]</a></span>.</p>
</div>
</div>
<section id="intended-audience" class="level3">
<h3 class="anchored" data-anchor-id="intended-audience">Intended Audience</h3>
<p>An experienced python and git practitioner, able to create and manage a virtual environment but less familiar with the shinyapps.io service or GitHub Actions.</p>
</section>
<section id="the-scenario" class="level3">
<h3 class="anchored" data-anchor-id="the-scenario">The Scenario</h3>
<p>You have or are considering building a dynamic application, presenting the latest view of some data to your users. You would like to automate the data retrieval and application publication processes.</p>
</section>
<section id="what-youll-need" class="level3">
<h3 class="anchored" data-anchor-id="what-youll-need">What You’ll Need:</h3>
<ul class="task-list">
<li><input type="checkbox">A GitHub account</li>
<li><input type="checkbox">A shinyapps.io account</li>
<li><input type="checkbox">A permissive firewall</li>
<li><input type="checkbox">Python package manager (eg <code>pip</code>)</li>
<li><input type="checkbox">Python environment manager (eg <code>venv</code>, <code>poetry</code> etc)</li>
<li><input type="checkbox">Access to a command line interface (CLI) such as terminal / Bash.</li>
<li><input type="checkbox">Python requirements:</li>
</ul>
<div class="code-with-filename">
<div class="code-with-filename-file">
<pre><strong>requirements.txt</strong></pre>
</div>
<div class="sourceCode" id="cb1" data-eval="false"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a>shiny</span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a>rsconnect<span class="op">-</span>python</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
</section>
<section id="develop-the-application" class="level2">
<h2 class="anchored" data-anchor-id="develop-the-application">Develop the Application</h2>
<p>The steps in this guide result in a <a href="https://richleysh84.shinyapps.io/scheduled-deployment/">minimal application</a> that reports the time that it was deployed to shinyapps.io.</p>
<section id="configure-the-development-environment" class="level3">
<h3 class="anchored" data-anchor-id="configure-the-development-environment">Configure the Development Environment</h3>
<ol type="1">
<li>Create a new repository or; if you would rather skip the application development; <a href="https://github.com/r-leyshon/automate-shinyapps-deploy">clone this repository</a> and proceed to the <a href="#deploying-the-application">deployment stage</a>.</li>
<li>Clone the repository into your local development environment.</li>
<li>Create a clean virtual environment with python 3.11. At the time of writing, this is the most current version of python available to shinyapps.io servers.</li>
<li>Activate the environment.</li>
<li>Install the requirements.txt dependencies.</li>
</ol>
</section>
<section id="prepare-the-data" class="level3">
<h3 class="anchored" data-anchor-id="prepare-the-data">Prepare the Data</h3>
<div class="cell">
<div class="cell-output-display">
<div>
<div>
<pre class="mermaid mermaid-js">flowchart LR
    B(Job: Install dependencies)
    B ==&gt; C(Job: Run save_time.py)
    C --&gt;|write datetime.now| D[saved_time.txt]
 
</pre>
</div>
</div>
</div>
</div>
<p>This job prepares the database on which the application will depend. In this trivial example, we simply save the current time as a formatted string to a text file. This simple artifact will later be read into a shiny app to present as the time of deployment.</p>
<ol type="1">
<li>Create a python file called <code>save_time.py</code>.</li>
<li>Paste the following content into <code>save_time.py</code> and hit save:</li>
</ol>
<div class="code-with-filename">
<div class="code-with-filename-file">
<pre><strong>save_time.py</strong></pre>
</div>
<div class="sourceCode" id="cb2" data-eval="false"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> datetime <span class="im">import</span> datetime</span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a>nw <span class="op">=</span> datetime.now()</span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a>nw <span class="op">=</span> datetime.strftime(nw, <span class="st">"%Y-%m-</span><span class="sc">%d</span><span class="st"> %H:%M:%S"</span>)</span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true" tabindex="-1"></a><span class="cf">with</span> <span class="bu">open</span>(<span class="st">"saved_time.txt"</span>, <span class="st">"w"</span>) <span class="im">as</span> f:</span>
<span id="cb2-5"><a href="#cb2-5" aria-hidden="true" tabindex="-1"></a>    f.write(nw)</span>
<span id="cb2-6"><a href="#cb2-6" aria-hidden="true" tabindex="-1"></a>    f.close()</span>
<span id="cb2-7"><a href="#cb2-7" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Saved time is </span><span class="sc">{</span>nw<span class="sc">}</span><span class="ss">"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<ol start="3" type="1">
<li>Run the script from the terminal. A <code>saved_time.txt</code> file should appear in the project root:</li>
</ol>
<div class="code-with-filename">
<div class="code-with-filename-file">
<pre><strong>CLI</strong></pre>
</div>
<div class="sourceCode" id="cb3" data-eval="false"><pre class="sourceCode zsh code-with-copy"><code class="sourceCode zsh"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a><span class="ex">python3</span> save_time.py</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="present-the-data" class="level3">
<h3 class="anchored" data-anchor-id="present-the-data">Present the Data</h3>
<div class="cell">
<div class="cell-output-display">
<div>
<div>
<pre class="mermaid mermaid-js">flowchart LR
    B(Job: Install dependencies)
    B ==&gt; C(Job: Run save_time.py)
    C --&gt;|write datetime.now| D[saved_time.txt]

    G{{app.py}}
    D -.-&gt;|python -m shiny run app.py| G  
</pre>
</div>
</div>
</div>
</div>
<p>An application is needed to present the data to your user. In this example, the app will simply read in the date string created in the section <a href="#prepare-the-data">Prepare the Data</a>, format the datestring in a sentence and present it within the user interface.</p>
<ol type="1">
<li>Create a python file called <code>app.py</code>.</li>
<li>Paste the following into <code>app.py</code>:</li>
</ol>
<div class="code-with-filename">
<div class="code-with-filename-file">
<pre><strong>save_time.py</strong></pre>
</div>
<div class="sourceCode" id="cb4" data-eval="false"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> shiny <span class="im">import</span> App, render, ui</span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a><span class="co"># get the saved time</span></span>
<span id="cb4-3"><a href="#cb4-3" aria-hidden="true" tabindex="-1"></a><span class="cf">with</span> <span class="bu">open</span>(<span class="st">"saved_time.txt"</span>, <span class="st">"r"</span>) <span class="im">as</span> f:</span>
<span id="cb4-4"><a href="#cb4-4" aria-hidden="true" tabindex="-1"></a>    nw <span class="op">=</span> f.readlines()[<span class="dv">0</span>]</span>
<span id="cb4-5"><a href="#cb4-5" aria-hidden="true" tabindex="-1"></a>    f.close()</span>
<span id="cb4-6"><a href="#cb4-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-7"><a href="#cb4-7" aria-hidden="true" tabindex="-1"></a>app_ui <span class="op">=</span> ui.page_fluid(</span>
<span id="cb4-8"><a href="#cb4-8" aria-hidden="true" tabindex="-1"></a>    ui.h2(<span class="st">"Testing Deploy Schedule."</span>),</span>
<span id="cb4-9"><a href="#cb4-9" aria-hidden="true" tabindex="-1"></a>    ui.output_text(<span class="st">"txt"</span>),</span>
<span id="cb4-10"><a href="#cb4-10" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb4-11"><a href="#cb4-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-12"><a href="#cb4-12" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> server(<span class="bu">input</span>, output, session):</span>
<span id="cb4-13"><a href="#cb4-13" aria-hidden="true" tabindex="-1"></a>    <span class="at">@output</span></span>
<span id="cb4-14"><a href="#cb4-14" aria-hidden="true" tabindex="-1"></a>    <span class="at">@render.text</span></span>
<span id="cb4-15"><a href="#cb4-15" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> txt():</span>
<span id="cb4-16"><a href="#cb4-16" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="ss">f"Deployed at </span><span class="sc">{</span>nw<span class="sc">}</span><span class="ss">."</span></span>
<span id="cb4-17"><a href="#cb4-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-18"><a href="#cb4-18" aria-hidden="true" tabindex="-1"></a>app <span class="op">=</span> App(app_ui, server)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<ol start="3" type="1">
<li>Test the application locally by running it. This can be done from the CLI with the command:</li>
</ol>
<div class="code-with-filename">
<div class="code-with-filename-file">
<pre><strong>CLI</strong></pre>
</div>
<div class="sourceCode" id="cb5" data-eval="false"><pre class="sourceCode zsh code-with-copy"><code class="sourceCode zsh"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a><span class="ex">python</span> <span class="at">-m</span> shiny run ./app.py</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<ol start="4" type="1">
<li>If the application successfully launches, you should see a localhost url printed. Command and click on this or paste into your browser to confirm that the application deployed successfully. You should see the sentence <code>Deployed at &lt;SOME_DATETIME_INSERTED_HERE&gt;</code>.</li>
</ol>
</section>
</section>
<section id="deploy-the-application" class="level2">
<h2 class="anchored" data-anchor-id="deploy-the-application">Deploy the Application</h2>
<section id="local-deploy" class="level3">
<h3 class="anchored" data-anchor-id="local-deploy">Local Deploy</h3>
<div class="cell">
<div class="cell-output-display">
<div>
<div>
<pre class="mermaid mermaid-js">flowchart LR
    B(Job: Install dependencies)
    B ==&gt; C(Job: Run save_time.py)
    C --&gt;|write datetime.now| D[saved_time.txt]
    C ==&gt; E(Job: Configure rsconnect)
    H([SHINYAPPS_USERNAME\nSHINYAPPS_TOKEN\nSHINYAPPS_SECRET]) -.-&gt; E
    E ==&gt; F(Job: Deploy to rsconnect)
    F ==&gt; G{{shinyapps.io: serve app.py}}
    D -.-&gt;|python -m shiny run app.py| G  

</pre>
</div>
</div>
</div>
</div>
<p>The first stage of deployment should be to manually upload the application to your shinyapps.io account. It is required to do this manually in the first instance, as it will allow you to retrieve an app ID for the app deployment. This will ensure that when you use GitHub Actions to do the same, complications overwriting the application data are avoided. For more information on deploying to shinyapps.io, consult the python shiny cloud hosting documentation <span class="citation" data-cites="ShinyCloudHosting"><a href="#ref-ShinyCloudHosting" role="doc-biblioref">[4]</a></span>, the shinyapps.io documentation <span class="citation" data-cites="ShinyAppsDocsDeploy"><a href="#ref-ShinyAppsDocsDeploy" role="doc-biblioref">[5]</a></span> and the Rsconnect-python documentation <span class="citation" data-cites="RSConnectDocs"><a href="#ref-RSConnectDocs" role="doc-biblioref">[6]</a></span>. It is also advisable to manually deploy in the first instance in order to confirm that your app runs on shinyapps.io servers. With a simple app like this one, it should be a straightforward matter, but with a larger, more complex app, debugging problems on a remote server can be quite time consuming.</p>
<ol type="1">
<li>Follow the shinyapps.io deployment documentation <span class="citation" data-cites="ShinyAppsDocsDeploy"><a href="#ref-ShinyAppsDocsDeploy" role="doc-biblioref">[5]</a></span> to retrieve your username, token and secret. Store these somewhere secure.</li>
<li>Take precautions not to accidentally commit these credentials to your repository. I recommend both gitignoring the file that you stored them and using detect-secrets <span class="citation" data-cites="DetectSecrets"><a href="#ref-DetectSecrets" role="doc-biblioref">[7]</a></span> if you are familiar with pre-commit hooks.</li>
<li>Configure an rsconnect server with the following command in your CLI, replacing the account, token and secret with your credentials:</li>
</ol>
<div class="code-with-filename">
<div class="code-with-filename-file">
<pre><strong>CLI</strong></pre>
</div>
<div class="sourceCode" id="cb6" data-eval="False"><pre class="sourceCode zsh code-with-copy"><code class="sourceCode zsh"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a><span class="ex">rsconnect</span> add <span class="at">--account</span> <span class="op">&lt;</span>YOUR_USERNAME<span class="op">&gt;</span> --name rsconnect-server <span class="at">--token</span> <span class="op">&lt;</span>YOUR_TOKEN<span class="op">&gt;</span> --secret <span class="op">&lt;</span>YOUR_SECRET<span class="op">&gt;</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Note that you can give the server any name you wish, here I have used the imaginative name <code>rsconnect-server</code>. You must refer to this server name in <code>&lt;YOUR_SERVER_NAME&gt;</code> in the next step. If successful, you should see output in the CLI like below:</p>
<div class="sourceCode" id="cb7" data-eval="false"><pre class="sourceCode zsh code-with-copy"><code class="sourceCode zsh"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a><span class="ex">Checking</span> shinyapps.io credential...              <span class="pp">[</span><span class="st">OK</span><span class="pp">]</span></span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a><span class="ex">Updated</span> shinyapps.io credential <span class="st">"&lt;YOUR_SERVER_NAME&gt;"</span>.</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<ol start="4" type="1">
<li>Now use the configured rsconnect server to deploy your local app to the cloud, run the below command in the CLI, inserting the name of the server you configured in the previous step and an appropriate application title. Avoid using spaces in the application title as I have found this causes issues when deploying with certain versions of <code>rsconnect-python</code>:</li>
</ol>
<div class="code-with-filename">
<div class="code-with-filename-file">
<pre><strong>CLI</strong></pre>
</div>
<div class="sourceCode" id="cb8" data-eval="False"><pre class="sourceCode zsh code-with-copy"><code class="sourceCode zsh"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a><span class="ex">rsconnect</span> deploy shiny ./ <span class="at">--name</span> <span class="op">&lt;</span>YOUR_SERVER_NAME<span class="op">&gt;</span>  --title <span class="op">&lt;</span>ENTER_AN_APP_TITLE<span class="op">&gt;</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>A successful deployment will confirm in the CLI like below:</p>
<div class="sourceCode" id="cb9" data-eval="false"><pre class="sourceCode zsh code-with-copy"><code class="sourceCode zsh"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a><span class="ex">Application</span> successfully deployed to <span class="op">&lt;</span>YOUR_APP_URL<span class="op">&gt;</span></span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true" tabindex="-1"></a>        <span class="ex">[OK]</span></span>
<span id="cb9-3"><a href="#cb9-3" aria-hidden="true" tabindex="-1"></a><span class="ex">Saving</span> deployed information...  <span class="pp">[</span><span class="st">OK</span><span class="pp">]</span></span>
<span id="cb9-4"><a href="#cb9-4" aria-hidden="true" tabindex="-1"></a><span class="ex">Verifying</span> deployed content...   <span class="pp">[</span><span class="st">OK</span><span class="pp">]</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<ol start="5" type="1">
<li>The previous step creates a metadata directory called <code>rsconnect-python</code>. I suggest adding this lint to your <code>.gitignore</code> file.</li>
<li>The hosted application should launch in your default browser on successful deployment. If not, then visit the url printed in the terminal output and check everything is working as expected.</li>
</ol>
</section>
<section id="remote-deploy" class="level3">
<h3 class="anchored" data-anchor-id="remote-deploy">Remote Deploy</h3>
<p>Now that the application has been successfuly deployed, the application ID can be retrieved and used in a GitHub Action workflow to schedule the application deployment. This stage will involve configuring environment variables and secrets in our GitHub repository. The guidance for configuring this is correct at the time of writing but be advised that GitHub frequently update their user interface.</p>
<section id="configure-the-repository-environment" class="level4">
<h4 class="anchored" data-anchor-id="configure-the-repository-environment">Configure the Repository Environment</h4>
<ol type="1">
<li>Retrieve the application ID. You can find this either in your shinyapps.io dashboard or by copying the value from the json file saved in the <code>rsconnect-python/</code> following a successful deployment.</li>
<li>Navigate to the GitHub repository in your browser.</li>
<li>Access the environment variables under <code>Settings</code> -&gt; <code>Secrets and variables</code> -&gt; <code>Actions</code> -&gt; <code>Variables</code>.</li>
<li>Save an environment variable called <code>SHINYAPPS_USERNAME</code> with your shinyapps.io username. Ensure that the values are correct and authenticate when prompted by GitHub to save the variable.</li>
<li>Now click on the <code>Secrets</code> tab and repeat this process for the three required secrets:
<ul>
<li><code>APP_ID</code></li>
<li><code>SHINYAPPS_TOKEN</code></li>
<li><code>SHINYAPPS_SECRET</code></li>
</ul>
These values will be encrypted and masked if you try to print them in workflow logs. Consult the GitHub Actions Security Documentation <span class="citation" data-cites="GitHubActionsSecurity"><a href="#ref-GitHubActionsSecurity" role="doc-biblioref">[8]</a></span> for more on features and best practice.</li>
</ol>
</section>
<section id="set-up-the-workflow" class="level4">
<h4 class="anchored" data-anchor-id="set-up-the-workflow">Set Up the Workflow</h4>
<p>In this section, a script is created that will execute the job of updating the app and deploying to shinyapps.io. It will grab the secrets and variables that created in the <a href="#configure-the-repository-environment">previous stage</a>.</p>
<ol type="1">
<li>Create the following directory to store the workflow script:</li>
</ol>
<div class="code-with-filename">
<div class="code-with-filename-file">
<pre><strong>CLI</strong></pre>
</div>
<div class="sourceCode" id="cb10" data-eval="false"><pre class="sourceCode zsh code-with-copy"><code class="sourceCode zsh"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a><span class="fu">mkdir</span> <span class="at">-p</span> .github/workflows</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<ol start="2" type="1">
<li>In that folder, create a YAML file that will contain the necessary logic to update and deploy the app.</li>
</ol>
<div class="code-with-filename">
<div class="code-with-filename-file">
<pre><strong>CLI</strong></pre>
</div>
<div class="sourceCode" id="cb11" data-eval="false"><pre class="sourceCode zsh code-with-copy"><code class="sourceCode zsh"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a><span class="fu">touch</span> .github/workflows/update.yml</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<ol start="3" type="1">
<li>Update the YAML file with the content below, note that I have included notes in the file to help understand the purpose of each step, but feel free to remove them if needed:</li>
</ol>
<div class="code-with-filename">
<div class="code-with-filename-file">
<pre><strong>update.yml</strong></pre>
</div>
<div class="sourceCode" id="cb12" data-eval="false"><pre class="sourceCode YAML code-with-copy"><code class="sourceCode yaml"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a><span class="fu">name</span><span class="kw">:</span><span class="at"> Update Application</span></span>
<span id="cb12-2"><a href="#cb12-2" aria-hidden="true" tabindex="-1"></a><span class="fu">on</span><span class="kw">:</span></span>
<span id="cb12-3"><a href="#cb12-3" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="fu">schedule</span><span class="kw">:</span></span>
<span id="cb12-4"><a href="#cb12-4" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="kw">-</span><span class="at"> </span><span class="fu">cron</span><span class="kw">:</span><span class="at"> </span><span class="st">'0 0 * * 6'</span><span class="co"> # at midnight every Saturday, see https://crontab.guru/</span></span>
<span id="cb12-5"><a href="#cb12-5" aria-hidden="true" tabindex="-1"></a><span class="fu">jobs</span><span class="kw">:</span></span>
<span id="cb12-6"><a href="#cb12-6" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="fu">build</span><span class="kw">:</span></span>
<span id="cb12-7"><a href="#cb12-7" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="fu">runs-on</span><span class="kw">:</span><span class="at"> ubuntu-latest</span><span class="co"> # this os tends to be quick &amp; flexible</span></span>
<span id="cb12-8"><a href="#cb12-8" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="fu">steps</span><span class="kw">:</span></span>
<span id="cb12-9"><a href="#cb12-9" aria-hidden="true" tabindex="-1"></a><span class="at">      </span><span class="kw">-</span><span class="at"> </span><span class="fu">uses</span><span class="kw">:</span><span class="at"> actions/checkout@v3</span><span class="co"> # premade action that allows your action to access your code</span></span>
<span id="cb12-10"><a href="#cb12-10" aria-hidden="true" tabindex="-1"></a><span class="at">      </span><span class="kw">-</span><span class="at"> </span><span class="fu">uses</span><span class="kw">:</span><span class="at"> actions/setup-python@v3</span><span class="co"> # premade action that will install &amp; configure python</span></span>
<span id="cb12-11"><a href="#cb12-11" aria-hidden="true" tabindex="-1"></a><span class="at">        </span><span class="fu">with</span><span class="kw">:</span></span>
<span id="cb12-12"><a href="#cb12-12" aria-hidden="true" tabindex="-1"></a><span class="at">          </span><span class="fu">python-version</span><span class="kw">:</span><span class="at"> </span><span class="fl">3.11</span><span class="co"> # this needs to be a version compatible with shinyapps.io servers</span></span>
<span id="cb12-13"><a href="#cb12-13" aria-hidden="true" tabindex="-1"></a><span class="at">      </span><span class="kw">-</span><span class="at"> </span><span class="fu">name</span><span class="kw">:</span><span class="at"> Install dependencies </span></span>
<span id="cb12-14"><a href="#cb12-14" aria-hidden="true" tabindex="-1"></a><span class="fu">        run</span><span class="kw">: </span><span class="ch">|</span></span>
<span id="cb12-15"><a href="#cb12-15" aria-hidden="true" tabindex="-1"></a>          python -m pip install --upgrade pip</span>
<span id="cb12-16"><a href="#cb12-16" aria-hidden="true" tabindex="-1"></a>          pip install -r requirements.txt</span>
<span id="cb12-17"><a href="#cb12-17" aria-hidden="true" tabindex="-1"></a><span class="at">      </span><span class="kw">-</span><span class="at"> </span><span class="fu">name</span><span class="kw">:</span><span class="at"> Update saved time</span><span class="co"> # create the little saved_time.txt artifact</span></span>
<span id="cb12-18"><a href="#cb12-18" aria-hidden="true" tabindex="-1"></a><span class="fu">        run</span><span class="kw">: </span><span class="ch">|</span></span>
<span id="cb12-19"><a href="#cb12-19" aria-hidden="true" tabindex="-1"></a>          python3 save_time.py</span>
<span id="cb12-20"><a href="#cb12-20" aria-hidden="true" tabindex="-1"></a><span class="at">      </span><span class="kw">-</span><span class="at"> </span><span class="fu">name</span><span class="kw">:</span><span class="at"> Configure rsconnect</span><span class="co"> # set up an rsconnect server. Relies on repo vars &amp; secrets</span></span>
<span id="cb12-21"><a href="#cb12-21" aria-hidden="true" tabindex="-1"></a><span class="fu">        run</span><span class="kw">: </span><span class="ch">|</span></span>
<span id="cb12-22"><a href="#cb12-22" aria-hidden="true" tabindex="-1"></a>          rsconnect add --account ${{ vars.SHINYAPPS_USERNAME }} --name rsconnect-server --token ${{ secrets.SHINYAPPS_TOKEN }} --secret ${{ secrets.SHINYAPPS_SECRET }}</span>
<span id="cb12-23"><a href="#cb12-23" aria-hidden="true" tabindex="-1"></a><span class="at">      </span><span class="kw">-</span><span class="at"> </span><span class="fu">name</span><span class="kw">:</span><span class="at"> Deploy to rsconnect</span><span class="co"> # app-id parameter allows reliable overwriting of app content without creating duplicates.</span></span>
<span id="cb12-24"><a href="#cb12-24" aria-hidden="true" tabindex="-1"></a><span class="fu">        run</span><span class="kw">: </span><span class="ch">|</span></span>
<span id="cb12-25"><a href="#cb12-25" aria-hidden="true" tabindex="-1"></a>          rsconnect deploy shiny --app-id ${{ secrets.APP_ID }} ./ --name rsconnect-server  --title scheduled-deployment</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<ol start="4" type="1">
<li>Once everything has been done, add and commit all the changes and push them to your remote. The next time your cronjob triggers, navigate to your repository in your browser and inspect the workflow logs under <code>Actions</code> -&gt; <code>All workflows</code>.</li>
</ol>
</section>
</section>
</section>
<section id="tips-troubleshooting" class="level2">
<h2 class="anchored" data-anchor-id="tips-troubleshooting">Tips &amp; Troubleshooting</h2>
<ul>
<li>To see a list of your configured rsconnect servers, use the <code>rsconnect list</code> command in the CLI.</li>
<li>To remove a server, use <code>rsconnect remove --name &lt;SERVER_NAME&gt;</code> in the CLI.</li>
<li>If you encounter an error when deploying your app in step 4 that states “not found”, try deleting the folder called <code>rsconnect-python</code> if it exists and run the deploy command once more.</li>
</ul>
</section>
<section id="conclusion" class="level2">
<h2 class="anchored" data-anchor-id="conclusion">Conclusion</h2>
<p>The full workflow is visualised in the process diagram below.</p>
<div class="cell">
<div class="cell-output-display">
<div>
<div>
<pre class="mermaid mermaid-js">flowchart LR
    A[update.yml] ==&gt;|Saturday 00:00| B(Job: Install dependencies)
    B ==&gt; C(Job: Run save_time.py)
    C --&gt;|write datetime.now| D[saved_time.txt]
    C ==&gt; E(Job: Configure rsconnect)
    H([SHINYAPPS_USERNAME\nSHINYAPPS_TOKEN\nSHINYAPPS_SECRET]) -.-&gt; E
    E ==&gt; F(Job: Deploy to rsconnect)
    K([APP_ID]) -.-&gt; F
    F ==&gt; G{{shinyapps.io: serve app.py}}
    D -.-&gt;|python -m shiny run app.py| G    
</pre>
</div>
</div>
</div>
</div>
<p>This workflow can be adapted to serve a real business need. For example, a similar workflow is used to produce a basic <a href="https://richleysh84.shinyapps.io/org-bounty-board/">‘bounty board’ app</a> to help colleagues extract GitHub issues and PRs. <a href="https://github.com/r-leyshon/org-issue-tool">Code available here</a>.</p>
<p>The workflow file can also be improved upon to take advantage of the new GitHub Actions cacheing feature <span class="citation" data-cites="GitHubActionsCacheing"><a href="#ref-GitHubActionsCacheing" role="doc-biblioref">[9]</a></span>. This will make subsequent runs faster still as dependencies and configuration can be saved between runs.</p>
<p id="fin">
<i>fin!</i>
</p>



</section>

<div id="quarto-appendix" class="default"><section class="quarto-appendix-contents" role="doc-bibliography"><h2 class="anchored quarto-appendix-heading">References</h2><div id="refs" class="references csl-bib-body" role="list">
<div id="ref-ShinyAppsIO" class="csl-entry" role="listitem">
<div class="csl-left-margin">[1] </div><div class="csl-right-inline">Posit Software, <span>“<span class="nocase">shinyapps.io</span>.”</span> <a href="{https://www.shinyapps.io/}">{https://www.shinyapps.io/}</a></div>
</div>
<div id="ref-ShinyAppsIOFeatures" class="csl-entry" role="listitem">
<div class="csl-left-margin">[2] </div><div class="csl-right-inline">Posit Software, <span>“<span class="nocase">shinyapps.io</span>.”</span> <a href="{https://www.shinyapps.io/#features}">{https://www.shinyapps.io/#features}</a></div>
</div>
<div id="ref-GitHubActions" class="csl-entry" role="listitem">
<div class="csl-left-margin">[3] </div><div class="csl-right-inline">GitHub, <span>“<span>GitHub Actions Documentation</span>.”</span> <a href="{https://docs.github.com/en/actions}">{https://docs.github.com/en/actions}</a></div>
</div>
<div id="ref-ShinyCloudHosting" class="csl-entry" role="listitem">
<div class="csl-left-margin">[4] </div><div class="csl-right-inline">Posit Software, <span>“<span class="nocase">Shiny for Python Cloud Hosting</span>.”</span> <a href="{https://shiny.posit.co/py/docs/deploy-cloud.html}">{https://shiny.posit.co/py/docs/deploy-cloud.html}</a></div>
</div>
<div id="ref-ShinyAppsDocsDeploy" class="csl-entry" role="listitem">
<div class="csl-left-margin">[5] </div><div class="csl-right-inline">Shinyapps.io team, <span>“<span class="nocase">Shinyapps.io documentation chapter 2.2.2 Deploying applications</span>.”</span> <a href="{https://docs.posit.co/shinyapps.io/getting-started.html#deploying-applications-1}">{https://docs.posit.co/shinyapps.io/getting-started.html#deploying-applications-1}</a></div>
</div>
<div id="ref-RSConnectDocs" class="csl-entry" role="listitem">
<div class="csl-left-margin">[6] </div><div class="csl-right-inline">Posit Software, <span>“<span class="nocase">Rsconnect-python documentation</span>.”</span> <a href="{https://docs.posit.co/rsconnect-python/}">{https://docs.posit.co/rsconnect-python/}</a></div>
</div>
<div id="ref-DetectSecrets" class="csl-entry" role="listitem">
<div class="csl-left-margin">[7] </div><div class="csl-right-inline">Yelp, Inc., <span>“<span>Detect Secrets</span>.”</span> <a href="{https://github.com/Yelp/detect-secrets}">{https://github.com/Yelp/detect-secrets}</a></div>
</div>
<div id="ref-GitHubActionsSecurity" class="csl-entry" role="listitem">
<div class="csl-left-margin">[8] </div><div class="csl-right-inline">GitHub, <span>“<span>GitHub Actions Security Documentation</span>.”</span> <a href="{https://docs.github.com/en/actions/security-guides/}">{https://docs.github.com/en/actions/security-guides/}</a></div>
</div>
<div id="ref-GitHubActionsCacheing" class="csl-entry" role="listitem">
<div class="csl-left-margin">[9] </div><div class="csl-right-inline">GitHub, <span>“<span>GitHub Actions Security Documentation</span>.”</span> <a href="{https://docs.github.com/en/actions/using-workflows/caching-dependencies-to-speed-up-workflows}">{https://docs.github.com/en/actions/using-workflows/caching-dependencies-to-speed-up-workflows}</a></div>
</div>
</div></section></div></main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    text: function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
  function tippyHover(el, contentFn) {
    const config = {
      allowHTML: true,
      content: contentFn,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start'
    };
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      return note.innerHTML;
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
</div> <!-- /content -->



</body></html>