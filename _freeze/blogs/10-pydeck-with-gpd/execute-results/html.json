{
  "hash": "e517c5204ee1ba4ad0d20df7ee54d0c6",
  "result": {
    "engine": "jupyter",
    "markdown": "---\ntitle: Getting Pydeck to Play Nicely with GeoPandas.\nauthor: Rich Leyshon\ndate: February 18 2024\ndescription: Building Pydeck Maps from GeoPandas GeoDataFrames.\ncategories:\n  - How To\n  - Geospatial\n  - pydeck\n  - geopandas\nimage: /./www/10-pydeck-with-gpd/intro-img.jpg\nimage-alt: A futuristic topography.\ntoc: true\n---\n\n<img class=shaded_box src=/./www/10-pydeck-with-gpd/intro-img.jpg alt=\"A futuristic topography.\" style=\"display:block;margin-left:auto;margin-right:auto;width:40%;border:none;\">\n\n## Introduction\n\nPydeck is a python client for pydeck.gl, a powerful geospatial visualisation\nlibrary. It's a relatively new library and integrating it with the existing\npython geospatial ecosystem is currently a little tricky. This article\ndemonstrates how to build pydeck ScatterplotLayer and GeoJsonLayer from\ngeopandas GeoDataFrames.\n\n- <a href=\"https://deckgl.readthedocs.io/en/latest/\" target=\"_blank\">Pydeck documentation</a>\n- <a href=\"https://deck.gl/#/\" target=\"_blank\">Deck.gl documentation</a>\n\n:::{.callout collapse=\"true\"}\n\n### A Note on the Purpose\n\nThe content of this article was written using pydeck 0.8.0. Future releases may\nalter the package behaviour.\n:::\n\n### Intended Audience\n\nPython practitioners familiar with virtual environments, `requests` and\ngeospatial analysis with `geopandas`.\n\n### The Scenario\n\nYou have a geopandas GeoDataFrame with point or polygon geometries. You are\nattempting to build a pydeck visualisation but end up with empty basemap tiles.\n\n### What You'll Need:\n\n- [ ] Preferred python environment manager (eg `conda`)\n- [ ] Python package manager (eg `pip`)\n- [ ] `requirements.txt`:\n\n```{.python filename=requirements.txt eval=false}\ngeopandas\npandas\npydeck\nrequests\n\n```\n## Prepare Environment\n\n1. Create a virtual environment.\n2. Install the required dependencies.\n3. Activate the virtual environment.\n4. Create a python script and import the dependencies.\n\n::: {#0f875fe2 .cell execution_count=1}\n``` {.python .cell-code}\nimport json\n\nimport geopandas as gpd\nimport numpy as np\nimport pandas as pd\nimport pydeck as pdk\nimport requests\nfrom sklearn import preprocessing\n```\n:::\n\n\n## Build a `ScatterplotLayer`\n\n### Ingest Data\n\nFor the point data, I will ingest all Welsh lower super output area 2021\npopulation-weighted centroids from\n[ONS Open Geography Portal](https://geoportal.statistics.gov.uk/datasets/79fa1c80981b4e4eb218bbce1afc304b_0/explore).\n\nFor more on working with ONS Open Geography Portal, see\n[Getting Data from ONS Open Geography Portal](/./blogs/06-working-with-ONS-open-geo-portal.qmd).\n\n::: {#5c063023 .cell execution_count=2}\n``` {.python .cell-code code-fold=\"true\" code-summary=\"Show the code\"}\nENDPOINT = \"https://services1.arcgis.com/ESMARspQHYMw9BZ9/arcgis/rest/services/LSOA_Dec_2001_Address_Weighted_Centroids/FeatureServer/0/query\"\nPARAMS = {\n    \"where\": \"LSOA01CD like 'W%'\",\n    \"f\": \"geoJSON\", \n    \"outFields\": \"*\",\n    \"outSR\": 4326,\n}\nresp = requests.get(ENDPOINT, params=PARAMS)\nif resp.ok:\n    content = resp.json()\nelse:\n    raise requests.RequestException(f\"HTTP {resp.status_code} : {resp.reason}\")\n\ncentroids = gpd.GeoDataFrame.from_features(\n    features=content[\"features\"], crs=content[\"crs\"][\"properties\"][\"name\"])\ncentroids.head()\n```\n\n::: {.cell-output .cell-output-display execution_count=10}\n```{=html}\n<div>\n<style scoped>\n    .dataframe tbody tr th:only-of-type {\n        vertical-align: middle;\n    }\n\n    .dataframe tbody tr th {\n        vertical-align: top;\n    }\n\n    .dataframe thead th {\n        text-align: right;\n    }\n</style>\n<table border=\"1\" class=\"dataframe\">\n  <thead>\n    <tr style=\"text-align: right;\">\n      <th></th>\n      <th>geometry</th>\n      <th>FID</th>\n      <th>LSOA01CD</th>\n      <th>LSOA01NM</th>\n      <th>GlobalID</th>\n    </tr>\n  </thead>\n  <tbody>\n    <tr>\n      <th>0</th>\n      <td>POINT (-4.48753 53.21121)</td>\n      <td>32483</td>\n      <td>W01000001</td>\n      <td>Isle of Anglesey 007A</td>\n      <td>632b3471-50a2-44f9-89e4-5050aa4cef2d</td>\n    </tr>\n    <tr>\n      <th>1</th>\n      <td>POINT (-4.49972 53.23116)</td>\n      <td>32484</td>\n      <td>W01000002</td>\n      <td>Isle of Anglesey 007B</td>\n      <td>5692b19c-1a5f-4c05-afc0-c2edfea245a4</td>\n    </tr>\n    <tr>\n      <th>2</th>\n      <td>POINT (-4.3401 53.4107)</td>\n      <td>32485</td>\n      <td>W01000003</td>\n      <td>Isle of Anglesey 001A</td>\n      <td>e4283fbe-c7e7-49bc-b500-1d8d50fb9d40</td>\n    </tr>\n    <tr>\n      <th>3</th>\n      <td>POINT (-4.36017 53.40926)</td>\n      <td>32486</td>\n      <td>W01000004</td>\n      <td>Isle of Anglesey 001B</td>\n      <td>b09e019d-53a5-449b-8e6b-575dc41e64cc</td>\n    </tr>\n    <tr>\n      <th>4</th>\n      <td>POINT (-4.09597 53.26754)</td>\n      <td>32487</td>\n      <td>W01000005</td>\n      <td>Isle of Anglesey 005A</td>\n      <td>ae6cd331-976b-434c-9816-78c73f4519c2</td>\n    </tr>\n  </tbody>\n</table>\n</div>\n```\n:::\n:::\n\n\nThe geometry column is not in a format that pydeck will accept. Adding a column\nwith a list of long,lat values for each coordinate will do the trick.\n\n::: {#17af07b0 .cell execution_count=3}\n``` {.python .cell-code}\ncentroids[\"pydeck_geometry\"] = [[c.x, c.y] for c in centroids[\"geometry\"]]\ncentroids.head()\n```\n\n::: {.cell-output .cell-output-display execution_count=11}\n```{=html}\n<div>\n<style scoped>\n    .dataframe tbody tr th:only-of-type {\n        vertical-align: middle;\n    }\n\n    .dataframe tbody tr th {\n        vertical-align: top;\n    }\n\n    .dataframe thead th {\n        text-align: right;\n    }\n</style>\n<table border=\"1\" class=\"dataframe\">\n  <thead>\n    <tr style=\"text-align: right;\">\n      <th></th>\n      <th>geometry</th>\n      <th>FID</th>\n      <th>LSOA01CD</th>\n      <th>LSOA01NM</th>\n      <th>GlobalID</th>\n      <th>pydeck_geometry</th>\n    </tr>\n  </thead>\n  <tbody>\n    <tr>\n      <th>0</th>\n      <td>POINT (-4.48753 53.21121)</td>\n      <td>32483</td>\n      <td>W01000001</td>\n      <td>Isle of Anglesey 007A</td>\n      <td>632b3471-50a2-44f9-89e4-5050aa4cef2d</td>\n      <td>[-4.48753395527061, 53.2112123262102]</td>\n    </tr>\n    <tr>\n      <th>1</th>\n      <td>POINT (-4.49972 53.23116)</td>\n      <td>32484</td>\n      <td>W01000002</td>\n      <td>Isle of Anglesey 007B</td>\n      <td>5692b19c-1a5f-4c05-afc0-c2edfea245a4</td>\n      <td>[-4.49971934089987, 53.2311602303036]</td>\n    </tr>\n    <tr>\n      <th>2</th>\n      <td>POINT (-4.3401 53.4107)</td>\n      <td>32485</td>\n      <td>W01000003</td>\n      <td>Isle of Anglesey 001A</td>\n      <td>e4283fbe-c7e7-49bc-b500-1d8d50fb9d40</td>\n      <td>[-4.34010067656253, 53.410704332678]</td>\n    </tr>\n    <tr>\n      <th>3</th>\n      <td>POINT (-4.36017 53.40926)</td>\n      <td>32486</td>\n      <td>W01000004</td>\n      <td>Isle of Anglesey 001B</td>\n      <td>b09e019d-53a5-449b-8e6b-575dc41e64cc</td>\n      <td>[-4.36016879975651, 53.4092571939596]</td>\n    </tr>\n    <tr>\n      <th>4</th>\n      <td>POINT (-4.09597 53.26754)</td>\n      <td>32487</td>\n      <td>W01000005</td>\n      <td>Isle of Anglesey 005A</td>\n      <td>ae6cd331-976b-434c-9816-78c73f4519c2</td>\n      <td>[-4.09597137054812, 53.2675370762765]</td>\n    </tr>\n  </tbody>\n</table>\n</div>\n```\n:::\n:::\n\n\n### Pydeck Visualisation\n\nWith the correct geometry format, the scatterplot is trivial.\n\n:::{.callout-tip}\nControl the map by click and dragging the map with your mouse. Hold shift +\nclick and drag to yaw or pitch the map. Scroll in and out to alter the zoom.\n:::\n\n::: {#28172938 .cell execution_count=4}\n``` {.python .cell-code}\nscatter = pdk.Layer(\n    \"ScatterplotLayer\",\n    centroids,\n    pickable=True,\n    stroked=True,\n    filled=True,\n    line_width_min_pixels=1,\n    get_position=\"pydeck_geometry\",\n    get_fill_color=[255, 140, 0],\n    get_line_color=[255, 140, 0],\n    radius_min_pixels=3,\n    opacity=0.1,\n)\n# Set the viewport location\nview_state = pdk.ViewState(\n    longitude=-3.7,\n    latitude=52.42,\n    zoom=5.8,\n    max_zoom=15,\n    pitch=0,\n    bearing=0,\n)\ntooltip = {\n    \"text\": \"LSOA01CD: {LSOA01CD}\"\n}\n# Render and save to file\nr = pdk.Deck(\n    layers=scatter, initial_view_state=view_state, tooltip=tooltip\n)\nr.to_html(\"../outputs/scatter_layer.html\")\n```\n:::\n\n\n<iframe src=\"../outputs/scatter_layer.html\" style=\"width: 100%; height: 400px; border: none;\"></iframe>\n\n\n\n## Build a `GeoJsonLayer`\n\nGeoJsonLayer is what tends to be used for presenting polygons with pydeck maps.\nThe pydeck docs [GeoJsonLayer example](https://deckgl.readthedocs.io/en/latest/gallery/geojson_layer.html)\nuses geoJSON data hosted on GitHub. But with a little effort, a Geopandas\nGeoDataFrame can be coerced to the necessary format.\n\n### Ingest Data\n\nTo demonstrate working with polygons, the Welsh super generalised 2023 local\nauthority district boundaries will be ingested from\n[ONS Open Geography Portal](https://geoportal.statistics.gov.uk/datasets/2e9f5c259fec4e1c9951ecb974253c66_0/explore?location=55.223511%2C-3.317025%2C6.81).\n\nAs elevation and polygon colour will be controlled by features of the data,\nsklearn.prepeocessing is used to scale the \"Shape__Area\" column.\n\n::: {#bcfc4daa .cell execution_count=6}\n``` {.python .cell-code code-fold=\"true\" code-summary=\"Show the code\"}\nENDPOINT=\"https://services1.arcgis.com/ESMARspQHYMw9BZ9/arcgis/rest/services/LPA_APR_2023_UK_BFC_V2/FeatureServer/0/query\"\nPARAMS[\"where\"] = \"LPA23CD like 'W%'\"\nresp = requests.get(ENDPOINT, params=PARAMS)\nif resp.ok:\n    content = resp.json()\nelse:\n    raise requests.RequestException(f\"HTTP {resp.status_code} : {resp.reason}\")\n\npolygons = gpd.GeoDataFrame.from_features(\n    features=content[\"features\"], crs=content[\"crs\"][\"properties\"][\"name\"])\n# simplify geometries to reduce file size (tolerance in degrees, ~0.005 â‰ˆ 500m)\npolygons[\"geometry\"] = polygons[\"geometry\"].simplify(tolerance=0.005)\n# feature engineering for pydeck viz\nmin_max_scaler = preprocessing.MinMaxScaler()\nx = polygons[\"Shape__Area\"].values.reshape(-1, 1)\nx_scaled = min_max_scaler.fit_transform(x)\npolygons[\"area_norm\"] = pd.Series(x_scaled.flatten())\npolygons.head()\n```\n\n::: {.cell-output .cell-output-display execution_count=14}\n```{=html}\n<div>\n<style scoped>\n    .dataframe tbody tr th:only-of-type {\n        vertical-align: middle;\n    }\n\n    .dataframe tbody tr th {\n        vertical-align: top;\n    }\n\n    .dataframe thead th {\n        text-align: right;\n    }\n</style>\n<table border=\"1\" class=\"dataframe\">\n  <thead>\n    <tr style=\"text-align: right;\">\n      <th></th>\n      <th>geometry</th>\n      <th>FID</th>\n      <th>LPA23CD</th>\n      <th>LPA23NM</th>\n      <th>BNG_E</th>\n      <th>BNG_N</th>\n      <th>LAT</th>\n      <th>LONG</th>\n      <th>Shape__Area</th>\n      <th>Shape__Length</th>\n      <th>GlobalID</th>\n      <th>area_norm</th>\n    </tr>\n  </thead>\n  <tbody>\n    <tr>\n      <th>0</th>\n      <td>MULTIPOLYGON (((-4.40784 53.14366, -4.406 53.1...</td>\n      <td>355</td>\n      <td>W43000001</td>\n      <td>Isle of Anglesey LPA</td>\n      <td>245217</td>\n      <td>378331</td>\n      <td>53.27931</td>\n      <td>-4.32298</td>\n      <td>7.152126e+08</td>\n      <td>378962.151195</td>\n      <td>583e6fd7-73b4-4552-b4ff-131feefc9b1e</td>\n      <td>0.149112</td>\n    </tr>\n    <tr>\n      <th>1</th>\n      <td>MULTIPOLYGON (((-4.0606 52.54119, -4.06114 52....</td>\n      <td>356</td>\n      <td>W43000002</td>\n      <td>Gwynedd LPA</td>\n      <td>240370</td>\n      <td>342614</td>\n      <td>52.95710</td>\n      <td>-4.37784</td>\n      <td>8.543757e+08</td>\n      <td>533231.922496</td>\n      <td>24471b2b-7165-4efa-9cd2-751a8d959548</td>\n      <td>0.182133</td>\n    </tr>\n    <tr>\n      <th>2</th>\n      <td>MULTIPOLYGON (((-4.07744 52.60258, -4.0769 52....</td>\n      <td>357</td>\n      <td>W43000003</td>\n      <td>Snowdonia National Park LPA</td>\n      <td>274065</td>\n      <td>343183</td>\n      <td>52.97118</td>\n      <td>-3.87678</td>\n      <td>2.123936e+09</td>\n      <td>469780.038857</td>\n      <td>18787502-7d4d-4aa9-927e-f015cf8485bb</td>\n      <td>0.483375</td>\n    </tr>\n    <tr>\n      <th>3</th>\n      <td>MULTIPOLYGON (((-3.83259 53.19737, -3.83279 53...</td>\n      <td>358</td>\n      <td>W43000004</td>\n      <td>Conwy LPA</td>\n      <td>284314</td>\n      <td>367524</td>\n      <td>53.19220</td>\n      <td>-3.73300</td>\n      <td>7.019447e+08</td>\n      <td>281739.033311</td>\n      <td>b6121569-ea54-4bdf-9dfa-5f6628cf599e</td>\n      <td>0.145964</td>\n    </tr>\n    <tr>\n      <th>4</th>\n      <td>MULTIPOLYGON (((-3.46001 53.28197, -3.46036 53...</td>\n      <td>359</td>\n      <td>W43000005</td>\n      <td>Denbighshire LPA</td>\n      <td>309843</td>\n      <td>355416</td>\n      <td>53.08833</td>\n      <td>-3.34761</td>\n      <td>8.387145e+08</td>\n      <td>228762.694083</td>\n      <td>392d4649-3109-4c66-9cc9-88e155481952</td>\n      <td>0.178417</td>\n    </tr>\n  </tbody>\n</table>\n</div>\n```\n:::\n:::\n\n\nIn order to pass the content of this GeoDataFrame to pydeck, use the `to_json`\nmethod to format as a geoJSON string. Then use `json.loads()` to format that\nstring as a dictionary.\n\n::: {#b7289a9b .cell execution_count=7}\n``` {.python .cell-code}\n# format data for use in pydeck\njson_out = json.loads(polygons.to_json())\n# inspect the first authority\njson_out[\"features\"][0][\"properties\"]\n```\n\n::: {.cell-output .cell-output-display execution_count=15}\n```\n{'FID': 355,\n 'LPA23CD': 'W43000001',\n 'LPA23NM': 'Isle of Anglesey LPA',\n 'BNG_E': 245217,\n 'BNG_N': 378331,\n 'LAT': 53.27931,\n 'LONG': -4.32298,\n 'Shape__Area': 715212566.8575134,\n 'Shape__Length': 378962.15119468677,\n 'GlobalID': '583e6fd7-73b4-4552-b4ff-131feefc9b1e',\n 'area_norm': 0.1491122832502275}\n```\n:::\n:::\n\n\n### Pydeck Visualisation\n\nThis format can now be passed to pydeck. One 'gotcha' to be aware of, when\nusing attributes in the json to control elevation or colour, the json\nproperties must be explicitly referenced, eg `\"properties.area_norm\"`.\n\nIn contrast, when using json attributes in the tooltip, you can refer to them\ndirectly, eg `\"area_norm\"`.\n\n::: {#c6450cf4 .cell execution_count=8}\n``` {.python .cell-code}\nr = \"100\"\ng = \"(1 - properties.area_norm) * 255\"\nb = \"properties.area_norm * 255\"\nfill = f\"[{r},{g},{b}]\"\ngeojson = pdk.Layer(\n        \"GeoJsonLayer\",\n        json_out,\n        pickable=True,\n        opacity=1,\n        stroked=True,\n        filled=True,\n        extruded=True,\n        wireframe=True,\n        auto_highlight=True,\n        get_elevation=\"properties.area_norm * 200\",\n        elevation_scale=100,\n        get_fill_color=fill,\n    )\ntooltip = {\"text\": \"{LPA23NM}\\n{LPA23CD}\"}\nview_state = pdk.ViewState(\n    longitude=-3.7,\n    latitude=52.42,\n    zoom=6.5,\n    max_zoom=15,\n    pitch=100,\n    bearing=33,\n)\nr = pdk.Deck(\n    layers=geojson,\n    initial_view_state=view_state,\n    tooltip=tooltip,\n)\nr.to_html(\"../outputs/geojson_layer.html\")\n```\n:::\n\n\n<iframe src=\"../outputs/geojson_layer.html\" style=\"width: 100%; height: 400px; border: none;\"></iframe>\n\n## Tips\n\n* `pydeck` does not raise when layer data are not formatted correctly. This\ncan result in some lengthy render times only to discover you have an empty map.\nTo combat this, work with the head or some small sample of your data until you\nhave your map working.\n\n## Conclusion\n\nThis article has recorded the state of play between `pydeck` and `geopandas` at\nthe time of writing. Specifically, formatting:\n\n* geometry columns for pydeck `ScatterplotLayer`\n* a GeoDataFrame for use with pydeck `GeoJsonLayer`.\n\nI hope it saves someone some time bashing geopandas about.\n\n<p id=fin><i>fin!</i></p>\n\n",
    "supporting": [
      "10-pydeck-with-gpd_files"
    ],
    "filters": [],
    "includes": {
      "include-in-header": [
        "<script src=\"https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.6/require.min.js\" integrity=\"sha512-c3Nl8+7g4LMSTdrm621y7kf9v3SDPnhxLNhcjFJbKECVnmZHTdo+IRO05sNLTH/D3vA6u1X32ehoLC7WFVdheg==\" crossorigin=\"anonymous\"></script>\n<script src=\"https://cdnjs.cloudflare.com/ajax/libs/jquery/3.5.1/jquery.min.js\" integrity=\"sha512-bLT0Qm9VnAYZDflyKcBaQ2gg0hSYNQrJ8RilYldYQ1FxQYoCLtUjuuRuZo+fjqhx/qtq/1itJ0C2ejDxltZVFg==\" crossorigin=\"anonymous\" data-relocate-top=\"true\"></script>\n<script type=\"application/javascript\">define('jquery', [],function() {return window.jQuery;})</script>\n"
      ]
    }
  }
}