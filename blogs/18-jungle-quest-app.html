<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.5.57">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="author" content="Rich Leyshon">
<meta name="dcterms.date" content="2024-09-21">
<meta name="description" content="Iteratively Building an LLM-Powered Shiny Application.">

<title>Choose Your Own Adventure with ChatGPT – The Data Savvy Corner</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { display: inline-block; text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="../site_libs/quarto-nav/quarto-nav.js"></script>
<script src="../site_libs/quarto-nav/headroom.min.js"></script>
<link href="..//./favicon.ico" rel="icon">
<script src="../site_libs/clipboard/clipboard.min.js"></script>
<script src="../site_libs/quarto-html/quarto.js"></script>
<script src="../site_libs/quarto-html/popper.min.js"></script>
<script src="../site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="../site_libs/quarto-html/anchor.min.js"></script>
<link href="../site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="../site_libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" class="quarto-color-scheme" id="quarto-text-highlighting-styles">
<link href="../site_libs/quarto-html/quarto-syntax-highlighting-dark.css" rel="prefetch" class="quarto-color-scheme quarto-color-alternate" id="quarto-text-highlighting-styles">
<script src="../site_libs/bootstrap/bootstrap.min.js"></script>
<link href="../site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="../site_libs/bootstrap/bootstrap.min.css" rel="stylesheet" class="quarto-color-scheme" id="quarto-bootstrap" data-mode="light">
<link href="../site_libs/bootstrap/bootstrap-dark.min.css" rel="prefetch" class="quarto-color-scheme quarto-color-alternate" id="quarto-bootstrap" data-mode="dark">
<script id="quarto-search-options" type="application/json">{
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>
<script async="" src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-6658778373981809" crossorigin="anonymous"></script>


<link rel="stylesheet" href="../www/styles.css">
<link rel="stylesheet" href=".././www/17-quarto-comments/styles.css">
<meta property="og:title" content="Choose Your Own Adventure with ChatGPT – The Data Savvy Corner">
<meta property="og:description" content="Iteratively Building an LLM-Powered Shiny Application.">
<meta property="og:image" content="https://i.imgur.com/z9Xm9Lf.jpeg">
<meta property="og:site_name" content="The Data Savvy Corner">
<meta property="og:image:alt" content="Adventurer reading a large book within a mysterious jungle temple.">
<meta name="twitter:title" content="Choose Your Own Adventure with ChatGPT – The Data Savvy Corner">
<meta name="twitter:description" content="Iteratively Building an LLM-Powered Shiny Application.">
<meta name="twitter:image" content="https://i.imgur.com/z9Xm9Lf.jpeg">
<meta name="twitter:site" content="@Rich_L1984">
<meta name="twitter:image:alt" content="Adventurer reading a large book within a mysterious jungle temple.">
<meta name="twitter:card" content="summary_large_image">
</head>

<body class="nav-fixed">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
    <nav class="navbar navbar-expand-lg " data-bs-theme="dark">
      <div class="navbar-container container-fluid">
      <div class="navbar-brand-container mx-auto">
    <a class="navbar-brand" href="../index.html">
    <span class="navbar-title">The Data Savvy Corner</span>
    </a>
  </div>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse" aria-controls="navbarCollapse" role="menu" aria-expanded="false" aria-label="Toggle navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
  <span class="navbar-toggler-icon"></span>
</button>
          <div class="collapse navbar-collapse" id="navbarCollapse">
            <ul class="navbar-nav navbar-nav-scroll me-auto">
  <li class="nav-item compact">
    <a class="nav-link" href="../index.xml"> <i class="bi bi-rss" role="img">
</i> 
<span class="menu-text"></span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../blogs/index.html"> 
<span class="menu-text">Technical Blogs</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../music-reviews/index.html"> 
<span class="menu-text">Music</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../book-reviews/index.html"> 
<span class="menu-text">Books</span></a>
  </li>  
</ul>
          </div> <!-- /navcollapse -->
            <div class="quarto-navbar-tools tools-wide">
    <a href="https://twitter.com/Rich_L1984" title="" class="quarto-navigation-tool px-1" aria-label=""><i class="bi bi-twitter-x"></i></a>
    <a href="https://github.com/r-leyshon" title="" class="quarto-navigation-tool px-1" aria-label=""><i class="bi bi-github"></i></a>
    <a href="https://www.linkedin.com/in/richard-leyshon-316121163/" title="" class="quarto-navigation-tool px-1" aria-label=""><i class="bi bi-linkedin"></i></a>
  <a href="" class="quarto-color-scheme-toggle quarto-navigation-tool  px-1" onclick="window.quartoToggleColorScheme(); return false;" title="Toggle dark mode"><i class="bi"></i></a>
</div>
      </div> <!-- /container-fluid -->
    </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article page-navbar">
<!-- sidebar -->
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">On this page</h2>
   
  <ul>
  <li><a href="#introduction" id="toc-introduction" class="nav-link active" data-scroll-target="#introduction">Introduction</a>
  <ul class="collapse">
  <li><a href="#intended-audience" id="toc-intended-audience" class="nav-link" data-scroll-target="#intended-audience">Intended Audience</a></li>
  <li><a href="#what-youll-need" id="toc-what-youll-need" class="nav-link" data-scroll-target="#what-youll-need">What You’ll Need</a></li>
  </ul></li>
  <li><a href="#setting-up-the-development-environment" id="toc-setting-up-the-development-environment" class="nav-link" data-scroll-target="#setting-up-the-development-environment">Setting up the Development Environment</a></li>
  <li><a href="#iterative-development" id="toc-iterative-development" class="nav-link" data-scroll-target="#iterative-development">Iterative Development</a></li>
  <li><a href="#conclusion" id="toc-conclusion" class="nav-link" data-scroll-target="#conclusion">Conclusion</a></li>
  <li><a href="#call-to-action" id="toc-call-to-action" class="nav-link" data-scroll-target="#call-to-action">Call to Action</a></li>
  </ul>
</nav>
    </div>
<!-- main -->
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title">Choose Your Own Adventure with ChatGPT</h1>
  <div class="quarto-categories">
    <div class="quarto-category">Tutorial</div>
    <div class="quarto-category">Python Shiny</div>
    <div class="quarto-category">LLMs</div>
    <div class="quarto-category">Large Language Models</div>
    <div class="quarto-category">GenAI</div>
    <div class="quarto-category">Generative AI</div>
    <div class="quarto-category">Front End Dev</div>
    <div class="quarto-category">OpenAI</div>
  </div>
  </div>

<div>
  <div class="description">
    Iteratively Building an LLM-Powered Shiny Application.
  </div>
</div>


<div class="quarto-title-meta">

    <div>
    <div class="quarto-title-meta-heading">Author</div>
    <div class="quarto-title-meta-contents">
             <p>Rich Leyshon </p>
          </div>
  </div>
    
    <div>
    <div class="quarto-title-meta-heading">Published</div>
    <div class="quarto-title-meta-contents">
      <p class="date">September 21, 2024</p>
    </div>
  </div>
  
    
  </div>
  


</header>


<figure class="center figure">
<img class="shaded_box figure-img" src="https://i.imgur.com/z9Xm9Lf.jpeg" alt="Adventurer reading within a jungle temple." width="120%">
</figure>
<blockquote class="blockquote">
<p>“ChatGPT amplifies human potential, turning thoughts into creation. It reminds us that imagination, when paired with technology, can shape the future.” ChatGPT on the creative potential of ChatGPT.</p>
</blockquote>
<section id="introduction" class="level2">
<h2 class="anchored" data-anchor-id="introduction">Introduction</h2>
<p>This article will guide you through the process of building a Choose Your Own Adventure game using ChatGPT and Python Shiny. We’ll walk through the entire journey, from concept to deployment, with a focus on the iterative development process and the use of ChatGPT for generating storylines.</p>
<p>Choose Your Own Adventure is a classic storytelling format where the reader is presented with a series of choices that guide the story in different directions. The game is interactive, allowing the reader to make decisions that affect the outcome of the story. They were popular in the 1980s and early 1990s, widely available as graphic novels and comics with a fantasy or adventure theme.</p>
<p>The aim of this project is to produce an interactive application that will put the OpenAI GPT-3.5-turbo model to work. The model will generate the branching outcomes depending on the choices made by the user. We will provide the user with an introduction to the theme and we will provide the model with the rules for the game. Each game will play out differently depending on the creative interplay between the user and the model.</p>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center" data-bs-toggle="collapse" data-bs-target=".callout-1-contents" aria-controls="callout-1" aria-expanded="false" aria-label="Toggle callout">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Inspiration for This Blog (Click to expand)
</div>
<div class="callout-btn-toggle d-inline-block border-0 py-1 ps-1 pe-0 float-end"><i class="callout-toggle"></i></div>
</div>
<div id="callout-1" class="callout-1-contents callout-collapse collapse">
<div class="callout-body-container callout-body">
<p>The application concept was heavily influenced by the YouTube video by Tech with Tim called <a href="https://www.youtube.com/watch?v=nhYcTh6vw9A" target="_blank">Python AI Choose Your Own Adventure Game - Tutorial</a>. This tutorial uses a more complicated stack behind the scenes and resulted in a game that solved itself - essentially the model would also generate ‘imagined’ user responses through to completion. The tutorial was published only 11 months ago at the time of writing, though the code would not run without significant wiggling, due to a raft of breaking changes within langchain.</p>
<p>I was inspired by the playful use of generative AI but could see that a few things could be done to improve the reproducibility of the code. Also, by simplifying the stack required to generate the game responses, it is hoped that the risk of deprecation and breaking changes will be reduced, increasing the longevity of the code. Finally, an application would be needed in order to allow the human player and model to take turns in playing the game. I have opted to use <a href="https://shiny.posit.co/py/" target="_blank">Shiny for Python</a> in order to achieve this, though the same functionality could be achieved with many other dashboarding solutions.</p>
</div>
</div>
</div>
<section id="intended-audience" class="level3">
<h3 class="anchored" data-anchor-id="intended-audience">Intended Audience</h3>
<p>Python programmers who are curious about building LLM-enabled applications. Some familiarity with Shiny may be assumed. For an overview and intro to building Shiny apps with Python, chack out my other blogs:</p>
<ul>
<li><a href="../blogs/01-state-of-pyshiny.html">The State of Python Shiny</a></li>
<li><a href="../blogs/02-getting-started-pyshiny.html">Let’s Build a Basic Python Shiny App</a></li>
</ul>
</section>
<section id="what-youll-need" class="level3">
<h3 class="anchored" data-anchor-id="what-youll-need">What You’ll Need</h3>
<ul class="task-list">
<li><label><input type="checkbox">Command line access</label></li>
<li><label><input type="checkbox">Python know-how</label>
<ul class="task-list">
<li><label><input type="checkbox">Configure a virtual environment</label></li>
<li><label><input type="checkbox">Dependency management</label></li>
</ul></li>
<li><label><input type="checkbox">Basic knowledge of Python Shiny</label></li>
<li><label><input type="checkbox">An OpenAI API key</label></li>
</ul>
<div class="code-with-filename">
<div class="code-with-filename-file">
<pre><strong>requirements.txt</strong></pre>
</div>
<div class="sourceCode" id="cb1" data-filename="requirements.txt"><pre class="sourceCode abc code-with-copy"><code class="sourceCode abc"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a>openai==1.30.4</span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a>shiny==1.1.0</span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a>shinyswatch==0.7.0</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="callout callout-style-simple callout-none no-icon callout-titled">
<div class="callout-header d-flex align-content-center" data-bs-toggle="collapse" data-bs-target=".callout-2-contents" aria-controls="callout-2" aria-expanded="false" aria-label="Toggle callout">
<div class="callout-icon-container">
<i class="callout-icon no-icon"></i>
</div>
<div class="callout-title-container flex-fill">
A Note on the Purpose (Click to expand)
</div>
<div class="callout-btn-toggle d-inline-block border-0 py-1 ps-1 pe-0 float-end"><i class="callout-toggle"></i></div>
</div>
<div id="callout-2" class="callout-2-contents callout-collapse collapse">
<div class="callout-body-container callout-body">
<p>This article intends to discuss clearly. It doesn’t aim to be clever or impressive. Its aim is to extend understanding without overwhelming the reader. The code may not always be optimal, favouring a simplistic approach wherever possible. The application may not be to your liking. The purpose is to introduce a simple AI-driven applications rather than a masterpiece. If you have ideas for improvements to the app or blog, please feel free to leave a comment at then end of the article.</p>
</div>
</div>
</div>
<p>The final application is presented below, hosted with <a href="https://www.shinyapps.io/" target="_blank">shinyapps.io</a>. Please note, this is not configured for high traffic. Let me know if the app fails to launch for you by leaving a comment at the end of the blog. You will need an OpenAI API key in order to prompt the model. The app has a link to the sign up page if you would like to give it a try. If you would prefer to read the source code for the application before proceeding with the article, then please click on the GitHub icon at the top-right of the application. If you would rather interact with the application in a full-sized window, then visit the <a href="https://richleysh84.shinyapps.io/choose-adventure/" target="_blank">Jungle Quest app on shinyapps.io</a>. This app is set up to query the gpt-3.5-turbo model, but as you proceed through the tutorial, feel free to experiment with other available models (they can behave quite differently).</p>
<iframe class="iframey" src="https://richleysh84.shinyapps.io/choose-adventure/" style="overflow:hidden;margin:0;padding:0;width:100%;height:50rem">
</iframe>
</section>
</section>
<section id="setting-up-the-development-environment" class="level2">
<h2 class="anchored" data-anchor-id="setting-up-the-development-environment">Setting up the Development Environment</h2>
<p>I’d recommend using VSCode with the <a href="https://marketplace.visualstudio.com/items?itemName=Posit.shiny" target="_blank">Shiny extension</a> to help run and debug the app. It has a super handy utility for launching your app within the VSCode interface or expanding it to full screen in your default browser. This is priceless when testing your User Interface’s (UI) appearance on different browsers.</p>
<p>You’ll need to create and activate a virtual environment of your choice, I have used python 3.12 in the examples without any issues. install the dependencies listed in the <code>requirements.txt</code> file, and finally ensure that VSCode is configured to <a href="https://code.visualstudio.com/docs/python/environments" target="_blank">use the virtual environment</a>.</p>
</section>
<section id="iterative-development" class="level2">
<h2 class="anchored" data-anchor-id="iterative-development">Iterative Development</h2>
<div class="callout callout-style-default callout-caution callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Caution
</div>
</div>
<div class="callout-body-container callout-body">
<p>Take care with your OpenAI APi credentials. I demonstrate hard-coding these credentials within python scripts for simplicity. I’d advise storing them in a git-ignored secrets file or using the <a href="https://pypi.org/project/python-dotenv/" target="_blank"><code>python-dotenv</code></a> package to keep them safe. Take care not to accidentally commit these credentials and expose them on GitHub. Leakage of OpenAI credentials is the fastest-growing type of secret leak, according to <a href="https://www.gitguardian.com/state-of-secrets-sprawl-report-2024" target="_blank">Git Guardian’s State of Secret Sprawl 2024</a>.</p>
<p>Finally, please note that usage of the openai service associated with your is associated to your account via your API key and should conform to the <a href="https://openai.com/policies/" target="_blank">service’s usage policy.</a></p>
</div>
</div>
<div class="callout callout-style-default callout-tip callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Code Annotations
</div>
</div>
<div class="callout-body-container callout-body">
<p>By clicking on the numbered points within the code blocks, you should see tooltips with additional explanations.</p>
</div>
</div>
<div class="tabset-margin-container"></div><div id="iterations" class="panel-tabset">
<ul class="nav nav-tabs" role="tablist"><li class="nav-item" role="presentation"><a class="nav-link active" id="tabset-1-1-tab" data-bs-toggle="tab" data-bs-target="#tabset-1-1" role="tab" aria-controls="tabset-1-1" aria-selected="true">Iteration 1</a></li><li class="nav-item" role="presentation"><a class="nav-link" id="tabset-1-2-tab" data-bs-toggle="tab" data-bs-target="#tabset-1-2" role="tab" aria-controls="tabset-1-2" aria-selected="false">Iteration 2</a></li><li class="nav-item" role="presentation"><a class="nav-link" id="tabset-1-3-tab" data-bs-toggle="tab" data-bs-target="#tabset-1-3" role="tab" aria-controls="tabset-1-3" aria-selected="false">Iteration 3</a></li><li class="nav-item" role="presentation"><a class="nav-link" id="tabset-1-4-tab" data-bs-toggle="tab" data-bs-target="#tabset-1-4" role="tab" aria-controls="tabset-1-4" aria-selected="false">Iteration 4</a></li><li class="nav-item" role="presentation"><a class="nav-link" id="tabset-1-5-tab" data-bs-toggle="tab" data-bs-target="#tabset-1-5" role="tab" aria-controls="tabset-1-5" aria-selected="false">Iteration 5</a></li><li class="nav-item" role="presentation"><a class="nav-link" id="tabset-1-6-tab" data-bs-toggle="tab" data-bs-target="#tabset-1-6" role="tab" aria-controls="tabset-1-6" aria-selected="false">Iteration 6</a></li><li class="nav-item" role="presentation"><a class="nav-link" id="tabset-1-7-tab" data-bs-toggle="tab" data-bs-target="#tabset-1-7" role="tab" aria-controls="tabset-1-7" aria-selected="false">Iteration 7</a></li><li class="nav-item" role="presentation"><a class="nav-link" id="tabset-1-8-tab" data-bs-toggle="tab" data-bs-target="#tabset-1-8" role="tab" aria-controls="tabset-1-8" aria-selected="false">Iteration 8</a></li><li class="nav-item" role="presentation"><a class="nav-link" id="tabset-1-9-tab" data-bs-toggle="tab" data-bs-target="#tabset-1-9" role="tab" aria-controls="tabset-1-9" aria-selected="false">Iteration 9</a></li></ul>
<div id="iterations" class="tab-content">
<div id="tabset-1-1" class="tab-pane active" role="tabpanel" aria-labelledby="tabset-1-1-tab">
<p>In this early prototype, we will focus on using the openai python client to send a basic prompt to the gpt-3.5-turbo model.</p>
<div class="code-with-filename">
<div class="code-with-filename-file">
<pre><strong>app.py</strong></pre>
</div>
<div class="sourceCode" id="annotated-cell-3" data-filename="app.py"><pre class="sourceCode python code-annotation-code code-with-copy code-annotated"><code class="sourceCode python"><span id="annotated-cell-3-1"><a href="#annotated-cell-3-1" aria-hidden="true" tabindex="-1"></a><span class="co">"""Iteration 1: How to query the OpenAI API."""</span></span>
<span id="annotated-cell-3-2"><a href="#annotated-cell-3-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> openai</span>
<span id="annotated-cell-3-3"><a href="#annotated-cell-3-3" aria-hidden="true" tabindex="-1"></a></span>
<button class="code-annotation-anchor" data-target-cell="annotated-cell-3" data-target-annotation="1">1</button><span id="annotated-cell-3-4" class="code-annotation-target"><a href="#annotated-cell-3-4" aria-hidden="true" tabindex="-1"></a>API_KEY <span class="op">=</span> <span class="st">"&lt;INSERT_YOUR_KEY_HERE&gt;"</span></span>
<span id="annotated-cell-3-5"><a href="#annotated-cell-3-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="annotated-cell-3-6"><a href="#annotated-cell-3-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="annotated-cell-3-7"><a href="#annotated-cell-3-7" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> query_openai(prompt: <span class="bu">str</span>, api_key: <span class="bu">str</span>) <span class="op">-&gt;</span> <span class="bu">str</span>:</span>
<span id="annotated-cell-3-8"><a href="#annotated-cell-3-8" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""Query the chat completions endpoint.</span></span>
<span id="annotated-cell-3-9"><a href="#annotated-cell-3-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="annotated-cell-3-10"><a href="#annotated-cell-3-10" aria-hidden="true" tabindex="-1"></a><span class="co">    Parameters</span></span>
<span id="annotated-cell-3-11"><a href="#annotated-cell-3-11" aria-hidden="true" tabindex="-1"></a><span class="co">    ----------</span></span>
<span id="annotated-cell-3-12"><a href="#annotated-cell-3-12" aria-hidden="true" tabindex="-1"></a><span class="co">    prompt: str</span></span>
<span id="annotated-cell-3-13"><a href="#annotated-cell-3-13" aria-hidden="true" tabindex="-1"></a><span class="co">        The prompt to query the chat completions endpoint with.</span></span>
<span id="annotated-cell-3-14"><a href="#annotated-cell-3-14" aria-hidden="true" tabindex="-1"></a><span class="co">    api_key: str</span></span>
<span id="annotated-cell-3-15"><a href="#annotated-cell-3-15" aria-hidden="true" tabindex="-1"></a><span class="co">        The API key to use to query the chat completions endpoint.</span></span>
<span id="annotated-cell-3-16"><a href="#annotated-cell-3-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="annotated-cell-3-17"><a href="#annotated-cell-3-17" aria-hidden="true" tabindex="-1"></a><span class="co">    Returns</span></span>
<span id="annotated-cell-3-18"><a href="#annotated-cell-3-18" aria-hidden="true" tabindex="-1"></a><span class="co">    -------</span></span>
<span id="annotated-cell-3-19"><a href="#annotated-cell-3-19" aria-hidden="true" tabindex="-1"></a><span class="co">    str</span></span>
<span id="annotated-cell-3-20"><a href="#annotated-cell-3-20" aria-hidden="true" tabindex="-1"></a><span class="co">        The response from the chat completions endpoint.</span></span>
<span id="annotated-cell-3-21"><a href="#annotated-cell-3-21" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="annotated-cell-3-22"><a href="#annotated-cell-3-22" aria-hidden="true" tabindex="-1"></a></span>
<button class="code-annotation-anchor" data-target-cell="annotated-cell-3" data-target-annotation="2">2</button><span id="annotated-cell-3-23" class="code-annotation-target"><a href="#annotated-cell-3-23" aria-hidden="true" tabindex="-1"></a>    client <span class="op">=</span> openai.OpenAI(api_key<span class="op">=</span>api_key)</span>
<span id="annotated-cell-3-24"><a href="#annotated-cell-3-24" aria-hidden="true" tabindex="-1"></a>    <span class="co"># need to handle cases where queries go wrong.</span></span>
<button class="code-annotation-anchor" data-target-cell="annotated-cell-3" data-target-annotation="3">3</button><span id="annotated-cell-3-25" class="code-annotation-target"><a href="#annotated-cell-3-25" aria-hidden="true" tabindex="-1"></a>    <span class="cf">try</span>:</span>
<span id="annotated-cell-3-26"><a href="#annotated-cell-3-26" aria-hidden="true" tabindex="-1"></a>        response <span class="op">=</span> client.chat.completions.create(</span>
<span id="annotated-cell-3-27"><a href="#annotated-cell-3-27" aria-hidden="true" tabindex="-1"></a>            model<span class="op">=</span><span class="st">"gpt-3.5-turbo"</span>,</span>
<button class="code-annotation-anchor" data-target-cell="annotated-cell-3" data-target-annotation="4">4</button><span id="annotated-cell-3-28" class="code-annotation-target"><a href="#annotated-cell-3-28" aria-hidden="true" tabindex="-1"></a>            messages<span class="op">=</span>[</span>
<span id="annotated-cell-3-29"><a href="#annotated-cell-3-29" aria-hidden="true" tabindex="-1"></a>                {<span class="st">"role"</span>: <span class="st">"user"</span>, <span class="st">"content"</span>: prompt}</span>
<span id="annotated-cell-3-30"><a href="#annotated-cell-3-30" aria-hidden="true" tabindex="-1"></a>            ]</span>
<span id="annotated-cell-3-31"><a href="#annotated-cell-3-31" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="annotated-cell-3-32"><a href="#annotated-cell-3-32" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> response.choices[<span class="dv">0</span>].message.content</span>
<span id="annotated-cell-3-33"><a href="#annotated-cell-3-33" aria-hidden="true" tabindex="-1"></a>    <span class="co"># in cases where the API key is invalid.</span></span>
<span id="annotated-cell-3-34"><a href="#annotated-cell-3-34" aria-hidden="true" tabindex="-1"></a>    <span class="cf">except</span> openai.AuthenticationError <span class="im">as</span> e:</span>
<span id="annotated-cell-3-35"><a href="#annotated-cell-3-35" aria-hidden="true" tabindex="-1"></a>        <span class="cf">raise</span> <span class="pp">ValueError</span>(<span class="ss">f"Is your API key valid?:</span><span class="ch">\n</span><span class="ss"> </span><span class="sc">{</span>e<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="annotated-cell-3-36"><a href="#annotated-cell-3-36" aria-hidden="true" tabindex="-1"></a></span>
<span id="annotated-cell-3-37"><a href="#annotated-cell-3-37" aria-hidden="true" tabindex="-1"></a></span>
<span id="annotated-cell-3-38"><a href="#annotated-cell-3-38" aria-hidden="true" tabindex="-1"></a></span>
<span id="annotated-cell-3-39"><a href="#annotated-cell-3-39" aria-hidden="true" tabindex="-1"></a>model_response <span class="op">=</span> query_openai(</span>
<span id="annotated-cell-3-40"><a href="#annotated-cell-3-40" aria-hidden="true" tabindex="-1"></a>  prompt<span class="op">=</span><span class="st">"What is the capital of the moon?"</span>, api_key<span class="op">=</span>API_KEY</span>
<span id="annotated-cell-3-41"><a href="#annotated-cell-3-41" aria-hidden="true" tabindex="-1"></a>  )</span><div class="code-annotation-gutter-bg"></div><div class="code-annotation-gutter"></div></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<dl class="code-annotation-container-hidden code-annotation-container-grid">
<dt data-target-cell="annotated-cell-3" data-target-annotation="1">1</dt>
<dd>
<span data-code-cell="annotated-cell-3" data-code-lines="4" data-code-annotation="1">Insert your API key into the API_KEY variable. Note - it’s not advisable to include your secret credentials in your python scripts like this, but for simplicity’s sake, I’m showing that here. I’d advise storing them in a git-ignored secrets file or using the <code>python-dotenv</code> package to handle keeping them safe. Take care not to accidentally commit these credentials and expose them on GitHub.</span>
</dd>
<dt data-target-cell="annotated-cell-3" data-target-annotation="2">2</dt>
<dd>
<span data-code-cell="annotated-cell-3" data-code-lines="23" data-code-annotation="2">Create a new OpenAI client with the api_key.</span>
</dd>
<dt data-target-cell="annotated-cell-3" data-target-annotation="3">3</dt>
<dd>
<span data-code-cell="annotated-cell-3" data-code-lines="25" data-code-annotation="3">This will only pass if the key provided is valid.</span>
</dd>
<dt data-target-cell="annotated-cell-3" data-target-annotation="4">4</dt>
<dd>
<span data-code-cell="annotated-cell-3" data-code-lines="28,29,30" data-code-annotation="4">Note the format of the messages - a list of dictionaries. The value for role can be “user”, “system” or “assistant”.</span>
</dd>
</dl>
<p>The model responds with:</p>
<blockquote class="blockquote">
<p>The moon does not have a capital as it is not a sovereign nation or political entity.</p>
</blockquote>
<p>Let’s summarise the process with a diagram:</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="https://i.imgur.com/t15T2J3.png" class="img-fluid figure-img"></p>
<figcaption>Process diagram for iteration 1</figcaption>
</figure>
</div>
<p>So far we have a basic <code>query_openai()</code> function that we can feed in a prompt and our api key. We then receive a response back from the openai model with the expected content.</p>
<p>Although this is an extremely simple process, it’s great to start off with the fundamentals. Understanding the structure of what’s being sent and received is useful when we begin embedding this logic into our Shiny app.</p>
</div>
<div id="tabset-1-2" class="tab-pane" role="tabpanel" aria-labelledby="tabset-1-2-tab">
<p>In this iteration, we are going to introduce a system message to help guide the behaviour of the model - we will want it to act as the guide on an adventure. We’ll also need it to follow a few rules such as how to indicate the game is over.</p>
<div class="code-with-filename">
<div class="code-with-filename-file">
<pre><strong>app.py</strong></pre>
</div>
<div class="sourceCode" id="annotated-cell-4" data-filename="app.py"><pre class="sourceCode python code-annotation-code code-with-copy code-annotated"><code class="sourceCode python"><span id="annotated-cell-4-1"><a href="#annotated-cell-4-1" aria-hidden="true" tabindex="-1"></a><span class="co">"""Iteration 2: Add system &amp; welcome prompts."""</span></span>
<span id="annotated-cell-4-2"><a href="#annotated-cell-4-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> openai</span>
<span id="annotated-cell-4-3"><a href="#annotated-cell-4-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="annotated-cell-4-4"><a href="#annotated-cell-4-4" aria-hidden="true" tabindex="-1"></a>API_KEY <span class="op">=</span> <span class="st">"&lt;INSERT_YOUR_KEY_HERE&gt;"</span></span>
<span id="annotated-cell-4-5"><a href="#annotated-cell-4-5" aria-hidden="true" tabindex="-1"></a>_SYSTEM_MSG <span class="op">=</span> <span class="st">"""</span></span>
<span id="annotated-cell-4-6"><a href="#annotated-cell-4-6" aria-hidden="true" tabindex="-1"></a><span class="st">You are the guide of a 'choose your own adventure'- style game: a mystical</span></span>
<span id="annotated-cell-4-7"><a href="#annotated-cell-4-7" aria-hidden="true" tabindex="-1"></a><span class="st">journey through the Amazon Rainforest. Your job is to create compelling</span></span>
<span id="annotated-cell-4-8"><a href="#annotated-cell-4-8" aria-hidden="true" tabindex="-1"></a><span class="st">outcomes that correspond with the player's choices. You must navigate the</span></span>
<span id="annotated-cell-4-9"><a href="#annotated-cell-4-9" aria-hidden="true" tabindex="-1"></a><span class="st">player through challenges, providing choices, and consequences, dynamically</span></span>
<span id="annotated-cell-4-10"><a href="#annotated-cell-4-10" aria-hidden="true" tabindex="-1"></a><span class="st">adapting the tale based on the player's inputs. Your goal is to create a</span></span>
<span id="annotated-cell-4-11"><a href="#annotated-cell-4-11" aria-hidden="true" tabindex="-1"></a><span class="st">branching narrative experience where each of the player's choices leads to</span></span>
<span id="annotated-cell-4-12"><a href="#annotated-cell-4-12" aria-hidden="true" tabindex="-1"></a><span class="st">a new path, ultimately determining their fate. The player's goal is to find</span></span>
<span id="annotated-cell-4-13"><a href="#annotated-cell-4-13" aria-hidden="true" tabindex="-1"></a><span class="st">the lost crown of Quetzalcoatl.</span></span>
<span id="annotated-cell-4-14"><a href="#annotated-cell-4-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="annotated-cell-4-15"><a href="#annotated-cell-4-15" aria-hidden="true" tabindex="-1"></a><span class="st">Here are some rules to follow:</span></span>
<button class="code-annotation-anchor" data-target-cell="annotated-cell-4" data-target-annotation="1">1</button><span id="annotated-cell-4-16" class="code-annotation-target"><a href="#annotated-cell-4-16" aria-hidden="true" tabindex="-1"></a><span class="st">1. Always wait for the player to respond with their input before providing</span></span>
<span id="annotated-cell-4-17"><a href="#annotated-cell-4-17" aria-hidden="true" tabindex="-1"></a><span class="st">any choices. Never provide the player's input yourself. This is most</span></span>
<span id="annotated-cell-4-18"><a href="#annotated-cell-4-18" aria-hidden="true" tabindex="-1"></a><span class="st">important.</span></span>
<span id="annotated-cell-4-19"><a href="#annotated-cell-4-19" aria-hidden="true" tabindex="-1"></a><span class="st">2. Ask the player to provide a name, gender and race.</span></span>
<span id="annotated-cell-4-20"><a href="#annotated-cell-4-20" aria-hidden="true" tabindex="-1"></a><span class="st">3. Ask the player to choose from a selection of weapons that will be used</span></span>
<span id="annotated-cell-4-21"><a href="#annotated-cell-4-21" aria-hidden="true" tabindex="-1"></a><span class="st">later in the game.</span></span>
<span id="annotated-cell-4-22"><a href="#annotated-cell-4-22" aria-hidden="true" tabindex="-1"></a><span class="st">4. Have a few paths that lead to success. </span></span>
<span id="annotated-cell-4-23"><a href="#annotated-cell-4-23" aria-hidden="true" tabindex="-1"></a><span class="st">5. Have some paths that lead to death.</span></span>
<button class="code-annotation-anchor" data-target-cell="annotated-cell-4" data-target-annotation="2">2</button><span id="annotated-cell-4-24" class="code-annotation-target"><a href="#annotated-cell-4-24" aria-hidden="true" tabindex="-1"></a><span class="st">6. Whether or not the game results in success or death, the response must</span></span>
<span id="annotated-cell-4-25"><a href="#annotated-cell-4-25" aria-hidden="true" tabindex="-1"></a><span class="st">include the text "The End...", I will search for this text to end the game.</span></span>
<span id="annotated-cell-4-26"><a href="#annotated-cell-4-26" aria-hidden="true" tabindex="-1"></a><span class="st">"""</span></span>
<span id="annotated-cell-4-27"><a href="#annotated-cell-4-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="annotated-cell-4-28"><a href="#annotated-cell-4-28" aria-hidden="true" tabindex="-1"></a>WELCOME_MSG <span class="op">=</span> <span class="st">"""</span></span>
<button class="code-annotation-anchor" data-target-cell="annotated-cell-4" data-target-annotation="3">3</button><span id="annotated-cell-4-29" class="code-annotation-target"><a href="#annotated-cell-4-29" aria-hidden="true" tabindex="-1"></a><span class="st">Welcome to the Amazon Rainforest, adventurer! Your mission is to find the</span></span>
<span id="annotated-cell-4-30"><a href="#annotated-cell-4-30" aria-hidden="true" tabindex="-1"></a><span class="st">lost Crown of Quetzalcoatl.</span></span>
<span id="annotated-cell-4-31"><a href="#annotated-cell-4-31" aria-hidden="true" tabindex="-1"></a><span class="st">However, many challenges stand in your way. Are you brave enough, strong</span></span>
<span id="annotated-cell-4-32"><a href="#annotated-cell-4-32" aria-hidden="true" tabindex="-1"></a><span class="st">enough and clever enough to overcome the perils of the jungle and secure</span></span>
<span id="annotated-cell-4-33"><a href="#annotated-cell-4-33" aria-hidden="true" tabindex="-1"></a><span class="st">the crown?</span></span>
<span id="annotated-cell-4-34"><a href="#annotated-cell-4-34" aria-hidden="true" tabindex="-1"></a></span>
<span id="annotated-cell-4-35"><a href="#annotated-cell-4-35" aria-hidden="true" tabindex="-1"></a><span class="st">Before we begin our journey, choose your name, gender and race. Choose a</span></span>
<span id="annotated-cell-4-36"><a href="#annotated-cell-4-36" aria-hidden="true" tabindex="-1"></a><span class="st">weapon to bring with you. Choose wisely, as the way ahead is filled with</span></span>
<span id="annotated-cell-4-37"><a href="#annotated-cell-4-37" aria-hidden="true" tabindex="-1"></a><span class="st">many dangers.</span></span>
<span id="annotated-cell-4-38"><a href="#annotated-cell-4-38" aria-hidden="true" tabindex="-1"></a><span class="st">"""</span></span>
<span id="annotated-cell-4-39"><a href="#annotated-cell-4-39" aria-hidden="true" tabindex="-1"></a></span>
<span id="annotated-cell-4-40"><a href="#annotated-cell-4-40" aria-hidden="true" tabindex="-1"></a></span>
<span id="annotated-cell-4-41"><a href="#annotated-cell-4-41" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> query_openai(</span>
<span id="annotated-cell-4-42"><a href="#annotated-cell-4-42" aria-hidden="true" tabindex="-1"></a>        prompt: <span class="bu">str</span>,</span>
<span id="annotated-cell-4-43"><a href="#annotated-cell-4-43" aria-hidden="true" tabindex="-1"></a>        api_key: <span class="bu">str</span>,</span>
<span id="annotated-cell-4-44"><a href="#annotated-cell-4-44" aria-hidden="true" tabindex="-1"></a>        sys_prompt:<span class="bu">str</span> <span class="op">=</span> _SYSTEM_MSG,</span>
<span id="annotated-cell-4-45"><a href="#annotated-cell-4-45" aria-hidden="true" tabindex="-1"></a>        start_prompt:<span class="bu">str</span> <span class="op">=</span> WELCOME_MSG,</span>
<span id="annotated-cell-4-46"><a href="#annotated-cell-4-46" aria-hidden="true" tabindex="-1"></a>        ) <span class="op">-&gt;</span> <span class="bu">str</span>:</span>
<span id="annotated-cell-4-47"><a href="#annotated-cell-4-47" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""Query the chat completions endpoint.</span></span>
<span id="annotated-cell-4-48"><a href="#annotated-cell-4-48" aria-hidden="true" tabindex="-1"></a></span>
<span id="annotated-cell-4-49"><a href="#annotated-cell-4-49" aria-hidden="true" tabindex="-1"></a><span class="co">    Parameters</span></span>
<span id="annotated-cell-4-50"><a href="#annotated-cell-4-50" aria-hidden="true" tabindex="-1"></a><span class="co">    ----------</span></span>
<span id="annotated-cell-4-51"><a href="#annotated-cell-4-51" aria-hidden="true" tabindex="-1"></a><span class="co">    prompt: str</span></span>
<span id="annotated-cell-4-52"><a href="#annotated-cell-4-52" aria-hidden="true" tabindex="-1"></a><span class="co">        The prompt to query the chat completions endpoint with.</span></span>
<span id="annotated-cell-4-53"><a href="#annotated-cell-4-53" aria-hidden="true" tabindex="-1"></a><span class="co">    api_key: str</span></span>
<span id="annotated-cell-4-54"><a href="#annotated-cell-4-54" aria-hidden="true" tabindex="-1"></a><span class="co">        The API key to use to query the chat completions endpoint.</span></span>
<span id="annotated-cell-4-55"><a href="#annotated-cell-4-55" aria-hidden="true" tabindex="-1"></a><span class="co">    sys_prompt: str</span></span>
<span id="annotated-cell-4-56"><a href="#annotated-cell-4-56" aria-hidden="true" tabindex="-1"></a><span class="co">        The system prompt to help guide the model behaviour. By default,</span></span>
<span id="annotated-cell-4-57"><a href="#annotated-cell-4-57" aria-hidden="true" tabindex="-1"></a><span class="co">        the system prompt is set to _SYSTEM_MSG.</span></span>
<span id="annotated-cell-4-58"><a href="#annotated-cell-4-58" aria-hidden="true" tabindex="-1"></a><span class="co">    start_prompt: str</span></span>
<span id="annotated-cell-4-59"><a href="#annotated-cell-4-59" aria-hidden="true" tabindex="-1"></a><span class="co">        The start prompt which will be presented to the user as the app</span></span>
<span id="annotated-cell-4-60"><a href="#annotated-cell-4-60" aria-hidden="true" tabindex="-1"></a><span class="co">        begins. By default, the start prompt is set to WELCOME_MSG.</span></span>
<span id="annotated-cell-4-61"><a href="#annotated-cell-4-61" aria-hidden="true" tabindex="-1"></a></span>
<span id="annotated-cell-4-62"><a href="#annotated-cell-4-62" aria-hidden="true" tabindex="-1"></a><span class="co">    Returns</span></span>
<span id="annotated-cell-4-63"><a href="#annotated-cell-4-63" aria-hidden="true" tabindex="-1"></a><span class="co">    -------</span></span>
<span id="annotated-cell-4-64"><a href="#annotated-cell-4-64" aria-hidden="true" tabindex="-1"></a><span class="co">    str</span></span>
<span id="annotated-cell-4-65"><a href="#annotated-cell-4-65" aria-hidden="true" tabindex="-1"></a><span class="co">        The response from the chat completions endpoint.</span></span>
<span id="annotated-cell-4-66"><a href="#annotated-cell-4-66" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="annotated-cell-4-67"><a href="#annotated-cell-4-67" aria-hidden="true" tabindex="-1"></a></span>
<span id="annotated-cell-4-68"><a href="#annotated-cell-4-68" aria-hidden="true" tabindex="-1"></a>    client <span class="op">=</span> openai.OpenAI(api_key<span class="op">=</span>api_key)</span>
<span id="annotated-cell-4-69"><a href="#annotated-cell-4-69" aria-hidden="true" tabindex="-1"></a>    <span class="co"># need to handle cases where queries go wrong.</span></span>
<span id="annotated-cell-4-70"><a href="#annotated-cell-4-70" aria-hidden="true" tabindex="-1"></a>    <span class="cf">try</span>:</span>
<span id="annotated-cell-4-71"><a href="#annotated-cell-4-71" aria-hidden="true" tabindex="-1"></a>        response <span class="op">=</span> client.chat.completions.create(</span>
<span id="annotated-cell-4-72"><a href="#annotated-cell-4-72" aria-hidden="true" tabindex="-1"></a>            model<span class="op">=</span><span class="st">"gpt-3.5-turbo"</span>,</span>
<button class="code-annotation-anchor" data-target-cell="annotated-cell-4" data-target-annotation="4">4</button><span id="annotated-cell-4-73" class="code-annotation-target"><a href="#annotated-cell-4-73" aria-hidden="true" tabindex="-1"></a>            messages<span class="op">=</span>[</span>
<span id="annotated-cell-4-74"><a href="#annotated-cell-4-74" aria-hidden="true" tabindex="-1"></a>                {<span class="st">"role"</span>: <span class="st">"system"</span>, <span class="st">"content"</span>: sys_prompt},</span>
<span id="annotated-cell-4-75"><a href="#annotated-cell-4-75" aria-hidden="true" tabindex="-1"></a>                {<span class="st">"role"</span>: <span class="st">"assistant"</span>, <span class="st">"content"</span>: start_prompt},</span>
<span id="annotated-cell-4-76"><a href="#annotated-cell-4-76" aria-hidden="true" tabindex="-1"></a>                {<span class="st">"role"</span>: <span class="st">"user"</span>, <span class="st">"content"</span>: prompt},</span>
<span id="annotated-cell-4-77"><a href="#annotated-cell-4-77" aria-hidden="true" tabindex="-1"></a>            ]</span>
<span id="annotated-cell-4-78"><a href="#annotated-cell-4-78" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="annotated-cell-4-79"><a href="#annotated-cell-4-79" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> response.choices[<span class="dv">0</span>].message.content</span>
<span id="annotated-cell-4-80"><a href="#annotated-cell-4-80" aria-hidden="true" tabindex="-1"></a>    <span class="co"># in cases where the API key is invalid.</span></span>
<span id="annotated-cell-4-81"><a href="#annotated-cell-4-81" aria-hidden="true" tabindex="-1"></a>    <span class="cf">except</span> openai.AuthenticationError <span class="im">as</span> e:</span>
<span id="annotated-cell-4-82"><a href="#annotated-cell-4-82" aria-hidden="true" tabindex="-1"></a>        <span class="cf">raise</span> <span class="pp">ValueError</span>(<span class="ss">f"Is your API key valid?:</span><span class="ch">\n</span><span class="ss"> </span><span class="sc">{</span>e<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="annotated-cell-4-83"><a href="#annotated-cell-4-83" aria-hidden="true" tabindex="-1"></a></span>
<span id="annotated-cell-4-84"><a href="#annotated-cell-4-84" aria-hidden="true" tabindex="-1"></a></span>
<span id="annotated-cell-4-85"><a href="#annotated-cell-4-85" aria-hidden="true" tabindex="-1"></a>model_response <span class="op">=</span> query_openai(</span>
<span id="annotated-cell-4-86"><a href="#annotated-cell-4-86" aria-hidden="true" tabindex="-1"></a>    prompt<span class="op">=</span><span class="st">"What is the capital of the moon?"</span>,</span>
<span id="annotated-cell-4-87"><a href="#annotated-cell-4-87" aria-hidden="true" tabindex="-1"></a>    api_key<span class="op">=</span>API_KEY</span>
<span id="annotated-cell-4-88"><a href="#annotated-cell-4-88" aria-hidden="true" tabindex="-1"></a>    )</span><div class="code-annotation-gutter-bg"></div><div class="code-annotation-gutter"></div></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<dl class="code-annotation-container-hidden code-annotation-container-grid">
<dt data-target-cell="annotated-cell-4" data-target-annotation="1">1</dt>
<dd>
<span data-code-cell="annotated-cell-4" data-code-lines="16,17,18" data-code-annotation="1">Certain models can get a bit over-zealous and start providing imagined user input, ultimately playing the game thorugh to completion on their own. As games go, that’s not that fun, so let’s try to safeguard against that behaviour with these explicit instructions.</span>
</dd>
<dt data-target-cell="annotated-cell-4" data-target-annotation="2">2</dt>
<dd>
<span data-code-cell="annotated-cell-4" data-code-lines="24,25" data-code-annotation="2">The gpt-3.5-turbo model seems to be pretty reliable at ending the game with the required pattern “The end…”. We’ll later search for this pattern to exit the app and return a message indicating game over. Interestingly, I found gpt-4 models to be fairly unreliable in following this instruction. All of the models can be configured to stream their responses too, in which case they rarely gave the specified game over pattern. I’d be interested in others’ opinions as to why this may be the case. Please feel free to leave a comment at the end of the article if you have an opinion.</span>
</dd>
<dt data-target-cell="annotated-cell-4" data-target-annotation="3">3</dt>
<dd>
<span data-code-cell="annotated-cell-4" data-code-lines="29,30,31,32,33,34,35,36,37,38" data-code-annotation="3">This welcome message will be used to introduce the game context for our users when the app launches. We will append this into the message stream and simulate our LLM greeting our user. We will also include this message when querying the model, where it will serve as what’s known as a one-shot prompt to help guide the model’s behaviour. A one-shot prompt is an example of how you’d like the model to behave.</span>
</dd>
<dt data-target-cell="annotated-cell-4" data-target-annotation="4">4</dt>
<dd>
<span data-code-cell="annotated-cell-4" data-code-lines="73,74,75,76,77" data-code-annotation="4">We now update the messages stream with our hard-coded prompt. This helps to guide both the model and the user, setting context and modelling the desired behaviour.</span>
</dd>
</dl>
<p>Thanks to the guidance in the hard-coded prompts, our model now behaves a bit differently:</p>
<blockquote class="blockquote">
<p>I’m afraid the Moon doesn’t have a capital city like countries on Earth do! Let’s focus on our adventure in the Amazon Rainforest. To begin, please choose your name, gender, and race. Additionally, select a weapon to arm yourself with on this mystical journey. The fate of finding the lost Crown of Quetzalcoatl awaits your choices!</p>
</blockquote>
<p>Notice that the model still answers the question, but guides the user back to the purpose of the app. In a later iteration, we will see how to introduce moderations as a safeguard against the user passing inappropriate content.</p>
<p>Finally, updating our process diagram to include the additional prompts, I have emphasised the changes implemented within this iteration. As we proceed, the diagram’s complexity will increase and therefore I’ll try to emphasise the changes implemented over the previous iteration only:</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="https://i.imgur.com/6vuOSp5.png" class="img-fluid figure-img"></p>
<figcaption>Process diagram for iteration 2</figcaption>
</figure>
</div>
</div>
<div id="tabset-1-3" class="tab-pane" role="tabpanel" aria-labelledby="tabset-1-3-tab">
<p>In this iteration, we’ll put together the basic UI for the app. The UI needs a text field to pass the user’s API key and the chat component. Let’s update the app script to include the shiny UI.</p>
<div class="code-with-filename">
<div class="code-with-filename-file">
<pre><strong>app.py</strong></pre>
</div>
<div class="sourceCode" id="annotated-cell-5" data-filename="app.py"><pre class="sourceCode python code-annotation-code code-with-copy code-annotated"><code class="sourceCode python"><span id="annotated-cell-5-1"><a href="#annotated-cell-5-1" aria-hidden="true" tabindex="-1"></a><span class="co">"""Iteration 3: A basic user interface with no server logic."""</span></span>
<span id="annotated-cell-5-2"><a href="#annotated-cell-5-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> openai</span>
<span id="annotated-cell-5-3"><a href="#annotated-cell-5-3" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> shiny <span class="im">import</span> App, ui</span>
<span id="annotated-cell-5-4"><a href="#annotated-cell-5-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="annotated-cell-5-5"><a href="#annotated-cell-5-5" aria-hidden="true" tabindex="-1"></a>_SYSTEM_MSG <span class="op">=</span> <span class="st">"""</span></span>
<span id="annotated-cell-5-6"><a href="#annotated-cell-5-6" aria-hidden="true" tabindex="-1"></a><span class="st">You are the guide of a 'choose your own adventure'- style game: a mystical</span></span>
<span id="annotated-cell-5-7"><a href="#annotated-cell-5-7" aria-hidden="true" tabindex="-1"></a><span class="st">journey through the Amazon Rainforest. Your job is to create compelling</span></span>
<span id="annotated-cell-5-8"><a href="#annotated-cell-5-8" aria-hidden="true" tabindex="-1"></a><span class="st">outcomes that correspond with the player's choices. You must navigate the</span></span>
<span id="annotated-cell-5-9"><a href="#annotated-cell-5-9" aria-hidden="true" tabindex="-1"></a><span class="st">player through challenges, providing choices, and consequences, dynamically</span></span>
<span id="annotated-cell-5-10"><a href="#annotated-cell-5-10" aria-hidden="true" tabindex="-1"></a><span class="st">adapting the tale based on the player's inputs. Your goal is to create a</span></span>
<span id="annotated-cell-5-11"><a href="#annotated-cell-5-11" aria-hidden="true" tabindex="-1"></a><span class="st">branching narrative experience where each of the player's choices leads to</span></span>
<span id="annotated-cell-5-12"><a href="#annotated-cell-5-12" aria-hidden="true" tabindex="-1"></a><span class="st">a new path, ultimately determining their fate. The player's goal is to find</span></span>
<span id="annotated-cell-5-13"><a href="#annotated-cell-5-13" aria-hidden="true" tabindex="-1"></a><span class="st">the lost crown of Quetzalcoatl.</span></span>
<span id="annotated-cell-5-14"><a href="#annotated-cell-5-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="annotated-cell-5-15"><a href="#annotated-cell-5-15" aria-hidden="true" tabindex="-1"></a><span class="st">Here are some rules to follow:</span></span>
<span id="annotated-cell-5-16"><a href="#annotated-cell-5-16" aria-hidden="true" tabindex="-1"></a><span class="st">1. Always wait for the player to respond with their input before providing</span></span>
<span id="annotated-cell-5-17"><a href="#annotated-cell-5-17" aria-hidden="true" tabindex="-1"></a><span class="st">any choices. Never provide the player's input yourself. This is most</span></span>
<span id="annotated-cell-5-18"><a href="#annotated-cell-5-18" aria-hidden="true" tabindex="-1"></a><span class="st">important.</span></span>
<span id="annotated-cell-5-19"><a href="#annotated-cell-5-19" aria-hidden="true" tabindex="-1"></a><span class="st">2. Ask the player to provide a name, gender and race.</span></span>
<span id="annotated-cell-5-20"><a href="#annotated-cell-5-20" aria-hidden="true" tabindex="-1"></a><span class="st">3. Ask the player to choose from a selection of weapons that will be used</span></span>
<span id="annotated-cell-5-21"><a href="#annotated-cell-5-21" aria-hidden="true" tabindex="-1"></a><span class="st">later in the game.</span></span>
<span id="annotated-cell-5-22"><a href="#annotated-cell-5-22" aria-hidden="true" tabindex="-1"></a><span class="st">4. Have a few paths that lead to success. </span></span>
<span id="annotated-cell-5-23"><a href="#annotated-cell-5-23" aria-hidden="true" tabindex="-1"></a><span class="st">5. Have some paths that lead to death.</span></span>
<span id="annotated-cell-5-24"><a href="#annotated-cell-5-24" aria-hidden="true" tabindex="-1"></a><span class="st">6. Whether or not the game results in success or death, the response must</span></span>
<span id="annotated-cell-5-25"><a href="#annotated-cell-5-25" aria-hidden="true" tabindex="-1"></a><span class="st">include the text "The End...", I will search for this text to end the game.</span></span>
<span id="annotated-cell-5-26"><a href="#annotated-cell-5-26" aria-hidden="true" tabindex="-1"></a><span class="st">"""</span></span>
<span id="annotated-cell-5-27"><a href="#annotated-cell-5-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="annotated-cell-5-28"><a href="#annotated-cell-5-28" aria-hidden="true" tabindex="-1"></a>WELCOME_MSG <span class="op">=</span> <span class="st">"""</span></span>
<span id="annotated-cell-5-29"><a href="#annotated-cell-5-29" aria-hidden="true" tabindex="-1"></a><span class="st">Welcome to the Amazon Rainforest, adventurer! Your mission is to find the</span></span>
<span id="annotated-cell-5-30"><a href="#annotated-cell-5-30" aria-hidden="true" tabindex="-1"></a><span class="st">lost Crown of Quetzalcoatl.</span></span>
<span id="annotated-cell-5-31"><a href="#annotated-cell-5-31" aria-hidden="true" tabindex="-1"></a><span class="st">However, many challenges stand in your way. Are you brave enough, strong</span></span>
<span id="annotated-cell-5-32"><a href="#annotated-cell-5-32" aria-hidden="true" tabindex="-1"></a><span class="st">enough and clever enough to overcome the perils of the jungle and secure</span></span>
<span id="annotated-cell-5-33"><a href="#annotated-cell-5-33" aria-hidden="true" tabindex="-1"></a><span class="st">the crown?</span></span>
<span id="annotated-cell-5-34"><a href="#annotated-cell-5-34" aria-hidden="true" tabindex="-1"></a></span>
<span id="annotated-cell-5-35"><a href="#annotated-cell-5-35" aria-hidden="true" tabindex="-1"></a><span class="st">Before we begin our journey, choose your name, gender and race. Choose a</span></span>
<span id="annotated-cell-5-36"><a href="#annotated-cell-5-36" aria-hidden="true" tabindex="-1"></a><span class="st">weapon to bring with you. Choose wisely, as the way ahead is filled with</span></span>
<span id="annotated-cell-5-37"><a href="#annotated-cell-5-37" aria-hidden="true" tabindex="-1"></a><span class="st">many dangers.</span></span>
<span id="annotated-cell-5-38"><a href="#annotated-cell-5-38" aria-hidden="true" tabindex="-1"></a><span class="st">"""</span></span>
<span id="annotated-cell-5-39"><a href="#annotated-cell-5-39" aria-hidden="true" tabindex="-1"></a></span>
<span id="annotated-cell-5-40"><a href="#annotated-cell-5-40" aria-hidden="true" tabindex="-1"></a></span>
<span id="annotated-cell-5-41"><a href="#annotated-cell-5-41" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> query_openai(</span>
<span id="annotated-cell-5-42"><a href="#annotated-cell-5-42" aria-hidden="true" tabindex="-1"></a>        prompt: <span class="bu">str</span>,</span>
<span id="annotated-cell-5-43"><a href="#annotated-cell-5-43" aria-hidden="true" tabindex="-1"></a>        api_key: <span class="bu">str</span>,</span>
<span id="annotated-cell-5-44"><a href="#annotated-cell-5-44" aria-hidden="true" tabindex="-1"></a>        sys_prompt:<span class="bu">str</span> <span class="op">=</span> _SYSTEM_MSG,</span>
<span id="annotated-cell-5-45"><a href="#annotated-cell-5-45" aria-hidden="true" tabindex="-1"></a>        start_prompt:<span class="bu">str</span> <span class="op">=</span> WELCOME_MSG,</span>
<span id="annotated-cell-5-46"><a href="#annotated-cell-5-46" aria-hidden="true" tabindex="-1"></a>        ) <span class="op">-&gt;</span> <span class="bu">str</span>:</span>
<span id="annotated-cell-5-47"><a href="#annotated-cell-5-47" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""Query the chat completions endpoint.</span></span>
<span id="annotated-cell-5-48"><a href="#annotated-cell-5-48" aria-hidden="true" tabindex="-1"></a></span>
<span id="annotated-cell-5-49"><a href="#annotated-cell-5-49" aria-hidden="true" tabindex="-1"></a><span class="co">    Parameters</span></span>
<span id="annotated-cell-5-50"><a href="#annotated-cell-5-50" aria-hidden="true" tabindex="-1"></a><span class="co">    ----------</span></span>
<span id="annotated-cell-5-51"><a href="#annotated-cell-5-51" aria-hidden="true" tabindex="-1"></a><span class="co">    prompt: str</span></span>
<span id="annotated-cell-5-52"><a href="#annotated-cell-5-52" aria-hidden="true" tabindex="-1"></a><span class="co">        The prompt to query the chat completions endpoint with.</span></span>
<span id="annotated-cell-5-53"><a href="#annotated-cell-5-53" aria-hidden="true" tabindex="-1"></a><span class="co">    api_key: str</span></span>
<span id="annotated-cell-5-54"><a href="#annotated-cell-5-54" aria-hidden="true" tabindex="-1"></a><span class="co">        The API key to use to query the chat completions endpoint.</span></span>
<span id="annotated-cell-5-55"><a href="#annotated-cell-5-55" aria-hidden="true" tabindex="-1"></a><span class="co">    sys_prompt: str</span></span>
<span id="annotated-cell-5-56"><a href="#annotated-cell-5-56" aria-hidden="true" tabindex="-1"></a><span class="co">        The system prompt to help guide the model behaviour. By default,</span></span>
<span id="annotated-cell-5-57"><a href="#annotated-cell-5-57" aria-hidden="true" tabindex="-1"></a><span class="co">        the system prompt is set to _SYSTEM_MSG.</span></span>
<span id="annotated-cell-5-58"><a href="#annotated-cell-5-58" aria-hidden="true" tabindex="-1"></a><span class="co">    start_prompt: str</span></span>
<span id="annotated-cell-5-59"><a href="#annotated-cell-5-59" aria-hidden="true" tabindex="-1"></a><span class="co">        The start prompt which will be presented to the user as the app</span></span>
<span id="annotated-cell-5-60"><a href="#annotated-cell-5-60" aria-hidden="true" tabindex="-1"></a><span class="co">        begins. By default, the start prompt is set to WELCOME_MSG.</span></span>
<span id="annotated-cell-5-61"><a href="#annotated-cell-5-61" aria-hidden="true" tabindex="-1"></a></span>
<span id="annotated-cell-5-62"><a href="#annotated-cell-5-62" aria-hidden="true" tabindex="-1"></a><span class="co">    Returns</span></span>
<span id="annotated-cell-5-63"><a href="#annotated-cell-5-63" aria-hidden="true" tabindex="-1"></a><span class="co">    -------</span></span>
<span id="annotated-cell-5-64"><a href="#annotated-cell-5-64" aria-hidden="true" tabindex="-1"></a><span class="co">    str</span></span>
<span id="annotated-cell-5-65"><a href="#annotated-cell-5-65" aria-hidden="true" tabindex="-1"></a><span class="co">        The response from the chat completions endpoint.</span></span>
<span id="annotated-cell-5-66"><a href="#annotated-cell-5-66" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="annotated-cell-5-67"><a href="#annotated-cell-5-67" aria-hidden="true" tabindex="-1"></a></span>
<span id="annotated-cell-5-68"><a href="#annotated-cell-5-68" aria-hidden="true" tabindex="-1"></a>    client <span class="op">=</span> openai.OpenAI(api_key<span class="op">=</span>api_key)</span>
<span id="annotated-cell-5-69"><a href="#annotated-cell-5-69" aria-hidden="true" tabindex="-1"></a>    <span class="co"># need to handle cases where queries go wrong.</span></span>
<span id="annotated-cell-5-70"><a href="#annotated-cell-5-70" aria-hidden="true" tabindex="-1"></a>    <span class="cf">try</span>:</span>
<span id="annotated-cell-5-71"><a href="#annotated-cell-5-71" aria-hidden="true" tabindex="-1"></a>        response <span class="op">=</span> client.chat.completions.create(</span>
<span id="annotated-cell-5-72"><a href="#annotated-cell-5-72" aria-hidden="true" tabindex="-1"></a>            model<span class="op">=</span><span class="st">"gpt-3.5-turbo"</span>,</span>
<span id="annotated-cell-5-73"><a href="#annotated-cell-5-73" aria-hidden="true" tabindex="-1"></a>            messages<span class="op">=</span>[</span>
<span id="annotated-cell-5-74"><a href="#annotated-cell-5-74" aria-hidden="true" tabindex="-1"></a>                {<span class="st">"role"</span>: <span class="st">"system"</span>, <span class="st">"content"</span>: sys_prompt},</span>
<span id="annotated-cell-5-75"><a href="#annotated-cell-5-75" aria-hidden="true" tabindex="-1"></a>                {<span class="st">"role"</span>: <span class="st">"assistant"</span>, <span class="st">"content"</span>: start_prompt},</span>
<span id="annotated-cell-5-76"><a href="#annotated-cell-5-76" aria-hidden="true" tabindex="-1"></a>                {<span class="st">"role"</span>: <span class="st">"user"</span>, <span class="st">"content"</span>: prompt},</span>
<span id="annotated-cell-5-77"><a href="#annotated-cell-5-77" aria-hidden="true" tabindex="-1"></a>            ]</span>
<span id="annotated-cell-5-78"><a href="#annotated-cell-5-78" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="annotated-cell-5-79"><a href="#annotated-cell-5-79" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> response.choices[<span class="dv">0</span>].message.content</span>
<span id="annotated-cell-5-80"><a href="#annotated-cell-5-80" aria-hidden="true" tabindex="-1"></a>    <span class="co"># in cases where the API key is invalid.</span></span>
<span id="annotated-cell-5-81"><a href="#annotated-cell-5-81" aria-hidden="true" tabindex="-1"></a>    <span class="cf">except</span> openai.AuthenticationError <span class="im">as</span> e:</span>
<span id="annotated-cell-5-82"><a href="#annotated-cell-5-82" aria-hidden="true" tabindex="-1"></a>        <span class="cf">raise</span> <span class="pp">ValueError</span>(<span class="ss">f"Is your API key valid?:</span><span class="ch">\n</span><span class="ss"> </span><span class="sc">{</span>e<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="annotated-cell-5-83"><a href="#annotated-cell-5-83" aria-hidden="true" tabindex="-1"></a></span>
<span id="annotated-cell-5-84"><a href="#annotated-cell-5-84" aria-hidden="true" tabindex="-1"></a></span>
<span id="annotated-cell-5-85"><a href="#annotated-cell-5-85" aria-hidden="true" tabindex="-1"></a><span class="co"># Shiny User Interface ----------------------------------------------------</span></span>
<span id="annotated-cell-5-86"><a href="#annotated-cell-5-86" aria-hidden="true" tabindex="-1"></a></span>
<button class="code-annotation-anchor" data-target-cell="annotated-cell-5" data-target-annotation="1">1</button><span id="annotated-cell-5-87" class="code-annotation-target"><a href="#annotated-cell-5-87" aria-hidden="true" tabindex="-1"></a>app_ui <span class="op">=</span> ui.page_fillable(</span>
<span id="annotated-cell-5-88"><a href="#annotated-cell-5-88" aria-hidden="true" tabindex="-1"></a>    ui.panel_title(<span class="st">"Choose Your Own Adventure: Jungle Quest!"</span>),</span>
<button class="code-annotation-anchor" data-target-cell="annotated-cell-5" data-target-annotation="2">2</button><span id="annotated-cell-5-89" class="code-annotation-target"><a href="#annotated-cell-5-89" aria-hidden="true" tabindex="-1"></a>    ui.accordion(</span>
<span id="annotated-cell-5-90"><a href="#annotated-cell-5-90" aria-hidden="true" tabindex="-1"></a>    ui.accordion_panel(<span class="st">"Step 1: Your OpenAI API Key"</span>,</span>
<button class="code-annotation-anchor" data-target-cell="annotated-cell-5" data-target-annotation="3">3</button><span id="annotated-cell-5-91" class="code-annotation-target"><a href="#annotated-cell-5-91" aria-hidden="true" tabindex="-1"></a>        ui.input_text(<span class="bu">id</span><span class="op">=</span><span class="st">"key_input"</span>, label<span class="op">=</span><span class="st">"Enter your openai api key"</span>),</span>
<span id="annotated-cell-5-92"><a href="#annotated-cell-5-92" aria-hidden="true" tabindex="-1"></a>    ), <span class="bu">id</span><span class="op">=</span><span class="st">"acc"</span>, multiple<span class="op">=</span><span class="va">False</span>),</span>
<span id="annotated-cell-5-93"><a href="#annotated-cell-5-93" aria-hidden="true" tabindex="-1"></a>    ui.chat_ui(<span class="bu">id</span><span class="op">=</span><span class="st">"chat"</span>),                                                  </span>
<span id="annotated-cell-5-94"><a href="#annotated-cell-5-94" aria-hidden="true" tabindex="-1"></a>    fillable_mobile<span class="op">=</span><span class="va">True</span>,</span>
<span id="annotated-cell-5-95"><a href="#annotated-cell-5-95" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="annotated-cell-5-96"><a href="#annotated-cell-5-96" aria-hidden="true" tabindex="-1"></a></span>
<button class="code-annotation-anchor" data-target-cell="annotated-cell-5" data-target-annotation="4">4</button><span id="annotated-cell-5-97" class="code-annotation-target"><a href="#annotated-cell-5-97" aria-hidden="true" tabindex="-1"></a>app <span class="op">=</span> App(app_ui, server<span class="op">=</span><span class="va">None</span>)</span><div class="code-annotation-gutter-bg"></div><div class="code-annotation-gutter"></div></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<dl class="code-annotation-container-hidden code-annotation-container-grid">
<dt data-target-cell="annotated-cell-5" data-target-annotation="1">1</dt>
<dd>
<span data-code-cell="annotated-cell-5" data-code-lines="87" data-code-annotation="1"><code>ui.page_fillable()</code> Works well with a chat component, increasing the height of your app to accommodate a growing chat log.</span>
</dd>
<dt data-target-cell="annotated-cell-5" data-target-annotation="2">2</dt>
<dd>
<span data-code-cell="annotated-cell-5" data-code-lines="89" data-code-annotation="2">The <code>ui.accordion()</code> component will present a collapsible panel. This will be useful for the key input panel - we can minimise this portion of our app and focus on the chat.</span>
</dd>
<dt data-target-cell="annotated-cell-5" data-target-annotation="3">3</dt>
<dd>
<span data-code-cell="annotated-cell-5" data-code-lines="91" data-code-annotation="3">In <code>shiny</code> UI elements, the first argument is usually the <code>id</code>. If you know CSS and HTML, then it’s the same <code>id</code> you’d target for styling an element. It’s really important in <code>shiny</code> as the server logic we’ll write later will communicate data to the UI via these <code>id</code> values. Make sure the <code>id</code> values are unique and do not include hyphens - use underscores instead. Shiny will raise the following error if you attempt to use <code>id="row-1"</code> for example: <code>ValueError: The string 'row-1' is not a valid id; only letters, numbers, and underscore are permitted</code></span>
</dd>
<dt data-target-cell="annotated-cell-5" data-target-annotation="4">4</dt>
<dd>
<span data-code-cell="annotated-cell-5" data-code-lines="97" data-code-annotation="4">In this final step, we need to combine our UI with server logic to make things work. As we haven’t written any server logic yet, we can just pass <code>None</code>. This means our UI won’t do anything in its current state.</span>
</dd>
</dl>
<p>Feel free to play around with the code and re-run the app using the play icon in the top-right corner of <code>app.py</code>. This interface uses the <a href="https://shinylive.io/py/examples/" target="_blank">shinylive service</a> which is useful for sharing simple shiny apps without any need for python installations.</p>
<iframe src="https://shinylive.io/py/editor/#code=NobwRAdghgtgpmAXGKAHVA6VBPMAaMAYwHsIAXOcpMAMwCdiYACAZwAsBLCbJjmVYnTJMAgujxMArhwA6EOWlQB9aUwC8UjligBzOEpocANkagAjI3AAUcpnc3aIcI0rIcylm2ADCbYsRY4JgBNYkk6JgB5AHcIUQATADdKMnC4RCYAKUkIHUsmAEVJOBYyAEIZMABKPFt7aQwoQhI6eI5SGzj6rSaWttIlVCgnIy8AZQpUJgBGDNDwqNRKEQBJUQAFNYBpOGxK2q77bowuVEkyVzgADzIrDni1SoBrXaVT8-2mUzNnR7AAUXIcAi2DCEWIS2gHCYaGhLz21QORxqvAelV6nxgkiMblQljUADEoEZAjU6nYGoQ2FALtI7miiNSyJUyYcmIYTOZLEoYMQzMY4GoACp0YoHKpyBTodSidBWRQqDgSQJ0ZJ0NQAOVIcAlEDAAF8ALpAA" class="iframey" style="overflow:hidden;margin:0;padding:0;width:100%;height:30rem">
</iframe>
<p>The process diagram for our app so far looks like this:</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="https://i.imgur.com/ToBp4iQ.png" class="img-fluid figure-img"></p>
<figcaption>Process diagram for iteration 3</figcaption>
</figure>
</div>
<p>Our logic for talking to the OpenAI model has not yet been coupled with our UI. We’ll fold that logic into our shiny server in the next iteration.</p>
</div>
<div id="tabset-1-4" class="tab-pane" role="tabpanel" aria-labelledby="tabset-1-4-tab">
<p>In this part, we’ll take the logic from our <code>query_openai()</code> function defined in iteration 1 and use it to build our shiny server. The shiny server is typically referenced as the “backend” to our app.</p>
<div class="code-with-filename">
<div class="code-with-filename-file">
<pre><strong>app.py</strong></pre>
</div>
<div class="sourceCode" id="annotated-cell-6" data-filename="app.py"><pre class="sourceCode python code-annotation-code code-with-copy code-annotated"><code class="sourceCode python"><span id="annotated-cell-6-1"><a href="#annotated-cell-6-1" aria-hidden="true" tabindex="-1"></a><span class="co">"""Iteration 4: Server logic allows us to create a chat log."""</span></span>
<span id="annotated-cell-6-2"><a href="#annotated-cell-6-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> openai</span>
<span id="annotated-cell-6-3"><a href="#annotated-cell-6-3" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> shiny <span class="im">import</span> App, ui</span>
<span id="annotated-cell-6-4"><a href="#annotated-cell-6-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="annotated-cell-6-5"><a href="#annotated-cell-6-5" aria-hidden="true" tabindex="-1"></a>_SYSTEM_MSG <span class="op">=</span> <span class="st">"""</span></span>
<span id="annotated-cell-6-6"><a href="#annotated-cell-6-6" aria-hidden="true" tabindex="-1"></a><span class="st">You are the guide of a 'choose your own adventure'- style game: a mystical</span></span>
<span id="annotated-cell-6-7"><a href="#annotated-cell-6-7" aria-hidden="true" tabindex="-1"></a><span class="st">journey through the Amazon Rainforest. Your job is to create compelling</span></span>
<span id="annotated-cell-6-8"><a href="#annotated-cell-6-8" aria-hidden="true" tabindex="-1"></a><span class="st">outcomes that correspond with the player's choices. You must navigate the</span></span>
<span id="annotated-cell-6-9"><a href="#annotated-cell-6-9" aria-hidden="true" tabindex="-1"></a><span class="st">player through challenges, providing choices, and consequences, dynamically</span></span>
<span id="annotated-cell-6-10"><a href="#annotated-cell-6-10" aria-hidden="true" tabindex="-1"></a><span class="st">adapting the tale based on the player's inputs. Your goal is to create a</span></span>
<span id="annotated-cell-6-11"><a href="#annotated-cell-6-11" aria-hidden="true" tabindex="-1"></a><span class="st">branching narrative experience where each of the player's choices leads to</span></span>
<span id="annotated-cell-6-12"><a href="#annotated-cell-6-12" aria-hidden="true" tabindex="-1"></a><span class="st">a new path, ultimately determining their fate. The player's goal is to find</span></span>
<span id="annotated-cell-6-13"><a href="#annotated-cell-6-13" aria-hidden="true" tabindex="-1"></a><span class="st">the lost crown of Quetzalcoatl.</span></span>
<span id="annotated-cell-6-14"><a href="#annotated-cell-6-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="annotated-cell-6-15"><a href="#annotated-cell-6-15" aria-hidden="true" tabindex="-1"></a><span class="st">Here are some rules to follow:</span></span>
<span id="annotated-cell-6-16"><a href="#annotated-cell-6-16" aria-hidden="true" tabindex="-1"></a><span class="st">1. Always wait for the player to respond with their input before providing</span></span>
<span id="annotated-cell-6-17"><a href="#annotated-cell-6-17" aria-hidden="true" tabindex="-1"></a><span class="st">any choices. Never provide the player's input yourself. This is most</span></span>
<span id="annotated-cell-6-18"><a href="#annotated-cell-6-18" aria-hidden="true" tabindex="-1"></a><span class="st">important.</span></span>
<span id="annotated-cell-6-19"><a href="#annotated-cell-6-19" aria-hidden="true" tabindex="-1"></a><span class="st">2. Ask the player to provide a name, gender and race.</span></span>
<span id="annotated-cell-6-20"><a href="#annotated-cell-6-20" aria-hidden="true" tabindex="-1"></a><span class="st">3. Ask the player to choose from a selection of weapons that will be used</span></span>
<span id="annotated-cell-6-21"><a href="#annotated-cell-6-21" aria-hidden="true" tabindex="-1"></a><span class="st">later in the game.</span></span>
<span id="annotated-cell-6-22"><a href="#annotated-cell-6-22" aria-hidden="true" tabindex="-1"></a><span class="st">4. Have a few paths that lead to success. </span></span>
<span id="annotated-cell-6-23"><a href="#annotated-cell-6-23" aria-hidden="true" tabindex="-1"></a><span class="st">5. Have some paths that lead to death.</span></span>
<span id="annotated-cell-6-24"><a href="#annotated-cell-6-24" aria-hidden="true" tabindex="-1"></a><span class="st">6. Whether or not the game results in success or death, the response must</span></span>
<span id="annotated-cell-6-25"><a href="#annotated-cell-6-25" aria-hidden="true" tabindex="-1"></a><span class="st">include the text "The End...", I will search for this text to end the game.</span></span>
<span id="annotated-cell-6-26"><a href="#annotated-cell-6-26" aria-hidden="true" tabindex="-1"></a><span class="st">"""</span></span>
<span id="annotated-cell-6-27"><a href="#annotated-cell-6-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="annotated-cell-6-28"><a href="#annotated-cell-6-28" aria-hidden="true" tabindex="-1"></a>WELCOME_MSG <span class="op">=</span> <span class="st">"""</span></span>
<span id="annotated-cell-6-29"><a href="#annotated-cell-6-29" aria-hidden="true" tabindex="-1"></a><span class="st">Welcome to the Amazon Rainforest, adventurer! Your mission is to find the</span></span>
<span id="annotated-cell-6-30"><a href="#annotated-cell-6-30" aria-hidden="true" tabindex="-1"></a><span class="st">lost Crown of Quetzalcoatl.</span></span>
<span id="annotated-cell-6-31"><a href="#annotated-cell-6-31" aria-hidden="true" tabindex="-1"></a><span class="st">However, many challenges stand in your way. Are you brave enough, strong</span></span>
<span id="annotated-cell-6-32"><a href="#annotated-cell-6-32" aria-hidden="true" tabindex="-1"></a><span class="st">enough and clever enough to overcome the perils of the jungle and secure</span></span>
<span id="annotated-cell-6-33"><a href="#annotated-cell-6-33" aria-hidden="true" tabindex="-1"></a><span class="st">the crown?</span></span>
<span id="annotated-cell-6-34"><a href="#annotated-cell-6-34" aria-hidden="true" tabindex="-1"></a></span>
<span id="annotated-cell-6-35"><a href="#annotated-cell-6-35" aria-hidden="true" tabindex="-1"></a><span class="st">Before we begin our journey, choose your name, gender and race. Choose a</span></span>
<span id="annotated-cell-6-36"><a href="#annotated-cell-6-36" aria-hidden="true" tabindex="-1"></a><span class="st">weapon to bring with you. Choose wisely, as the way ahead is filled with</span></span>
<span id="annotated-cell-6-37"><a href="#annotated-cell-6-37" aria-hidden="true" tabindex="-1"></a><span class="st">many dangers.</span></span>
<span id="annotated-cell-6-38"><a href="#annotated-cell-6-38" aria-hidden="true" tabindex="-1"></a><span class="st">"""</span></span>
<span id="annotated-cell-6-39"><a href="#annotated-cell-6-39" aria-hidden="true" tabindex="-1"></a></span>
<span id="annotated-cell-6-40"><a href="#annotated-cell-6-40" aria-hidden="true" tabindex="-1"></a><span class="co"># compose a message stream</span></span>
<span id="annotated-cell-6-41"><a href="#annotated-cell-6-41" aria-hidden="true" tabindex="-1"></a>_SYS <span class="op">=</span> {<span class="st">"role"</span>: <span class="st">"system"</span>, <span class="st">"content"</span>: _SYSTEM_MSG}</span>
<span id="annotated-cell-6-42"><a href="#annotated-cell-6-42" aria-hidden="true" tabindex="-1"></a>_WELCOME <span class="op">=</span> {<span class="st">"role"</span>: <span class="st">"assistant"</span>, <span class="st">"content"</span>: WELCOME_MSG}</span>
<button class="code-annotation-anchor" data-target-cell="annotated-cell-6" data-target-annotation="1">1</button><span id="annotated-cell-6-43" class="code-annotation-target"><a href="#annotated-cell-6-43" aria-hidden="true" tabindex="-1"></a>stream <span class="op">=</span> [_SYS, _WELCOME]</span>
<span id="annotated-cell-6-44"><a href="#annotated-cell-6-44" aria-hidden="true" tabindex="-1"></a></span>
<span id="annotated-cell-6-45"><a href="#annotated-cell-6-45" aria-hidden="true" tabindex="-1"></a><span class="co"># Shiny User Interface ----------------------------------------------------</span></span>
<span id="annotated-cell-6-46"><a href="#annotated-cell-6-46" aria-hidden="true" tabindex="-1"></a></span>
<span id="annotated-cell-6-47"><a href="#annotated-cell-6-47" aria-hidden="true" tabindex="-1"></a>app_ui <span class="op">=</span> ui.page_fillable(</span>
<span id="annotated-cell-6-48"><a href="#annotated-cell-6-48" aria-hidden="true" tabindex="-1"></a>    ui.panel_title(<span class="st">"Choose Your Own Adventure: Jungle Quest!"</span>),</span>
<span id="annotated-cell-6-49"><a href="#annotated-cell-6-49" aria-hidden="true" tabindex="-1"></a>    ui.accordion(</span>
<span id="annotated-cell-6-50"><a href="#annotated-cell-6-50" aria-hidden="true" tabindex="-1"></a>    ui.accordion_panel(<span class="st">"Step 1: Your OpenAI API Key"</span>,</span>
<span id="annotated-cell-6-51"><a href="#annotated-cell-6-51" aria-hidden="true" tabindex="-1"></a>        ui.input_text(<span class="bu">id</span><span class="op">=</span><span class="st">"key_input"</span>, label<span class="op">=</span><span class="st">"Enter your openai api key"</span>),</span>
<span id="annotated-cell-6-52"><a href="#annotated-cell-6-52" aria-hidden="true" tabindex="-1"></a>    ), <span class="bu">id</span><span class="op">=</span><span class="st">"acc"</span>, multiple<span class="op">=</span><span class="va">False</span>),</span>
<span id="annotated-cell-6-53"><a href="#annotated-cell-6-53" aria-hidden="true" tabindex="-1"></a>    ui.chat_ui(<span class="bu">id</span><span class="op">=</span><span class="st">"chat"</span>),</span>
<span id="annotated-cell-6-54"><a href="#annotated-cell-6-54" aria-hidden="true" tabindex="-1"></a>    fillable_mobile<span class="op">=</span><span class="va">True</span>,</span>
<span id="annotated-cell-6-55"><a href="#annotated-cell-6-55" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="annotated-cell-6-56"><a href="#annotated-cell-6-56" aria-hidden="true" tabindex="-1"></a></span>
<span id="annotated-cell-6-57"><a href="#annotated-cell-6-57" aria-hidden="true" tabindex="-1"></a><span class="co"># Shiny server logic ------------------------------------------------------</span></span>
<span id="annotated-cell-6-58"><a href="#annotated-cell-6-58" aria-hidden="true" tabindex="-1"></a></span>
<span id="annotated-cell-6-59"><a href="#annotated-cell-6-59" aria-hidden="true" tabindex="-1"></a></span>
<span id="annotated-cell-6-60"><a href="#annotated-cell-6-60" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> server(<span class="bu">input</span>, output, session):</span>
<button class="code-annotation-anchor" data-target-cell="annotated-cell-6" data-target-annotation="2">2</button><span id="annotated-cell-6-61" class="code-annotation-target"><a href="#annotated-cell-6-61" aria-hidden="true" tabindex="-1"></a>    chat <span class="op">=</span> ui.Chat(</span>
<span id="annotated-cell-6-62"><a href="#annotated-cell-6-62" aria-hidden="true" tabindex="-1"></a>        <span class="bu">id</span><span class="op">=</span><span class="st">"chat"</span>, messages<span class="op">=</span>[ui.markdown(WELCOME_MSG)], tokenizer<span class="op">=</span><span class="va">None</span></span>
<span id="annotated-cell-6-63"><a href="#annotated-cell-6-63" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="annotated-cell-6-64"><a href="#annotated-cell-6-64" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="annotated-cell-6-65"><a href="#annotated-cell-6-65" aria-hidden="true" tabindex="-1"></a></span>
<span id="annotated-cell-6-66"><a href="#annotated-cell-6-66" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Define a callback to run when the user submits a message</span></span>
<span id="annotated-cell-6-67"><a href="#annotated-cell-6-67" aria-hidden="true" tabindex="-1"></a>    <span class="at">@chat.on_user_submit</span></span>
<button class="code-annotation-anchor" data-target-cell="annotated-cell-6" data-target-annotation="3">3</button><span id="annotated-cell-6-68" class="code-annotation-target"><a href="#annotated-cell-6-68" aria-hidden="true" tabindex="-1"></a>    <span class="cf">async</span> <span class="kw">def</span> respond():</span>
<span id="annotated-cell-6-69"><a href="#annotated-cell-6-69" aria-hidden="true" tabindex="-1"></a>        <span class="co">"""Respond to the user's message."""</span></span>
<span id="annotated-cell-6-70"><a href="#annotated-cell-6-70" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Get the user's input</span></span>
<span id="annotated-cell-6-71"><a href="#annotated-cell-6-71" aria-hidden="true" tabindex="-1"></a>        user <span class="op">=</span> chat.user_input()</span>
<span id="annotated-cell-6-72"><a href="#annotated-cell-6-72" aria-hidden="true" tabindex="-1"></a>        <span class="co">#  update the stream list</span></span>
<span id="annotated-cell-6-73"><a href="#annotated-cell-6-73" aria-hidden="true" tabindex="-1"></a>        stream.append({<span class="st">"role"</span>: <span class="st">"user"</span>, <span class="st">"content"</span>: user})</span>
<span id="annotated-cell-6-74"><a href="#annotated-cell-6-74" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Append a response to the chat</span></span>
<button class="code-annotation-anchor" data-target-cell="annotated-cell-6" data-target-annotation="4">4</button><span id="annotated-cell-6-75" class="code-annotation-target"><a href="#annotated-cell-6-75" aria-hidden="true" tabindex="-1"></a>        client <span class="op">=</span> openai.AsyncOpenAI(api_key<span class="op">=</span><span class="bu">input</span>.key_input())</span>
<button class="code-annotation-anchor" data-target-cell="annotated-cell-6" data-target-annotation="5">5</button><span id="annotated-cell-6-76" class="code-annotation-target"><a href="#annotated-cell-6-76" aria-hidden="true" tabindex="-1"></a>        response <span class="op">=</span> <span class="cf">await</span> client.chat.completions.create(</span>
<span id="annotated-cell-6-77"><a href="#annotated-cell-6-77" aria-hidden="true" tabindex="-1"></a>            model<span class="op">=</span><span class="st">"gpt-3.5-turbo"</span>,</span>
<span id="annotated-cell-6-78"><a href="#annotated-cell-6-78" aria-hidden="true" tabindex="-1"></a>            messages<span class="op">=</span>stream,</span>
<span id="annotated-cell-6-79"><a href="#annotated-cell-6-79" aria-hidden="true" tabindex="-1"></a>            temperature<span class="op">=</span><span class="fl">0.7</span>, <span class="co"># increase to make the model more creative</span></span>
<span id="annotated-cell-6-80"><a href="#annotated-cell-6-80" aria-hidden="true" tabindex="-1"></a>            )</span>
<span id="annotated-cell-6-81"><a href="#annotated-cell-6-81" aria-hidden="true" tabindex="-1"></a>        model_response <span class="op">=</span> response.choices[<span class="dv">0</span>].message.content</span>
<span id="annotated-cell-6-82"><a href="#annotated-cell-6-82" aria-hidden="true" tabindex="-1"></a>        <span class="cf">await</span> chat.append_message(model_response)</span>
<span id="annotated-cell-6-83"><a href="#annotated-cell-6-83" aria-hidden="true" tabindex="-1"></a>        <span class="co">#  if the model indicates game over, end the game with a message.</span></span>
<button class="code-annotation-anchor" data-target-cell="annotated-cell-6" data-target-annotation="6">6</button><span id="annotated-cell-6-84" class="code-annotation-target"><a href="#annotated-cell-6-84" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="st">"the end..."</span> <span class="kw">in</span> model_response.lower():</span>
<span id="annotated-cell-6-85"><a href="#annotated-cell-6-85" aria-hidden="true" tabindex="-1"></a>            <span class="cf">await</span> chat.append_message(</span>
<span id="annotated-cell-6-86"><a href="#annotated-cell-6-86" aria-hidden="true" tabindex="-1"></a>                {</span>
<span id="annotated-cell-6-87"><a href="#annotated-cell-6-87" aria-hidden="true" tabindex="-1"></a>                    <span class="st">"role"</span>: <span class="st">"assistant"</span>,</span>
<span id="annotated-cell-6-88"><a href="#annotated-cell-6-88" aria-hidden="true" tabindex="-1"></a>                    <span class="st">"content"</span>: <span class="st">"Game Over! Refresh the page to play again."</span></span>
<span id="annotated-cell-6-89"><a href="#annotated-cell-6-89" aria-hidden="true" tabindex="-1"></a>                    })</span>
<span id="annotated-cell-6-90"><a href="#annotated-cell-6-90" aria-hidden="true" tabindex="-1"></a>            exit()</span>
<span id="annotated-cell-6-91"><a href="#annotated-cell-6-91" aria-hidden="true" tabindex="-1"></a>        <span class="cf">else</span>:</span>
<span id="annotated-cell-6-92"><a href="#annotated-cell-6-92" aria-hidden="true" tabindex="-1"></a>            stream.append({<span class="st">"role"</span>: <span class="st">"assistant"</span>, <span class="st">"content"</span>: model_response})</span>
<span id="annotated-cell-6-93"><a href="#annotated-cell-6-93" aria-hidden="true" tabindex="-1"></a></span>
<span id="annotated-cell-6-94"><a href="#annotated-cell-6-94" aria-hidden="true" tabindex="-1"></a></span>
<span id="annotated-cell-6-95"><a href="#annotated-cell-6-95" aria-hidden="true" tabindex="-1"></a>app <span class="op">=</span> App(ui<span class="op">=</span>app_ui, server<span class="op">=</span>server)</span><div class="code-annotation-gutter-bg"></div><div class="code-annotation-gutter"></div></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<dl class="code-annotation-container-hidden code-annotation-container-grid">
<dt data-target-cell="annotated-cell-6" data-target-annotation="1">1</dt>
<dd>
<span data-code-cell="annotated-cell-6" data-code-lines="43,73,92" data-code-annotation="1">To keep a running log of what’s been said, we assign chat messages to a <code>stream</code> list. When the user and model respond, we’ll dump that content as a dictionary at the end of this list.</span>
</dd>
<dt data-target-cell="annotated-cell-6" data-target-annotation="2">2</dt>
<dd>
<span data-code-cell="annotated-cell-6" data-code-lines="61,62,63" data-code-annotation="2">Here we create the backend to our <code>shiny</code> chat interface. It’s vital that it has the same <code>id</code> value as the <code>ui.chat_ui()</code> element defined in our UI in iteration 3. This connection will allow the backend and frontend to communicate when we run the app.</span>
</dd>
<dt data-target-cell="annotated-cell-6" data-target-annotation="3">3</dt>
<dd>
<span data-code-cell="annotated-cell-6" data-code-lines="68" data-code-annotation="3">We use async here because:. It allows the function to perform I/O operations (like API calls) without blocking the entire application. 2. It improves responsiveness, especially when dealing with potentially slow network requests to the OpenAI API. 3. It works well with Shiny’s event-driven architecture, allowing other parts of the app to remain interactive while waiting for the API response.</span>
</dd>
<dt data-target-cell="annotated-cell-6" data-target-annotation="4">4</dt>
<dd>
<span data-code-cell="annotated-cell-6" data-code-lines="75" data-code-annotation="4">We’ve now switched over the the OpenAI Async client. This is better for working with event driven apps like this one. We no longer hard-code an API key. Instead, we’ll take the value from the <code>ui.input_text()</code> field. Notice that we reference the <code>id</code> value that we set when we defined the UI like a method: <code>input.key_input()</code>. This is how <code>shiny</code> apps wire the frontend and backend together.</span>
</dd>
<dt data-target-cell="annotated-cell-6" data-target-annotation="5">5</dt>
<dd>
<span data-code-cell="annotated-cell-6" data-code-lines="76,82" data-code-annotation="5">We need to use <code>await</code> for these parts of our server logic. This is because the model response typically takes some time to arrive and parts of the server would error until they receive it. Typically, anything that would raise an exception rather than returning <code>None</code> you’ll need to <code>await</code>.</span>
</dd>
<dt data-target-cell="annotated-cell-6" data-target-annotation="6">6</dt>
<dd>
<span data-code-cell="annotated-cell-6" data-code-lines="84,85,86,87,88,89,90" data-code-annotation="6">This part of our server is where we end the game. Notice that this is dependent on our model following rule 6 in <code>_SYSTEM_MSG</code>. Not all models are great at following that instruction. At the time of writing this blog, I’ve tested <code>gpt-3.5-turbo</code>, <code>gpt-4o</code> and <code>chatgpt-4o-latest</code>. In my testing I found <code>gpt-3.5-turbo</code> to be the most reliable at following this rule. But when I tested streaming the model responses, no models would end the game as requested. This is definitely the most flaky element of this app and is part of the fun of working with these models.</span>
</dd>
</dl>
<p>Now adding in the server logic for our process diagram, note that I have added a key that illustrates wherever we instantiate an openai client in the app. As we continue to build, handling the client becomes a bit involved so let’s start paying attention to wherever we’re using it:</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="https://i.imgur.com/46mqCrY.png" class="img-fluid figure-img"></p>
<figcaption>Process diagram for iteration 4</figcaption>
</figure>
</div>
<p>You can see that the <code>respond()</code> function has become the busiest unit in the app. It takes the api key value from our UI, combines the users’s messages sent from the chat UI, combines these with the chat stream and communicates with the OpenAI model. Now these components are all wired up we get a running application. If you’ve made it this far - well done!</p>
<p>You can see me interacting with the resultant app in the video below. Note that I cannot use shinylive to host a working version of this iteration as unfortunately the <code>openai</code> package is not available on that service.</p>
<div class="callout callout-style-default callout-important callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Important
</div>
</div>
<div class="callout-body-container callout-body">
<p>I use a real OpenAI API key in these clips to demonstrate the application working. Note that I have since revoked this key and it will no longer work. You should not share your secret keys with anyone.</p>
</div>
</div>
<iframe title="Iteration 4 recording" src="https://player.vimeo.com/video/1010110793?h=133c2b081d" class="iframey" allowfullscreen="" style="overflow:hidden;margin:0;padding:0;width:100%;height:24rem;">
</iframe>
<p>Notice that I attempt to use a nonsense key value and we get a nasty-looking error. Luckily, it’s not a fatal one - the app doesn’t crash. But we should think about handling cases where the key is bad and giving a more accessible notification to the user.</p>
</div>
<div id="tabset-1-5" class="tab-pane" role="tabpanel" aria-labelledby="tabset-1-5-tab">
<p>In this version, we build on our working app to improve the user experience. We’ll add a ‘submit’ button, which the user can use when they’re ready to use their key. We also provide some notifications to the user when they submit their key, but we won’t be checking whether the key is valid until the next iteration.</p>
<div class="code-with-filename">
<div class="code-with-filename-file">
<pre><strong>app.py</strong></pre>
</div>
<div class="sourceCode" id="annotated-cell-7" data-filename="app.py"><pre class="sourceCode python code-annotation-code code-with-copy code-annotated"><code class="sourceCode python"><span id="annotated-cell-7-1"><a href="#annotated-cell-7-1" aria-hidden="true" tabindex="-1"></a><span class="co">"""Iteration 5: Submit button &amp; notifications for the user."""</span></span>
<span id="annotated-cell-7-2"><a href="#annotated-cell-7-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> openai</span>
<span id="annotated-cell-7-3"><a href="#annotated-cell-7-3" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> shiny <span class="im">import</span> App, reactive, ui</span>
<span id="annotated-cell-7-4"><a href="#annotated-cell-7-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="annotated-cell-7-5"><a href="#annotated-cell-7-5" aria-hidden="true" tabindex="-1"></a>_SYSTEM_MSG <span class="op">=</span> <span class="st">"""</span></span>
<span id="annotated-cell-7-6"><a href="#annotated-cell-7-6" aria-hidden="true" tabindex="-1"></a><span class="st">You are the guide of a 'choose your own adventure'- style game: a mystical</span></span>
<span id="annotated-cell-7-7"><a href="#annotated-cell-7-7" aria-hidden="true" tabindex="-1"></a><span class="st">journey through the Amazon Rainforest. Your job is to create compelling</span></span>
<span id="annotated-cell-7-8"><a href="#annotated-cell-7-8" aria-hidden="true" tabindex="-1"></a><span class="st">outcomes that correspond with the player's choices. You must navigate the</span></span>
<span id="annotated-cell-7-9"><a href="#annotated-cell-7-9" aria-hidden="true" tabindex="-1"></a><span class="st">player through challenges, providing choices, and consequences, dynamically</span></span>
<span id="annotated-cell-7-10"><a href="#annotated-cell-7-10" aria-hidden="true" tabindex="-1"></a><span class="st">adapting the tale based on the player's inputs. Your goal is to create a</span></span>
<span id="annotated-cell-7-11"><a href="#annotated-cell-7-11" aria-hidden="true" tabindex="-1"></a><span class="st">branching narrative experience where each of the player's choices leads to</span></span>
<span id="annotated-cell-7-12"><a href="#annotated-cell-7-12" aria-hidden="true" tabindex="-1"></a><span class="st">a new path, ultimately determining their fate. The player's goal is to find</span></span>
<span id="annotated-cell-7-13"><a href="#annotated-cell-7-13" aria-hidden="true" tabindex="-1"></a><span class="st">the lost crown of Quetzalcoatl.</span></span>
<span id="annotated-cell-7-14"><a href="#annotated-cell-7-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="annotated-cell-7-15"><a href="#annotated-cell-7-15" aria-hidden="true" tabindex="-1"></a><span class="st">Here are some rules to follow:</span></span>
<span id="annotated-cell-7-16"><a href="#annotated-cell-7-16" aria-hidden="true" tabindex="-1"></a><span class="st">1. Always wait for the player to respond with their input before providing</span></span>
<span id="annotated-cell-7-17"><a href="#annotated-cell-7-17" aria-hidden="true" tabindex="-1"></a><span class="st">any choices. Never provide the player's input yourself. This is most</span></span>
<span id="annotated-cell-7-18"><a href="#annotated-cell-7-18" aria-hidden="true" tabindex="-1"></a><span class="st">important.</span></span>
<span id="annotated-cell-7-19"><a href="#annotated-cell-7-19" aria-hidden="true" tabindex="-1"></a><span class="st">2. Ask the player to provide a name, gender and race.</span></span>
<span id="annotated-cell-7-20"><a href="#annotated-cell-7-20" aria-hidden="true" tabindex="-1"></a><span class="st">3. Ask the player to choose from a selection of weapons that will be used</span></span>
<span id="annotated-cell-7-21"><a href="#annotated-cell-7-21" aria-hidden="true" tabindex="-1"></a><span class="st">later in the game.</span></span>
<span id="annotated-cell-7-22"><a href="#annotated-cell-7-22" aria-hidden="true" tabindex="-1"></a><span class="st">4. Have a few paths that lead to success. </span></span>
<span id="annotated-cell-7-23"><a href="#annotated-cell-7-23" aria-hidden="true" tabindex="-1"></a><span class="st">5. Have some paths that lead to death.</span></span>
<span id="annotated-cell-7-24"><a href="#annotated-cell-7-24" aria-hidden="true" tabindex="-1"></a><span class="st">6. Whether or not the game results in success or death, the response must</span></span>
<span id="annotated-cell-7-25"><a href="#annotated-cell-7-25" aria-hidden="true" tabindex="-1"></a><span class="st">include the text "The End...", I will search for this text to end the game.</span></span>
<span id="annotated-cell-7-26"><a href="#annotated-cell-7-26" aria-hidden="true" tabindex="-1"></a><span class="st">"""</span></span>
<span id="annotated-cell-7-27"><a href="#annotated-cell-7-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="annotated-cell-7-28"><a href="#annotated-cell-7-28" aria-hidden="true" tabindex="-1"></a>WELCOME_MSG <span class="op">=</span> <span class="st">"""</span></span>
<span id="annotated-cell-7-29"><a href="#annotated-cell-7-29" aria-hidden="true" tabindex="-1"></a><span class="st">Welcome to the Amazon Rainforest, adventurer! Your mission is to find the</span></span>
<span id="annotated-cell-7-30"><a href="#annotated-cell-7-30" aria-hidden="true" tabindex="-1"></a><span class="st">lost Crown of Quetzalcoatl.</span></span>
<span id="annotated-cell-7-31"><a href="#annotated-cell-7-31" aria-hidden="true" tabindex="-1"></a><span class="st">However, many challenges stand in your way. Are you brave enough, strong</span></span>
<span id="annotated-cell-7-32"><a href="#annotated-cell-7-32" aria-hidden="true" tabindex="-1"></a><span class="st">enough and clever enough to overcome the perils of the jungle and secure</span></span>
<span id="annotated-cell-7-33"><a href="#annotated-cell-7-33" aria-hidden="true" tabindex="-1"></a><span class="st">the crown?</span></span>
<span id="annotated-cell-7-34"><a href="#annotated-cell-7-34" aria-hidden="true" tabindex="-1"></a></span>
<span id="annotated-cell-7-35"><a href="#annotated-cell-7-35" aria-hidden="true" tabindex="-1"></a><span class="st">Before we begin our journey, choose your name, gender and race. Choose a</span></span>
<span id="annotated-cell-7-36"><a href="#annotated-cell-7-36" aria-hidden="true" tabindex="-1"></a><span class="st">weapon to bring with you. Choose wisely, as the way ahead is filled with</span></span>
<span id="annotated-cell-7-37"><a href="#annotated-cell-7-37" aria-hidden="true" tabindex="-1"></a><span class="st">many dangers.</span></span>
<span id="annotated-cell-7-38"><a href="#annotated-cell-7-38" aria-hidden="true" tabindex="-1"></a><span class="st">"""</span></span>
<span id="annotated-cell-7-39"><a href="#annotated-cell-7-39" aria-hidden="true" tabindex="-1"></a></span>
<span id="annotated-cell-7-40"><a href="#annotated-cell-7-40" aria-hidden="true" tabindex="-1"></a><span class="co"># compose a message stream</span></span>
<span id="annotated-cell-7-41"><a href="#annotated-cell-7-41" aria-hidden="true" tabindex="-1"></a>_SYS <span class="op">=</span> {<span class="st">"role"</span>: <span class="st">"system"</span>, <span class="st">"content"</span>: _SYSTEM_MSG}</span>
<span id="annotated-cell-7-42"><a href="#annotated-cell-7-42" aria-hidden="true" tabindex="-1"></a>_WELCOME <span class="op">=</span> {<span class="st">"role"</span>: <span class="st">"assistant"</span>, <span class="st">"content"</span>: WELCOME_MSG}</span>
<span id="annotated-cell-7-43"><a href="#annotated-cell-7-43" aria-hidden="true" tabindex="-1"></a>stream <span class="op">=</span> [_SYS, _WELCOME]</span>
<span id="annotated-cell-7-44"><a href="#annotated-cell-7-44" aria-hidden="true" tabindex="-1"></a></span>
<span id="annotated-cell-7-45"><a href="#annotated-cell-7-45" aria-hidden="true" tabindex="-1"></a><span class="co"># Shiny User Interface ----------------------------------------------------</span></span>
<span id="annotated-cell-7-46"><a href="#annotated-cell-7-46" aria-hidden="true" tabindex="-1"></a></span>
<span id="annotated-cell-7-47"><a href="#annotated-cell-7-47" aria-hidden="true" tabindex="-1"></a></span>
<button class="code-annotation-anchor" data-target-cell="annotated-cell-7" data-target-annotation="1">1</button><span id="annotated-cell-7-48" class="code-annotation-target"><a href="#annotated-cell-7-48" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> input_text_with_button(<span class="bu">id</span>, label, button_label, placeholder<span class="op">=</span><span class="st">""</span>):</span>
<span id="annotated-cell-7-49"><a href="#annotated-cell-7-49" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="annotated-cell-7-50"><a href="#annotated-cell-7-50" aria-hidden="true" tabindex="-1"></a><span class="co">    An interface component combining an input text widget with an action</span></span>
<span id="annotated-cell-7-51"><a href="#annotated-cell-7-51" aria-hidden="true" tabindex="-1"></a><span class="co">    button. IDs for the text field and button can be accessed as &lt;id&gt;_text</span></span>
<span id="annotated-cell-7-52"><a href="#annotated-cell-7-52" aria-hidden="true" tabindex="-1"></a><span class="co">    and &lt;id&gt;_btn respectively.</span></span>
<span id="annotated-cell-7-53"><a href="#annotated-cell-7-53" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="annotated-cell-7-54"><a href="#annotated-cell-7-54" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> ui.div(</span>
<span id="annotated-cell-7-55"><a href="#annotated-cell-7-55" aria-hidden="true" tabindex="-1"></a>        ui.input_text(</span>
<button class="code-annotation-anchor" data-target-cell="annotated-cell-7" data-target-annotation="2">2</button><span id="annotated-cell-7-56" class="code-annotation-target"><a href="#annotated-cell-7-56" aria-hidden="true" tabindex="-1"></a>            <span class="bu">id</span><span class="op">=</span><span class="ss">f"</span><span class="sc">{</span><span class="bu">id</span><span class="sc">}</span><span class="ss">_text"</span>, label<span class="op">=</span>label, placeholder<span class="op">=</span>placeholder),</span>
<span id="annotated-cell-7-57"><a href="#annotated-cell-7-57" aria-hidden="true" tabindex="-1"></a>        ui.input_action_button(</span>
<span id="annotated-cell-7-58"><a href="#annotated-cell-7-58" aria-hidden="true" tabindex="-1"></a>            <span class="bu">id</span><span class="op">=</span><span class="ss">f"</span><span class="sc">{</span><span class="bu">id</span><span class="sc">}</span><span class="ss">_btn"</span>,</span>
<span id="annotated-cell-7-59"><a href="#annotated-cell-7-59" aria-hidden="true" tabindex="-1"></a>            label<span class="op">=</span>button_label,</span>
<button class="code-annotation-anchor" data-target-cell="annotated-cell-7" data-target-annotation="3">3</button><span id="annotated-cell-7-60" class="code-annotation-target"><a href="#annotated-cell-7-60" aria-hidden="true" tabindex="-1"></a>            style<span class="op">=</span><span class="st">"margin-top:28px;margin-bottom:16px;color:#04bb8c;border-color:#04bb8c;"</span></span>
<span id="annotated-cell-7-61"><a href="#annotated-cell-7-61" aria-hidden="true" tabindex="-1"></a>            ),</span>
<span id="annotated-cell-7-62"><a href="#annotated-cell-7-62" aria-hidden="true" tabindex="-1"></a>        class_<span class="op">=</span><span class="st">"d-flex gap-2"</span></span>
<span id="annotated-cell-7-63"><a href="#annotated-cell-7-63" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="annotated-cell-7-64"><a href="#annotated-cell-7-64" aria-hidden="true" tabindex="-1"></a></span>
<span id="annotated-cell-7-65"><a href="#annotated-cell-7-65" aria-hidden="true" tabindex="-1"></a></span>
<span id="annotated-cell-7-66"><a href="#annotated-cell-7-66" aria-hidden="true" tabindex="-1"></a>app_ui <span class="op">=</span> ui.page_fillable(</span>
<span id="annotated-cell-7-67"><a href="#annotated-cell-7-67" aria-hidden="true" tabindex="-1"></a>    ui.panel_title(<span class="st">"Choose Your Own Adventure: Jungle Quest!"</span>),</span>
<span id="annotated-cell-7-68"><a href="#annotated-cell-7-68" aria-hidden="true" tabindex="-1"></a>    ui.accordion(</span>
<span id="annotated-cell-7-69"><a href="#annotated-cell-7-69" aria-hidden="true" tabindex="-1"></a>    ui.accordion_panel(<span class="st">"Step 1: Your OpenAI API Key"</span>,</span>
<button class="code-annotation-anchor" data-target-cell="annotated-cell-7" data-target-annotation="4">4</button><span id="annotated-cell-7-70" class="code-annotation-target"><a href="#annotated-cell-7-70" aria-hidden="true" tabindex="-1"></a>        input_text_with_button(</span>
<span id="annotated-cell-7-71"><a href="#annotated-cell-7-71" aria-hidden="true" tabindex="-1"></a>            <span class="bu">id</span><span class="op">=</span><span class="st">"key_input"</span>,</span>
<span id="annotated-cell-7-72"><a href="#annotated-cell-7-72" aria-hidden="true" tabindex="-1"></a>            label<span class="op">=</span><span class="st">"Enter your OpenAI API key"</span>,</span>
<span id="annotated-cell-7-73"><a href="#annotated-cell-7-73" aria-hidden="true" tabindex="-1"></a>            button_label<span class="op">=</span><span class="st">"Submit"</span>,</span>
<span id="annotated-cell-7-74"><a href="#annotated-cell-7-74" aria-hidden="true" tabindex="-1"></a>            placeholder<span class="op">=</span><span class="st">"Enter key here"</span></span>
<span id="annotated-cell-7-75"><a href="#annotated-cell-7-75" aria-hidden="true" tabindex="-1"></a>            )), <span class="bu">id</span><span class="op">=</span><span class="st">"acc"</span>, multiple<span class="op">=</span><span class="va">False</span>),</span>
<span id="annotated-cell-7-76"><a href="#annotated-cell-7-76" aria-hidden="true" tabindex="-1"></a>ui.h6(<span class="st">"Step 2: Choose your adventure"</span>),</span>
<span id="annotated-cell-7-77"><a href="#annotated-cell-7-77" aria-hidden="true" tabindex="-1"></a>    ui.chat_ui(<span class="bu">id</span><span class="op">=</span><span class="st">"chat"</span>),</span>
<span id="annotated-cell-7-78"><a href="#annotated-cell-7-78" aria-hidden="true" tabindex="-1"></a>    fillable_mobile<span class="op">=</span><span class="va">True</span>,</span>
<span id="annotated-cell-7-79"><a href="#annotated-cell-7-79" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="annotated-cell-7-80"><a href="#annotated-cell-7-80" aria-hidden="true" tabindex="-1"></a></span>
<span id="annotated-cell-7-81"><a href="#annotated-cell-7-81" aria-hidden="true" tabindex="-1"></a><span class="co"># Shiny server logic ------------------------------------------------------</span></span>
<span id="annotated-cell-7-82"><a href="#annotated-cell-7-82" aria-hidden="true" tabindex="-1"></a></span>
<span id="annotated-cell-7-83"><a href="#annotated-cell-7-83" aria-hidden="true" tabindex="-1"></a></span>
<span id="annotated-cell-7-84"><a href="#annotated-cell-7-84" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> server(<span class="bu">input</span>, output, session):</span>
<span id="annotated-cell-7-85"><a href="#annotated-cell-7-85" aria-hidden="true" tabindex="-1"></a>    chat <span class="op">=</span> ui.Chat(</span>
<span id="annotated-cell-7-86"><a href="#annotated-cell-7-86" aria-hidden="true" tabindex="-1"></a>        <span class="bu">id</span><span class="op">=</span><span class="st">"chat"</span>, messages<span class="op">=</span>[ui.markdown(WELCOME_MSG)], tokenizer<span class="op">=</span><span class="va">None</span></span>
<span id="annotated-cell-7-87"><a href="#annotated-cell-7-87" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="annotated-cell-7-88"><a href="#annotated-cell-7-88" aria-hidden="true" tabindex="-1"></a></span>
<span id="annotated-cell-7-89"><a href="#annotated-cell-7-89" aria-hidden="true" tabindex="-1"></a></span>
<button class="code-annotation-anchor" data-target-cell="annotated-cell-7" data-target-annotation="5">5</button><span id="annotated-cell-7-90" class="code-annotation-target"><a href="#annotated-cell-7-90" aria-hidden="true" tabindex="-1"></a>    <span class="at">@reactive.Effect</span></span>
<span id="annotated-cell-7-91"><a href="#annotated-cell-7-91" aria-hidden="true" tabindex="-1"></a>    <span class="at">@reactive.event</span>(<span class="bu">input</span>.key_input_btn)</span>
<span id="annotated-cell-7-92"><a href="#annotated-cell-7-92" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> handle_api_key_submit():</span>
<span id="annotated-cell-7-93"><a href="#annotated-cell-7-93" aria-hidden="true" tabindex="-1"></a>        <span class="co">"""Update the UI with a notification when user submits key."""</span></span>
<span id="annotated-cell-7-94"><a href="#annotated-cell-7-94" aria-hidden="true" tabindex="-1"></a>        api_key <span class="op">=</span> <span class="bu">input</span>.key_input_text()</span>
<span id="annotated-cell-7-95"><a href="#annotated-cell-7-95" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> api_key:</span>
<span id="annotated-cell-7-96"><a href="#annotated-cell-7-96" aria-hidden="true" tabindex="-1"></a>            ui.notification_show(<span class="ss">f"API key submitted: </span><span class="sc">{</span>api_key[:<span class="dv">5</span>]<span class="sc">}</span><span class="ss">..."</span>)</span>
<span id="annotated-cell-7-97"><a href="#annotated-cell-7-97" aria-hidden="true" tabindex="-1"></a>        <span class="cf">else</span>:</span>
<span id="annotated-cell-7-98"><a href="#annotated-cell-7-98" aria-hidden="true" tabindex="-1"></a>            ui.notification_show(<span class="st">"Please enter an API key"</span>, <span class="bu">type</span><span class="op">=</span><span class="st">"warning"</span>)</span>
<span id="annotated-cell-7-99"><a href="#annotated-cell-7-99" aria-hidden="true" tabindex="-1"></a></span>
<span id="annotated-cell-7-100"><a href="#annotated-cell-7-100" aria-hidden="true" tabindex="-1"></a></span>
<span id="annotated-cell-7-101"><a href="#annotated-cell-7-101" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Define a callback to run when the user submits a message</span></span>
<span id="annotated-cell-7-102"><a href="#annotated-cell-7-102" aria-hidden="true" tabindex="-1"></a>    <span class="at">@chat.on_user_submit</span></span>
<span id="annotated-cell-7-103"><a href="#annotated-cell-7-103" aria-hidden="true" tabindex="-1"></a>    <span class="cf">async</span> <span class="kw">def</span> respond():</span>
<span id="annotated-cell-7-104"><a href="#annotated-cell-7-104" aria-hidden="true" tabindex="-1"></a>        <span class="co">"""Respond to the user's message."""</span></span>
<span id="annotated-cell-7-105"><a href="#annotated-cell-7-105" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Get the user's input</span></span>
<span id="annotated-cell-7-106"><a href="#annotated-cell-7-106" aria-hidden="true" tabindex="-1"></a>        user <span class="op">=</span> chat.user_input()</span>
<span id="annotated-cell-7-107"><a href="#annotated-cell-7-107" aria-hidden="true" tabindex="-1"></a>        <span class="co">#  update the stream list</span></span>
<span id="annotated-cell-7-108"><a href="#annotated-cell-7-108" aria-hidden="true" tabindex="-1"></a>        stream.append({<span class="st">"role"</span>: <span class="st">"user"</span>, <span class="st">"content"</span>: user})</span>
<span id="annotated-cell-7-109"><a href="#annotated-cell-7-109" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Append a response to the chat</span></span>
<span id="annotated-cell-7-110"><a href="#annotated-cell-7-110" aria-hidden="true" tabindex="-1"></a>        client <span class="op">=</span> openai.AsyncOpenAI(api_key<span class="op">=</span><span class="bu">input</span>.key_input_text())</span>
<span id="annotated-cell-7-111"><a href="#annotated-cell-7-111" aria-hidden="true" tabindex="-1"></a>        response <span class="op">=</span> <span class="cf">await</span> client.chat.completions.create(</span>
<span id="annotated-cell-7-112"><a href="#annotated-cell-7-112" aria-hidden="true" tabindex="-1"></a>            model<span class="op">=</span><span class="st">"gpt-3.5-turbo"</span>,</span>
<span id="annotated-cell-7-113"><a href="#annotated-cell-7-113" aria-hidden="true" tabindex="-1"></a>            messages<span class="op">=</span>stream,</span>
<span id="annotated-cell-7-114"><a href="#annotated-cell-7-114" aria-hidden="true" tabindex="-1"></a>            temperature<span class="op">=</span><span class="fl">0.7</span>, <span class="co"># increase to make the model more creative</span></span>
<span id="annotated-cell-7-115"><a href="#annotated-cell-7-115" aria-hidden="true" tabindex="-1"></a>            )</span>
<span id="annotated-cell-7-116"><a href="#annotated-cell-7-116" aria-hidden="true" tabindex="-1"></a>        model_response <span class="op">=</span> response.choices[<span class="dv">0</span>].message.content</span>
<span id="annotated-cell-7-117"><a href="#annotated-cell-7-117" aria-hidden="true" tabindex="-1"></a>        <span class="cf">await</span> chat.append_message(model_response)</span>
<span id="annotated-cell-7-118"><a href="#annotated-cell-7-118" aria-hidden="true" tabindex="-1"></a>        <span class="co">#  if the model indicates game over, end the game with a message.</span></span>
<span id="annotated-cell-7-119"><a href="#annotated-cell-7-119" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="st">"the end..."</span> <span class="kw">in</span> model_response.lower():</span>
<span id="annotated-cell-7-120"><a href="#annotated-cell-7-120" aria-hidden="true" tabindex="-1"></a>            <span class="cf">await</span> chat.append_message(</span>
<span id="annotated-cell-7-121"><a href="#annotated-cell-7-121" aria-hidden="true" tabindex="-1"></a>                {</span>
<span id="annotated-cell-7-122"><a href="#annotated-cell-7-122" aria-hidden="true" tabindex="-1"></a>                    <span class="st">"role"</span>: <span class="st">"assistant"</span>,</span>
<span id="annotated-cell-7-123"><a href="#annotated-cell-7-123" aria-hidden="true" tabindex="-1"></a>                    <span class="st">"content"</span>: <span class="st">"Game Over! Refresh the page to play again."</span></span>
<span id="annotated-cell-7-124"><a href="#annotated-cell-7-124" aria-hidden="true" tabindex="-1"></a>                    })</span>
<span id="annotated-cell-7-125"><a href="#annotated-cell-7-125" aria-hidden="true" tabindex="-1"></a>            exit()</span>
<span id="annotated-cell-7-126"><a href="#annotated-cell-7-126" aria-hidden="true" tabindex="-1"></a>        <span class="cf">else</span>:</span>
<span id="annotated-cell-7-127"><a href="#annotated-cell-7-127" aria-hidden="true" tabindex="-1"></a>            stream.append({<span class="st">"role"</span>: <span class="st">"assistant"</span>, <span class="st">"content"</span>: model_response})</span>
<span id="annotated-cell-7-128"><a href="#annotated-cell-7-128" aria-hidden="true" tabindex="-1"></a></span>
<span id="annotated-cell-7-129"><a href="#annotated-cell-7-129" aria-hidden="true" tabindex="-1"></a></span>
<span id="annotated-cell-7-130"><a href="#annotated-cell-7-130" aria-hidden="true" tabindex="-1"></a>app <span class="op">=</span> App(ui<span class="op">=</span>app_ui, server<span class="op">=</span>server)</span><div class="code-annotation-gutter-bg"></div><div class="code-annotation-gutter"></div></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<dl class="code-annotation-container-hidden code-annotation-container-grid">
<dt data-target-cell="annotated-cell-7" data-target-annotation="1">1</dt>
<dd>
<span data-code-cell="annotated-cell-7" data-code-lines="48" data-code-annotation="1">Here we define a new function that’s used to conveniently return a text field and an action button together. This is what we’ll use for the key input going forward.</span>
</dd>
<dt data-target-cell="annotated-cell-7" data-target-annotation="2">2</dt>
<dd>
<span data-code-cell="annotated-cell-7" data-code-lines="56,57,58" data-code-annotation="2">Notice that the <code>id</code> value that we’ll pass into <code>input_text_with_button()</code> will return seperate unique <code>id values</code> for the text field and action button.</span>
</dd>
<dt data-target-cell="annotated-cell-7" data-target-annotation="3">3</dt>
<dd>
<span data-code-cell="annotated-cell-7" data-code-lines="60" data-code-annotation="3">Feel free to experiment with styling any elements with CSS. If you’d rather not have inline CSS, you can move the styling into a dedicated CSS file and apply it with classes or IDs to the elements in your UI.</span>
</dd>
<dt data-target-cell="annotated-cell-7" data-target-annotation="4">4</dt>
<dd>
<span data-code-cell="annotated-cell-7" data-code-lines="70,71,72,73,74" data-code-annotation="4">We replace the text field of previous iterations with our new <code>input_text_with_button()</code> text field action button combo.</span>
</dd>
<dt data-target-cell="annotated-cell-7" data-target-annotation="5">5</dt>
<dd>
<span data-code-cell="annotated-cell-7" data-code-lines="90,91,92,93,94,95,96,97,98" data-code-annotation="5">In the server, we define a new function that will run whenever the action button with <code>id=input.key_input_btn</code> is clicked by the user. If there’s a value that’s been submitted we’re going to place a confirmation notification on the UI. If not, we’ll raise a warning to the user to remind them to submit their key.</span>
</dd>
</dl>
<p>I’ve added a marker in the process diagram to remind us that <code>handle_api_key_submit()</code> will run as a reactive event when the key is submitted. This is going to update the UI with feedback notifications.</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="https://i.imgur.com/lU743ra.png" class="img-fluid figure-img"></p>
<figcaption>Process diagram for iteration 5</figcaption>
</figure>
</div>
<div class="callout callout-style-default callout-tip callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Tip
</div>
</div>
<div class="callout-body-container callout-body">
<p>Using <code>ui_notification_show()</code> is a really useful method for debugging reactive values when your app breaks. Use it to check on intermediate values that the frontend receives from the backend.</p>
</div>
</div>
<div class="callout callout-style-default callout-important callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Important
</div>
</div>
<div class="callout-body-container callout-body">
<p>I use a real OpenAI API key in these clips to demonstrate the application working. Note that I have since revoked this key and it will no longer work. You should not share your secret keys with anyone.</p>
</div>
</div>
<p>In the recording below you can see the new action button and the UI notifications being returned by the server. However, note that I still get that nasty red error when I pass an invalid key. In the next iteration, we’ll determine whether the user has used a valid key.</p>
<iframe title="Iteration 5 recording" src="https://player.vimeo.com/video/1010111488?h=f74e808099" class="iframey" allowfullscreen="" style="overflow:hidden;margin:0;padding:0;width:100%;height:24rem;">
</iframe>
</div>
<div id="tabset-1-6" class="tab-pane" role="tabpanel" aria-labelledby="tabset-1-6-tab">
<p>In this version of the app we will introduce more backend logic that will check whether the key the user has submitted is a valid one.</p>
<div class="code-with-filename">
<div class="code-with-filename-file">
<pre><strong>app.py</strong></pre>
</div>
<div class="sourceCode" id="annotated-cell-8" data-filename="app.py"><pre class="sourceCode python code-annotation-code code-with-copy code-annotated"><code class="sourceCode python"><span id="annotated-cell-8-1"><a href="#annotated-cell-8-1" aria-hidden="true" tabindex="-1"></a><span class="co">"""Iteration 6: Check the key is valid."""</span></span>
<span id="annotated-cell-8-2"><a href="#annotated-cell-8-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> openai</span>
<span id="annotated-cell-8-3"><a href="#annotated-cell-8-3" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> shiny <span class="im">import</span> App, reactive, ui</span>
<span id="annotated-cell-8-4"><a href="#annotated-cell-8-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="annotated-cell-8-5"><a href="#annotated-cell-8-5" aria-hidden="true" tabindex="-1"></a>_SYSTEM_MSG <span class="op">=</span> <span class="st">"""</span></span>
<span id="annotated-cell-8-6"><a href="#annotated-cell-8-6" aria-hidden="true" tabindex="-1"></a><span class="st">You are the guide of a 'choose your own adventure'- style game: a mystical</span></span>
<span id="annotated-cell-8-7"><a href="#annotated-cell-8-7" aria-hidden="true" tabindex="-1"></a><span class="st">journey through the Amazon Rainforest. Your job is to create compelling</span></span>
<span id="annotated-cell-8-8"><a href="#annotated-cell-8-8" aria-hidden="true" tabindex="-1"></a><span class="st">outcomes that correspond with the player's choices. You must navigate the</span></span>
<span id="annotated-cell-8-9"><a href="#annotated-cell-8-9" aria-hidden="true" tabindex="-1"></a><span class="st">player through challenges, providing choices, and consequences, dynamically</span></span>
<span id="annotated-cell-8-10"><a href="#annotated-cell-8-10" aria-hidden="true" tabindex="-1"></a><span class="st">adapting the tale based on the player's inputs. Your goal is to create a</span></span>
<span id="annotated-cell-8-11"><a href="#annotated-cell-8-11" aria-hidden="true" tabindex="-1"></a><span class="st">branching narrative experience where each of the player's choices leads to</span></span>
<span id="annotated-cell-8-12"><a href="#annotated-cell-8-12" aria-hidden="true" tabindex="-1"></a><span class="st">a new path, ultimately determining their fate. The player's goal is to find</span></span>
<span id="annotated-cell-8-13"><a href="#annotated-cell-8-13" aria-hidden="true" tabindex="-1"></a><span class="st">the lost crown of Quetzalcoatl.</span></span>
<span id="annotated-cell-8-14"><a href="#annotated-cell-8-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="annotated-cell-8-15"><a href="#annotated-cell-8-15" aria-hidden="true" tabindex="-1"></a><span class="st">Here are some rules to follow:</span></span>
<span id="annotated-cell-8-16"><a href="#annotated-cell-8-16" aria-hidden="true" tabindex="-1"></a><span class="st">1. Always wait for the player to respond with their input before providing</span></span>
<span id="annotated-cell-8-17"><a href="#annotated-cell-8-17" aria-hidden="true" tabindex="-1"></a><span class="st">any choices. Never provide the player's input yourself. This is most</span></span>
<span id="annotated-cell-8-18"><a href="#annotated-cell-8-18" aria-hidden="true" tabindex="-1"></a><span class="st">important.</span></span>
<span id="annotated-cell-8-19"><a href="#annotated-cell-8-19" aria-hidden="true" tabindex="-1"></a><span class="st">2. Ask the player to provide a name, gender and race.</span></span>
<span id="annotated-cell-8-20"><a href="#annotated-cell-8-20" aria-hidden="true" tabindex="-1"></a><span class="st">3. Ask the player to choose from a selection of weapons that will be used</span></span>
<span id="annotated-cell-8-21"><a href="#annotated-cell-8-21" aria-hidden="true" tabindex="-1"></a><span class="st">later in the game.</span></span>
<span id="annotated-cell-8-22"><a href="#annotated-cell-8-22" aria-hidden="true" tabindex="-1"></a><span class="st">4. Have a few paths that lead to success. </span></span>
<span id="annotated-cell-8-23"><a href="#annotated-cell-8-23" aria-hidden="true" tabindex="-1"></a><span class="st">5. Have some paths that lead to death.</span></span>
<span id="annotated-cell-8-24"><a href="#annotated-cell-8-24" aria-hidden="true" tabindex="-1"></a><span class="st">6. Whether or not the game results in success or death, the response must</span></span>
<span id="annotated-cell-8-25"><a href="#annotated-cell-8-25" aria-hidden="true" tabindex="-1"></a><span class="st">include the text "The End...", I will search for this text to end the game.</span></span>
<span id="annotated-cell-8-26"><a href="#annotated-cell-8-26" aria-hidden="true" tabindex="-1"></a><span class="st">"""</span></span>
<span id="annotated-cell-8-27"><a href="#annotated-cell-8-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="annotated-cell-8-28"><a href="#annotated-cell-8-28" aria-hidden="true" tabindex="-1"></a>WELCOME_MSG <span class="op">=</span> <span class="st">"""</span></span>
<span id="annotated-cell-8-29"><a href="#annotated-cell-8-29" aria-hidden="true" tabindex="-1"></a><span class="st">Welcome to the Amazon Rainforest, adventurer! Your mission is to find the</span></span>
<span id="annotated-cell-8-30"><a href="#annotated-cell-8-30" aria-hidden="true" tabindex="-1"></a><span class="st">lost Crown of Quetzalcoatl.</span></span>
<span id="annotated-cell-8-31"><a href="#annotated-cell-8-31" aria-hidden="true" tabindex="-1"></a><span class="st">However, many challenges stand in your way. Are you brave enough, strong</span></span>
<span id="annotated-cell-8-32"><a href="#annotated-cell-8-32" aria-hidden="true" tabindex="-1"></a><span class="st">enough and clever enough to overcome the perils of the jungle and secure</span></span>
<span id="annotated-cell-8-33"><a href="#annotated-cell-8-33" aria-hidden="true" tabindex="-1"></a><span class="st">the crown?</span></span>
<span id="annotated-cell-8-34"><a href="#annotated-cell-8-34" aria-hidden="true" tabindex="-1"></a></span>
<span id="annotated-cell-8-35"><a href="#annotated-cell-8-35" aria-hidden="true" tabindex="-1"></a><span class="st">Before we begin our journey, choose your name, gender and race. Choose a</span></span>
<span id="annotated-cell-8-36"><a href="#annotated-cell-8-36" aria-hidden="true" tabindex="-1"></a><span class="st">weapon to bring with you. Choose wisely, as the way ahead is filled with</span></span>
<span id="annotated-cell-8-37"><a href="#annotated-cell-8-37" aria-hidden="true" tabindex="-1"></a><span class="st">many dangers.</span></span>
<span id="annotated-cell-8-38"><a href="#annotated-cell-8-38" aria-hidden="true" tabindex="-1"></a><span class="st">"""</span></span>
<span id="annotated-cell-8-39"><a href="#annotated-cell-8-39" aria-hidden="true" tabindex="-1"></a></span>
<span id="annotated-cell-8-40"><a href="#annotated-cell-8-40" aria-hidden="true" tabindex="-1"></a><span class="co"># compose a message stream</span></span>
<span id="annotated-cell-8-41"><a href="#annotated-cell-8-41" aria-hidden="true" tabindex="-1"></a>_SYS <span class="op">=</span> {<span class="st">"role"</span>: <span class="st">"system"</span>, <span class="st">"content"</span>: _SYSTEM_MSG}</span>
<span id="annotated-cell-8-42"><a href="#annotated-cell-8-42" aria-hidden="true" tabindex="-1"></a>_WELCOME <span class="op">=</span> {<span class="st">"role"</span>: <span class="st">"assistant"</span>, <span class="st">"content"</span>: WELCOME_MSG}</span>
<span id="annotated-cell-8-43"><a href="#annotated-cell-8-43" aria-hidden="true" tabindex="-1"></a>stream <span class="op">=</span> [_SYS, _WELCOME]</span>
<span id="annotated-cell-8-44"><a href="#annotated-cell-8-44" aria-hidden="true" tabindex="-1"></a></span>
<span id="annotated-cell-8-45"><a href="#annotated-cell-8-45" aria-hidden="true" tabindex="-1"></a><span class="co"># Shiny User Interface ----------------------------------------------------</span></span>
<span id="annotated-cell-8-46"><a href="#annotated-cell-8-46" aria-hidden="true" tabindex="-1"></a></span>
<span id="annotated-cell-8-47"><a href="#annotated-cell-8-47" aria-hidden="true" tabindex="-1"></a></span>
<span id="annotated-cell-8-48"><a href="#annotated-cell-8-48" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> input_text_with_button(<span class="bu">id</span>, label, button_label, placeholder<span class="op">=</span><span class="st">""</span>):</span>
<span id="annotated-cell-8-49"><a href="#annotated-cell-8-49" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="annotated-cell-8-50"><a href="#annotated-cell-8-50" aria-hidden="true" tabindex="-1"></a><span class="co">    An interface component combining an input text widget with an action</span></span>
<span id="annotated-cell-8-51"><a href="#annotated-cell-8-51" aria-hidden="true" tabindex="-1"></a><span class="co">    button. IDs for the text field and button can be accessed as &lt;id&gt;_text</span></span>
<span id="annotated-cell-8-52"><a href="#annotated-cell-8-52" aria-hidden="true" tabindex="-1"></a><span class="co">    and &lt;id&gt;_btn respectively.</span></span>
<span id="annotated-cell-8-53"><a href="#annotated-cell-8-53" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="annotated-cell-8-54"><a href="#annotated-cell-8-54" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> ui.div(</span>
<span id="annotated-cell-8-55"><a href="#annotated-cell-8-55" aria-hidden="true" tabindex="-1"></a>        ui.input_text(</span>
<span id="annotated-cell-8-56"><a href="#annotated-cell-8-56" aria-hidden="true" tabindex="-1"></a>            <span class="bu">id</span><span class="op">=</span><span class="ss">f"</span><span class="sc">{</span><span class="bu">id</span><span class="sc">}</span><span class="ss">_text"</span>, label<span class="op">=</span>label, placeholder<span class="op">=</span>placeholder),</span>
<span id="annotated-cell-8-57"><a href="#annotated-cell-8-57" aria-hidden="true" tabindex="-1"></a>        ui.input_action_button(</span>
<span id="annotated-cell-8-58"><a href="#annotated-cell-8-58" aria-hidden="true" tabindex="-1"></a>            <span class="bu">id</span><span class="op">=</span><span class="ss">f"</span><span class="sc">{</span><span class="bu">id</span><span class="sc">}</span><span class="ss">_btn"</span>,</span>
<span id="annotated-cell-8-59"><a href="#annotated-cell-8-59" aria-hidden="true" tabindex="-1"></a>            label<span class="op">=</span>button_label,</span>
<span id="annotated-cell-8-60"><a href="#annotated-cell-8-60" aria-hidden="true" tabindex="-1"></a>            style<span class="op">=</span><span class="st">"margin-top:28px;margin-bottom:16px;color:#04bb8c;border-color:#04bb8c;"</span></span>
<span id="annotated-cell-8-61"><a href="#annotated-cell-8-61" aria-hidden="true" tabindex="-1"></a>            ),</span>
<span id="annotated-cell-8-62"><a href="#annotated-cell-8-62" aria-hidden="true" tabindex="-1"></a>        class_<span class="op">=</span><span class="st">"d-flex gap-2"</span></span>
<span id="annotated-cell-8-63"><a href="#annotated-cell-8-63" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="annotated-cell-8-64"><a href="#annotated-cell-8-64" aria-hidden="true" tabindex="-1"></a></span>
<span id="annotated-cell-8-65"><a href="#annotated-cell-8-65" aria-hidden="true" tabindex="-1"></a></span>
<span id="annotated-cell-8-66"><a href="#annotated-cell-8-66" aria-hidden="true" tabindex="-1"></a>app_ui <span class="op">=</span> ui.page_fillable(</span>
<span id="annotated-cell-8-67"><a href="#annotated-cell-8-67" aria-hidden="true" tabindex="-1"></a>    ui.panel_title(<span class="st">"Choose Your Own Adventure: Jungle Quest!"</span>),</span>
<span id="annotated-cell-8-68"><a href="#annotated-cell-8-68" aria-hidden="true" tabindex="-1"></a>    ui.accordion(</span>
<span id="annotated-cell-8-69"><a href="#annotated-cell-8-69" aria-hidden="true" tabindex="-1"></a>    ui.accordion_panel(<span class="st">"Step 1: Your OpenAI API Key"</span>,</span>
<span id="annotated-cell-8-70"><a href="#annotated-cell-8-70" aria-hidden="true" tabindex="-1"></a>        input_text_with_button(</span>
<span id="annotated-cell-8-71"><a href="#annotated-cell-8-71" aria-hidden="true" tabindex="-1"></a>            <span class="bu">id</span><span class="op">=</span><span class="st">"key_input"</span>,</span>
<span id="annotated-cell-8-72"><a href="#annotated-cell-8-72" aria-hidden="true" tabindex="-1"></a>            label<span class="op">=</span><span class="st">"Enter your OpenAI API key"</span>,</span>
<span id="annotated-cell-8-73"><a href="#annotated-cell-8-73" aria-hidden="true" tabindex="-1"></a>            button_label<span class="op">=</span><span class="st">"Submit"</span>,</span>
<span id="annotated-cell-8-74"><a href="#annotated-cell-8-74" aria-hidden="true" tabindex="-1"></a>            placeholder<span class="op">=</span><span class="st">"Enter key here"</span></span>
<span id="annotated-cell-8-75"><a href="#annotated-cell-8-75" aria-hidden="true" tabindex="-1"></a>            )), <span class="bu">id</span><span class="op">=</span><span class="st">"acc"</span>, multiple<span class="op">=</span><span class="va">False</span>),</span>
<span id="annotated-cell-8-76"><a href="#annotated-cell-8-76" aria-hidden="true" tabindex="-1"></a>ui.h6(<span class="st">"Step 2: Choose your adventure"</span>),</span>
<span id="annotated-cell-8-77"><a href="#annotated-cell-8-77" aria-hidden="true" tabindex="-1"></a>    ui.chat_ui(<span class="bu">id</span><span class="op">=</span><span class="st">"chat"</span>),</span>
<span id="annotated-cell-8-78"><a href="#annotated-cell-8-78" aria-hidden="true" tabindex="-1"></a>    fillable_mobile<span class="op">=</span><span class="va">True</span>,</span>
<span id="annotated-cell-8-79"><a href="#annotated-cell-8-79" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="annotated-cell-8-80"><a href="#annotated-cell-8-80" aria-hidden="true" tabindex="-1"></a></span>
<span id="annotated-cell-8-81"><a href="#annotated-cell-8-81" aria-hidden="true" tabindex="-1"></a><span class="co"># Shiny server logic ------------------------------------------------------</span></span>
<span id="annotated-cell-8-82"><a href="#annotated-cell-8-82" aria-hidden="true" tabindex="-1"></a></span>
<span id="annotated-cell-8-83"><a href="#annotated-cell-8-83" aria-hidden="true" tabindex="-1"></a></span>
<span id="annotated-cell-8-84"><a href="#annotated-cell-8-84" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> server(<span class="bu">input</span>, output, session):</span>
<span id="annotated-cell-8-85"><a href="#annotated-cell-8-85" aria-hidden="true" tabindex="-1"></a>    chat <span class="op">=</span> ui.Chat(</span>
<span id="annotated-cell-8-86"><a href="#annotated-cell-8-86" aria-hidden="true" tabindex="-1"></a>        <span class="bu">id</span><span class="op">=</span><span class="st">"chat"</span>, messages<span class="op">=</span>[ui.markdown(WELCOME_MSG)], tokenizer<span class="op">=</span><span class="va">None</span></span>
<span id="annotated-cell-8-87"><a href="#annotated-cell-8-87" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="annotated-cell-8-88"><a href="#annotated-cell-8-88" aria-hidden="true" tabindex="-1"></a></span>
<span id="annotated-cell-8-89"><a href="#annotated-cell-8-89" aria-hidden="true" tabindex="-1"></a>    <span class="at">@reactive.Effect</span></span>
<span id="annotated-cell-8-90"><a href="#annotated-cell-8-90" aria-hidden="true" tabindex="-1"></a>    <span class="at">@reactive.event</span>(<span class="bu">input</span>.key_input_btn)</span>
<span id="annotated-cell-8-91"><a href="#annotated-cell-8-91" aria-hidden="true" tabindex="-1"></a>    <span class="cf">async</span> <span class="kw">def</span> handle_api_key_submit():</span>
<span id="annotated-cell-8-92"><a href="#annotated-cell-8-92" aria-hidden="true" tabindex="-1"></a>        <span class="co">"""Update the UI with a notification when user submits key.</span></span>
<span id="annotated-cell-8-93"><a href="#annotated-cell-8-93" aria-hidden="true" tabindex="-1"></a><span class="co">        </span></span>
<span id="annotated-cell-8-94"><a href="#annotated-cell-8-94" aria-hidden="true" tabindex="-1"></a><span class="co">        Checks the validity of the API key by querying the models list</span></span>
<span id="annotated-cell-8-95"><a href="#annotated-cell-8-95" aria-hidden="true" tabindex="-1"></a><span class="co">        endpoint."""</span></span>
<span id="annotated-cell-8-96"><a href="#annotated-cell-8-96" aria-hidden="true" tabindex="-1"></a>        api_key <span class="op">=</span> <span class="bu">input</span>.key_input_text()</span>
<button class="code-annotation-anchor" data-target-cell="annotated-cell-8" data-target-annotation="1">1</button><span id="annotated-cell-8-97" class="code-annotation-target"><a href="#annotated-cell-8-97" aria-hidden="true" tabindex="-1"></a>        client <span class="op">=</span> openai.AsyncOpenAI(api_key<span class="op">=</span>api_key)</span>
<span id="annotated-cell-8-98"><a href="#annotated-cell-8-98" aria-hidden="true" tabindex="-1"></a>        <span class="cf">try</span>:</span>
<button class="code-annotation-anchor" data-target-cell="annotated-cell-8" data-target-annotation="2">2</button><span id="annotated-cell-8-99" class="code-annotation-target"><a href="#annotated-cell-8-99" aria-hidden="true" tabindex="-1"></a>            resp <span class="op">=</span> <span class="cf">await</span> client.models.<span class="bu">list</span>()</span>
<span id="annotated-cell-8-100"><a href="#annotated-cell-8-100" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> resp:</span>
<span id="annotated-cell-8-101"><a href="#annotated-cell-8-101" aria-hidden="true" tabindex="-1"></a>                ui.notification_show(</span>
<span id="annotated-cell-8-102"><a href="#annotated-cell-8-102" aria-hidden="true" tabindex="-1"></a>                    <span class="ss">f"API key validated: </span><span class="sc">{</span>api_key[:<span class="dv">5</span>]<span class="sc">}</span><span class="ss">..."</span>)</span>
<button class="code-annotation-anchor" data-target-cell="annotated-cell-8" data-target-annotation="3">3</button><span id="annotated-cell-8-103" class="code-annotation-target"><a href="#annotated-cell-8-103" aria-hidden="true" tabindex="-1"></a>        <span class="cf">except</span> openai.AuthenticationError <span class="im">as</span> e:</span>
<span id="annotated-cell-8-104"><a href="#annotated-cell-8-104" aria-hidden="true" tabindex="-1"></a>            ui.notification_show(</span>
<span id="annotated-cell-8-105"><a href="#annotated-cell-8-105" aria-hidden="true" tabindex="-1"></a>                <span class="st">"Bad key provided. Please try again."</span>, <span class="bu">type</span><span class="op">=</span><span class="st">"warning"</span>)</span>
<span id="annotated-cell-8-106"><a href="#annotated-cell-8-106" aria-hidden="true" tabindex="-1"></a></span>
<span id="annotated-cell-8-107"><a href="#annotated-cell-8-107" aria-hidden="true" tabindex="-1"></a></span>
<span id="annotated-cell-8-108"><a href="#annotated-cell-8-108" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Define a callback to run when the user submits a message</span></span>
<span id="annotated-cell-8-109"><a href="#annotated-cell-8-109" aria-hidden="true" tabindex="-1"></a>    <span class="at">@chat.on_user_submit</span></span>
<span id="annotated-cell-8-110"><a href="#annotated-cell-8-110" aria-hidden="true" tabindex="-1"></a>    <span class="cf">async</span> <span class="kw">def</span> respond():</span>
<span id="annotated-cell-8-111"><a href="#annotated-cell-8-111" aria-hidden="true" tabindex="-1"></a>        <span class="co">"""Respond to the user's message."""</span></span>
<span id="annotated-cell-8-112"><a href="#annotated-cell-8-112" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Get the user's input</span></span>
<span id="annotated-cell-8-113"><a href="#annotated-cell-8-113" aria-hidden="true" tabindex="-1"></a>        user <span class="op">=</span> chat.user_input()</span>
<span id="annotated-cell-8-114"><a href="#annotated-cell-8-114" aria-hidden="true" tabindex="-1"></a>        <span class="co">#  update the stream list</span></span>
<span id="annotated-cell-8-115"><a href="#annotated-cell-8-115" aria-hidden="true" tabindex="-1"></a>        stream.append({<span class="st">"role"</span>: <span class="st">"user"</span>, <span class="st">"content"</span>: user})</span>
<span id="annotated-cell-8-116"><a href="#annotated-cell-8-116" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Append a response to the chat</span></span>
<span id="annotated-cell-8-117"><a href="#annotated-cell-8-117" aria-hidden="true" tabindex="-1"></a>        client <span class="op">=</span> openai.AsyncOpenAI(api_key<span class="op">=</span><span class="bu">input</span>.key_input_text())</span>
<span id="annotated-cell-8-118"><a href="#annotated-cell-8-118" aria-hidden="true" tabindex="-1"></a>        response <span class="op">=</span> <span class="cf">await</span> client.chat.completions.create(</span>
<span id="annotated-cell-8-119"><a href="#annotated-cell-8-119" aria-hidden="true" tabindex="-1"></a>            model<span class="op">=</span><span class="st">"gpt-3.5-turbo"</span>,</span>
<span id="annotated-cell-8-120"><a href="#annotated-cell-8-120" aria-hidden="true" tabindex="-1"></a>            messages<span class="op">=</span>stream,</span>
<span id="annotated-cell-8-121"><a href="#annotated-cell-8-121" aria-hidden="true" tabindex="-1"></a>            temperature<span class="op">=</span><span class="fl">0.7</span>, <span class="co"># increase to make the model more creative</span></span>
<span id="annotated-cell-8-122"><a href="#annotated-cell-8-122" aria-hidden="true" tabindex="-1"></a>            )</span>
<span id="annotated-cell-8-123"><a href="#annotated-cell-8-123" aria-hidden="true" tabindex="-1"></a>        model_response <span class="op">=</span> response.choices[<span class="dv">0</span>].message.content</span>
<span id="annotated-cell-8-124"><a href="#annotated-cell-8-124" aria-hidden="true" tabindex="-1"></a>        <span class="cf">await</span> chat.append_message(model_response)</span>
<span id="annotated-cell-8-125"><a href="#annotated-cell-8-125" aria-hidden="true" tabindex="-1"></a>        <span class="co">#  if the model indicates game over, end the game with a message.</span></span>
<span id="annotated-cell-8-126"><a href="#annotated-cell-8-126" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="st">"the end..."</span> <span class="kw">in</span> model_response.lower():</span>
<span id="annotated-cell-8-127"><a href="#annotated-cell-8-127" aria-hidden="true" tabindex="-1"></a>            <span class="cf">await</span> chat.append_message(</span>
<span id="annotated-cell-8-128"><a href="#annotated-cell-8-128" aria-hidden="true" tabindex="-1"></a>                {</span>
<span id="annotated-cell-8-129"><a href="#annotated-cell-8-129" aria-hidden="true" tabindex="-1"></a>                    <span class="st">"role"</span>: <span class="st">"assistant"</span>,</span>
<span id="annotated-cell-8-130"><a href="#annotated-cell-8-130" aria-hidden="true" tabindex="-1"></a>                    <span class="st">"content"</span>: <span class="st">"Game Over! Refresh the page to play again."</span></span>
<span id="annotated-cell-8-131"><a href="#annotated-cell-8-131" aria-hidden="true" tabindex="-1"></a>                    })</span>
<span id="annotated-cell-8-132"><a href="#annotated-cell-8-132" aria-hidden="true" tabindex="-1"></a>            exit()</span>
<span id="annotated-cell-8-133"><a href="#annotated-cell-8-133" aria-hidden="true" tabindex="-1"></a>        <span class="cf">else</span>:</span>
<span id="annotated-cell-8-134"><a href="#annotated-cell-8-134" aria-hidden="true" tabindex="-1"></a>            stream.append({<span class="st">"role"</span>: <span class="st">"assistant"</span>, <span class="st">"content"</span>: model_response})</span>
<span id="annotated-cell-8-135"><a href="#annotated-cell-8-135" aria-hidden="true" tabindex="-1"></a></span>
<span id="annotated-cell-8-136"><a href="#annotated-cell-8-136" aria-hidden="true" tabindex="-1"></a></span>
<span id="annotated-cell-8-137"><a href="#annotated-cell-8-137" aria-hidden="true" tabindex="-1"></a>app <span class="op">=</span> App(ui<span class="op">=</span>app_ui, server<span class="op">=</span>server)</span><div class="code-annotation-gutter-bg"></div><div class="code-annotation-gutter"></div></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<dl class="code-annotation-container-hidden code-annotation-container-grid">
<dt data-target-cell="annotated-cell-8" data-target-annotation="1">1</dt>
<dd>
<span data-code-cell="annotated-cell-8" data-code-lines="97" data-code-annotation="1">Notice that we are now creating another openai client. This is so that we can test the key to see whether it successfully queries the openai service, before using it to play the game. Initiating multiple clients is not needed and is inefficient design. In a later iteration we’ll come back to this.</span>
</dd>
<dt data-target-cell="annotated-cell-8" data-target-annotation="2">2</dt>
<dd>
<span data-code-cell="annotated-cell-8" data-code-lines="99" data-code-annotation="2">This time we’ll query the <code>models.list()</code> endpoint to get a list of models available. There is currently no OpenAI endpoint for explicitly checking whether a service is valid. OpenAI API support team responded to my support ticket to suggest this as the best method for ensuring the submitted key is valid.</span>
</dd>
<dt data-target-cell="annotated-cell-8" data-target-annotation="3">3</dt>
<dd>
<span data-code-cell="annotated-cell-8" data-code-lines="103" data-code-annotation="3">In cases where a bad key is provided, we can avoid the <code>openai.AuthenticationError</code> and print a warning to the UI instead.</span>
</dd>
</dl>
<p>In our increasingly complex process diagram, I’ve emphasised that <code>handle_api_key_submit()</code> now instantiates another client object and uses it to query the <code>models.list</code> endpoint of the OpenAI service.</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="https://i.imgur.com/Tb7jjeK.png" class="img-fluid figure-img"></p>
<figcaption>Process diagram for iteration 6</figcaption>
</figure>
</div>
<div class="callout callout-style-default callout-important callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Important
</div>
</div>
<div class="callout-body-container callout-body">
<p>I use a real OpenAI API key in these clips to demonstrate the application working. Note that I have since revoked this key and it will no longer work. You should not share your secret keys with anyone.</p>
</div>
</div>
<p>In the recording below I demonstrate how this version of the app will return a warning to the user if the submitted key was not valid.</p>
<iframe title="Iteration 6 recording" src="https://player.vimeo.com/video/1010111977?h=b625a6f9ef" class="iframey" allowfullscreen="" style="overflow:hidden;margin:0;padding:0;width:100%;height:24rem;">
</iframe>
</div>
<div id="tabset-1-7" class="tab-pane" role="tabpanel" aria-labelledby="tabset-1-7-tab">
<p>Now we introduce a moderations feature that will check that the prompts being passed from the user to the OpenAI service comply with the service’s usage policies. Forewarned - this is far from perfect!</p>
<p>In general, it’s pretty good but if you’re intentionally trying to test it like I did when implementing this feature, you can find some funny quirks. British expletives tend to sail through unchallenged and at times my test prompts were raised as violations for stating things like “Let’s fight!” (category: harassment) when that was one of the options provided to me by the model! It’s likely that passing greater context to the moderations endpoint (such as more of the message stream) may be able to overcome this, though that has not been implemented for this tutorial.</p>
<div class="code-with-filename">
<div class="code-with-filename-file">
<pre><strong>app.py</strong></pre>
</div>
<div class="sourceCode" id="annotated-cell-9" data-filename="app.py"><pre class="sourceCode python code-annotation-code code-with-copy code-annotated"><code class="sourceCode python"><span id="annotated-cell-9-1"><a href="#annotated-cell-9-1" aria-hidden="true" tabindex="-1"></a><span class="co">"""Iteration 7: Implement prompt moderation."""</span></span>
<span id="annotated-cell-9-2"><a href="#annotated-cell-9-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> openai</span>
<span id="annotated-cell-9-3"><a href="#annotated-cell-9-3" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> shiny <span class="im">import</span> App, reactive, ui</span>
<span id="annotated-cell-9-4"><a href="#annotated-cell-9-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="annotated-cell-9-5"><a href="#annotated-cell-9-5" aria-hidden="true" tabindex="-1"></a>_SYSTEM_MSG <span class="op">=</span> <span class="st">"""</span></span>
<span id="annotated-cell-9-6"><a href="#annotated-cell-9-6" aria-hidden="true" tabindex="-1"></a><span class="st">You are the guide of a 'choose your own adventure'- style game: a mystical</span></span>
<span id="annotated-cell-9-7"><a href="#annotated-cell-9-7" aria-hidden="true" tabindex="-1"></a><span class="st">journey through the Amazon Rainforest. Your job is to create compelling</span></span>
<span id="annotated-cell-9-8"><a href="#annotated-cell-9-8" aria-hidden="true" tabindex="-1"></a><span class="st">outcomes that correspond with the player's choices. You must navigate the</span></span>
<span id="annotated-cell-9-9"><a href="#annotated-cell-9-9" aria-hidden="true" tabindex="-1"></a><span class="st">player through challenges, providing choices, and consequences, dynamically</span></span>
<span id="annotated-cell-9-10"><a href="#annotated-cell-9-10" aria-hidden="true" tabindex="-1"></a><span class="st">adapting the tale based on the player's inputs. Your goal is to create a</span></span>
<span id="annotated-cell-9-11"><a href="#annotated-cell-9-11" aria-hidden="true" tabindex="-1"></a><span class="st">branching narrative experience where each of the player's choices leads to</span></span>
<span id="annotated-cell-9-12"><a href="#annotated-cell-9-12" aria-hidden="true" tabindex="-1"></a><span class="st">a new path, ultimately determining their fate. The player's goal is to find</span></span>
<span id="annotated-cell-9-13"><a href="#annotated-cell-9-13" aria-hidden="true" tabindex="-1"></a><span class="st">the lost crown of Quetzalcoatl.</span></span>
<span id="annotated-cell-9-14"><a href="#annotated-cell-9-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="annotated-cell-9-15"><a href="#annotated-cell-9-15" aria-hidden="true" tabindex="-1"></a><span class="st">Here are some rules to follow:</span></span>
<span id="annotated-cell-9-16"><a href="#annotated-cell-9-16" aria-hidden="true" tabindex="-1"></a><span class="st">1. Always wait for the player to respond with their input before providing</span></span>
<span id="annotated-cell-9-17"><a href="#annotated-cell-9-17" aria-hidden="true" tabindex="-1"></a><span class="st">any choices. Never provide the player's input yourself. This is most</span></span>
<span id="annotated-cell-9-18"><a href="#annotated-cell-9-18" aria-hidden="true" tabindex="-1"></a><span class="st">important.</span></span>
<span id="annotated-cell-9-19"><a href="#annotated-cell-9-19" aria-hidden="true" tabindex="-1"></a><span class="st">2. Ask the player to provide a name, gender and race.</span></span>
<span id="annotated-cell-9-20"><a href="#annotated-cell-9-20" aria-hidden="true" tabindex="-1"></a><span class="st">3. Ask the player to choose from a selection of weapons that will be used</span></span>
<span id="annotated-cell-9-21"><a href="#annotated-cell-9-21" aria-hidden="true" tabindex="-1"></a><span class="st">later in the game.</span></span>
<span id="annotated-cell-9-22"><a href="#annotated-cell-9-22" aria-hidden="true" tabindex="-1"></a><span class="st">4. Have a few paths that lead to success. </span></span>
<span id="annotated-cell-9-23"><a href="#annotated-cell-9-23" aria-hidden="true" tabindex="-1"></a><span class="st">5. Have some paths that lead to death.</span></span>
<span id="annotated-cell-9-24"><a href="#annotated-cell-9-24" aria-hidden="true" tabindex="-1"></a><span class="st">6. Whether or not the game results in success or death, the response must</span></span>
<span id="annotated-cell-9-25"><a href="#annotated-cell-9-25" aria-hidden="true" tabindex="-1"></a><span class="st">include the text "The End...", I will search for this text to end the game.</span></span>
<span id="annotated-cell-9-26"><a href="#annotated-cell-9-26" aria-hidden="true" tabindex="-1"></a><span class="st">"""</span></span>
<span id="annotated-cell-9-27"><a href="#annotated-cell-9-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="annotated-cell-9-28"><a href="#annotated-cell-9-28" aria-hidden="true" tabindex="-1"></a>WELCOME_MSG <span class="op">=</span> <span class="st">"""</span></span>
<span id="annotated-cell-9-29"><a href="#annotated-cell-9-29" aria-hidden="true" tabindex="-1"></a><span class="st">Welcome to the Amazon Rainforest, adventurer! Your mission is to find the</span></span>
<span id="annotated-cell-9-30"><a href="#annotated-cell-9-30" aria-hidden="true" tabindex="-1"></a><span class="st">lost Crown of Quetzalcoatl.</span></span>
<span id="annotated-cell-9-31"><a href="#annotated-cell-9-31" aria-hidden="true" tabindex="-1"></a><span class="st">However, many challenges stand in your way. Are you brave enough, strong</span></span>
<span id="annotated-cell-9-32"><a href="#annotated-cell-9-32" aria-hidden="true" tabindex="-1"></a><span class="st">enough and clever enough to overcome the perils of the jungle and secure</span></span>
<span id="annotated-cell-9-33"><a href="#annotated-cell-9-33" aria-hidden="true" tabindex="-1"></a><span class="st">the crown?</span></span>
<span id="annotated-cell-9-34"><a href="#annotated-cell-9-34" aria-hidden="true" tabindex="-1"></a></span>
<span id="annotated-cell-9-35"><a href="#annotated-cell-9-35" aria-hidden="true" tabindex="-1"></a><span class="st">Before we begin our journey, choose your name, gender and race. Choose a</span></span>
<span id="annotated-cell-9-36"><a href="#annotated-cell-9-36" aria-hidden="true" tabindex="-1"></a><span class="st">weapon to bring with you. Choose wisely, as the way ahead is filled with</span></span>
<span id="annotated-cell-9-37"><a href="#annotated-cell-9-37" aria-hidden="true" tabindex="-1"></a><span class="st">many dangers.</span></span>
<span id="annotated-cell-9-38"><a href="#annotated-cell-9-38" aria-hidden="true" tabindex="-1"></a><span class="st">"""</span></span>
<span id="annotated-cell-9-39"><a href="#annotated-cell-9-39" aria-hidden="true" tabindex="-1"></a></span>
<span id="annotated-cell-9-40"><a href="#annotated-cell-9-40" aria-hidden="true" tabindex="-1"></a><span class="co"># compose a message stream</span></span>
<span id="annotated-cell-9-41"><a href="#annotated-cell-9-41" aria-hidden="true" tabindex="-1"></a>_SYS <span class="op">=</span> {<span class="st">"role"</span>: <span class="st">"system"</span>, <span class="st">"content"</span>: _SYSTEM_MSG}</span>
<span id="annotated-cell-9-42"><a href="#annotated-cell-9-42" aria-hidden="true" tabindex="-1"></a>_WELCOME <span class="op">=</span> {<span class="st">"role"</span>: <span class="st">"assistant"</span>, <span class="st">"content"</span>: WELCOME_MSG}</span>
<span id="annotated-cell-9-43"><a href="#annotated-cell-9-43" aria-hidden="true" tabindex="-1"></a>stream <span class="op">=</span> [_SYS, _WELCOME]</span>
<span id="annotated-cell-9-44"><a href="#annotated-cell-9-44" aria-hidden="true" tabindex="-1"></a></span>
<span id="annotated-cell-9-45"><a href="#annotated-cell-9-45" aria-hidden="true" tabindex="-1"></a><span class="co"># Shiny User Interface ----------------------------------------------------</span></span>
<span id="annotated-cell-9-46"><a href="#annotated-cell-9-46" aria-hidden="true" tabindex="-1"></a></span>
<span id="annotated-cell-9-47"><a href="#annotated-cell-9-47" aria-hidden="true" tabindex="-1"></a></span>
<span id="annotated-cell-9-48"><a href="#annotated-cell-9-48" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> input_text_with_button(<span class="bu">id</span>, label, button_label, placeholder<span class="op">=</span><span class="st">""</span>):</span>
<span id="annotated-cell-9-49"><a href="#annotated-cell-9-49" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="annotated-cell-9-50"><a href="#annotated-cell-9-50" aria-hidden="true" tabindex="-1"></a><span class="co">    An interface component combining an input text widget with an action</span></span>
<span id="annotated-cell-9-51"><a href="#annotated-cell-9-51" aria-hidden="true" tabindex="-1"></a><span class="co">    button. IDs for the text field and button can be accessed as &lt;id&gt;_text</span></span>
<span id="annotated-cell-9-52"><a href="#annotated-cell-9-52" aria-hidden="true" tabindex="-1"></a><span class="co">    and &lt;id&gt;_btn respectively.</span></span>
<span id="annotated-cell-9-53"><a href="#annotated-cell-9-53" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="annotated-cell-9-54"><a href="#annotated-cell-9-54" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> ui.div(</span>
<span id="annotated-cell-9-55"><a href="#annotated-cell-9-55" aria-hidden="true" tabindex="-1"></a>        ui.input_text(</span>
<span id="annotated-cell-9-56"><a href="#annotated-cell-9-56" aria-hidden="true" tabindex="-1"></a>            <span class="bu">id</span><span class="op">=</span><span class="ss">f"</span><span class="sc">{</span><span class="bu">id</span><span class="sc">}</span><span class="ss">_text"</span>, label<span class="op">=</span>label, placeholder<span class="op">=</span>placeholder),</span>
<span id="annotated-cell-9-57"><a href="#annotated-cell-9-57" aria-hidden="true" tabindex="-1"></a>        ui.input_action_button(</span>
<span id="annotated-cell-9-58"><a href="#annotated-cell-9-58" aria-hidden="true" tabindex="-1"></a>            <span class="bu">id</span><span class="op">=</span><span class="ss">f"</span><span class="sc">{</span><span class="bu">id</span><span class="sc">}</span><span class="ss">_btn"</span>,</span>
<span id="annotated-cell-9-59"><a href="#annotated-cell-9-59" aria-hidden="true" tabindex="-1"></a>            label<span class="op">=</span>button_label,</span>
<span id="annotated-cell-9-60"><a href="#annotated-cell-9-60" aria-hidden="true" tabindex="-1"></a>            style<span class="op">=</span><span class="st">"margin-top:28px;margin-bottom:16px;color:#04bb8c;border-color:#04bb8c;"</span></span>
<span id="annotated-cell-9-61"><a href="#annotated-cell-9-61" aria-hidden="true" tabindex="-1"></a>            ),</span>
<span id="annotated-cell-9-62"><a href="#annotated-cell-9-62" aria-hidden="true" tabindex="-1"></a>        class_<span class="op">=</span><span class="st">"d-flex gap-2"</span></span>
<span id="annotated-cell-9-63"><a href="#annotated-cell-9-63" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="annotated-cell-9-64"><a href="#annotated-cell-9-64" aria-hidden="true" tabindex="-1"></a></span>
<span id="annotated-cell-9-65"><a href="#annotated-cell-9-65" aria-hidden="true" tabindex="-1"></a></span>
<span id="annotated-cell-9-66"><a href="#annotated-cell-9-66" aria-hidden="true" tabindex="-1"></a>app_ui <span class="op">=</span> ui.page_fillable(</span>
<span id="annotated-cell-9-67"><a href="#annotated-cell-9-67" aria-hidden="true" tabindex="-1"></a>    ui.panel_title(<span class="st">"Choose Your Own Adventure: Jungle Quest!"</span>),</span>
<span id="annotated-cell-9-68"><a href="#annotated-cell-9-68" aria-hidden="true" tabindex="-1"></a>    ui.accordion(</span>
<span id="annotated-cell-9-69"><a href="#annotated-cell-9-69" aria-hidden="true" tabindex="-1"></a>    ui.accordion_panel(<span class="st">"Step 1: Your OpenAI API Key"</span>,</span>
<span id="annotated-cell-9-70"><a href="#annotated-cell-9-70" aria-hidden="true" tabindex="-1"></a>        input_text_with_button(</span>
<span id="annotated-cell-9-71"><a href="#annotated-cell-9-71" aria-hidden="true" tabindex="-1"></a>            <span class="bu">id</span><span class="op">=</span><span class="st">"key_input"</span>,</span>
<span id="annotated-cell-9-72"><a href="#annotated-cell-9-72" aria-hidden="true" tabindex="-1"></a>            label<span class="op">=</span><span class="st">"Enter your OpenAI API key"</span>,</span>
<span id="annotated-cell-9-73"><a href="#annotated-cell-9-73" aria-hidden="true" tabindex="-1"></a>            button_label<span class="op">=</span><span class="st">"Submit"</span>,</span>
<span id="annotated-cell-9-74"><a href="#annotated-cell-9-74" aria-hidden="true" tabindex="-1"></a>            placeholder<span class="op">=</span><span class="st">"Enter key here"</span></span>
<span id="annotated-cell-9-75"><a href="#annotated-cell-9-75" aria-hidden="true" tabindex="-1"></a>            )), <span class="bu">id</span><span class="op">=</span><span class="st">"acc"</span>, multiple<span class="op">=</span><span class="va">False</span>),</span>
<span id="annotated-cell-9-76"><a href="#annotated-cell-9-76" aria-hidden="true" tabindex="-1"></a>ui.h6(<span class="st">"Step 2: Choose your adventure"</span>),</span>
<span id="annotated-cell-9-77"><a href="#annotated-cell-9-77" aria-hidden="true" tabindex="-1"></a>    ui.chat_ui(<span class="bu">id</span><span class="op">=</span><span class="st">"chat"</span>),</span>
<span id="annotated-cell-9-78"><a href="#annotated-cell-9-78" aria-hidden="true" tabindex="-1"></a>    fillable_mobile<span class="op">=</span><span class="va">True</span>,</span>
<span id="annotated-cell-9-79"><a href="#annotated-cell-9-79" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="annotated-cell-9-80"><a href="#annotated-cell-9-80" aria-hidden="true" tabindex="-1"></a></span>
<span id="annotated-cell-9-81"><a href="#annotated-cell-9-81" aria-hidden="true" tabindex="-1"></a><span class="co"># Shiny server logic ------------------------------------------------------</span></span>
<span id="annotated-cell-9-82"><a href="#annotated-cell-9-82" aria-hidden="true" tabindex="-1"></a></span>
<span id="annotated-cell-9-83"><a href="#annotated-cell-9-83" aria-hidden="true" tabindex="-1"></a></span>
<span id="annotated-cell-9-84"><a href="#annotated-cell-9-84" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> server(<span class="bu">input</span>, output, session):</span>
<span id="annotated-cell-9-85"><a href="#annotated-cell-9-85" aria-hidden="true" tabindex="-1"></a>    chat <span class="op">=</span> ui.Chat(</span>
<span id="annotated-cell-9-86"><a href="#annotated-cell-9-86" aria-hidden="true" tabindex="-1"></a>        <span class="bu">id</span><span class="op">=</span><span class="st">"chat"</span>, messages<span class="op">=</span>[ui.markdown(WELCOME_MSG)], tokenizer<span class="op">=</span><span class="va">None</span></span>
<span id="annotated-cell-9-87"><a href="#annotated-cell-9-87" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="annotated-cell-9-88"><a href="#annotated-cell-9-88" aria-hidden="true" tabindex="-1"></a></span>
<span id="annotated-cell-9-89"><a href="#annotated-cell-9-89" aria-hidden="true" tabindex="-1"></a></span>
<span id="annotated-cell-9-90"><a href="#annotated-cell-9-90" aria-hidden="true" tabindex="-1"></a>    <span class="at">@reactive.Effect</span></span>
<span id="annotated-cell-9-91"><a href="#annotated-cell-9-91" aria-hidden="true" tabindex="-1"></a>    <span class="at">@reactive.event</span>(<span class="bu">input</span>.key_input_btn)</span>
<span id="annotated-cell-9-92"><a href="#annotated-cell-9-92" aria-hidden="true" tabindex="-1"></a>    <span class="cf">async</span> <span class="kw">def</span> handle_api_key_submit():</span>
<span id="annotated-cell-9-93"><a href="#annotated-cell-9-93" aria-hidden="true" tabindex="-1"></a>        <span class="co">"""Update the UI with a notification when user submits key.</span></span>
<span id="annotated-cell-9-94"><a href="#annotated-cell-9-94" aria-hidden="true" tabindex="-1"></a><span class="co">        </span></span>
<span id="annotated-cell-9-95"><a href="#annotated-cell-9-95" aria-hidden="true" tabindex="-1"></a><span class="co">        Checks the validity of the API key by querying the models list</span></span>
<span id="annotated-cell-9-96"><a href="#annotated-cell-9-96" aria-hidden="true" tabindex="-1"></a><span class="co">        endpoint."""</span></span>
<span id="annotated-cell-9-97"><a href="#annotated-cell-9-97" aria-hidden="true" tabindex="-1"></a>        api_key <span class="op">=</span> <span class="bu">input</span>.key_input_text()</span>
<span id="annotated-cell-9-98"><a href="#annotated-cell-9-98" aria-hidden="true" tabindex="-1"></a>        client <span class="op">=</span> openai.AsyncOpenAI(api_key<span class="op">=</span>api_key)</span>
<span id="annotated-cell-9-99"><a href="#annotated-cell-9-99" aria-hidden="true" tabindex="-1"></a>        <span class="cf">try</span>:</span>
<span id="annotated-cell-9-100"><a href="#annotated-cell-9-100" aria-hidden="true" tabindex="-1"></a>            resp <span class="op">=</span> <span class="cf">await</span> client.models.<span class="bu">list</span>()</span>
<span id="annotated-cell-9-101"><a href="#annotated-cell-9-101" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> resp:</span>
<span id="annotated-cell-9-102"><a href="#annotated-cell-9-102" aria-hidden="true" tabindex="-1"></a>                ui.notification_show(</span>
<span id="annotated-cell-9-103"><a href="#annotated-cell-9-103" aria-hidden="true" tabindex="-1"></a>                    <span class="ss">f"API key validated: </span><span class="sc">{</span>api_key[:<span class="dv">5</span>]<span class="sc">}</span><span class="ss">..."</span>)</span>
<span id="annotated-cell-9-104"><a href="#annotated-cell-9-104" aria-hidden="true" tabindex="-1"></a>        <span class="cf">except</span> openai.AuthenticationError <span class="im">as</span> e:</span>
<span id="annotated-cell-9-105"><a href="#annotated-cell-9-105" aria-hidden="true" tabindex="-1"></a>            ui.notification_show(</span>
<span id="annotated-cell-9-106"><a href="#annotated-cell-9-106" aria-hidden="true" tabindex="-1"></a>                <span class="st">"Bad key provided. Please try again."</span>, <span class="bu">type</span><span class="op">=</span><span class="st">"warning"</span>)</span>
<span id="annotated-cell-9-107"><a href="#annotated-cell-9-107" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="annotated-cell-9-108"><a href="#annotated-cell-9-108" aria-hidden="true" tabindex="-1"></a></span>
<button class="code-annotation-anchor" data-target-cell="annotated-cell-9" data-target-annotation="1">1</button><span id="annotated-cell-9-109" class="code-annotation-target"><a href="#annotated-cell-9-109" aria-hidden="true" tabindex="-1"></a>    <span class="cf">async</span> <span class="kw">def</span> check_moderation(prompt:<span class="bu">str</span>) <span class="op">-&gt;</span> <span class="bu">str</span>:</span>
<span id="annotated-cell-9-110"><a href="#annotated-cell-9-110" aria-hidden="true" tabindex="-1"></a>        <span class="co">"""Check if prompt is flagged by OpenAI's moderation endpoint.</span></span>
<span id="annotated-cell-9-111"><a href="#annotated-cell-9-111" aria-hidden="true" tabindex="-1"></a></span>
<span id="annotated-cell-9-112"><a href="#annotated-cell-9-112" aria-hidden="true" tabindex="-1"></a><span class="co">        Parameters</span></span>
<span id="annotated-cell-9-113"><a href="#annotated-cell-9-113" aria-hidden="true" tabindex="-1"></a><span class="co">        ----------</span></span>
<span id="annotated-cell-9-114"><a href="#annotated-cell-9-114" aria-hidden="true" tabindex="-1"></a><span class="co">        prompt : str</span></span>
<span id="annotated-cell-9-115"><a href="#annotated-cell-9-115" aria-hidden="true" tabindex="-1"></a><span class="co">            The user's prompt to check.</span></span>
<span id="annotated-cell-9-116"><a href="#annotated-cell-9-116" aria-hidden="true" tabindex="-1"></a></span>
<span id="annotated-cell-9-117"><a href="#annotated-cell-9-117" aria-hidden="true" tabindex="-1"></a><span class="co">        Returns</span></span>
<span id="annotated-cell-9-118"><a href="#annotated-cell-9-118" aria-hidden="true" tabindex="-1"></a><span class="co">        -------</span></span>
<span id="annotated-cell-9-119"><a href="#annotated-cell-9-119" aria-hidden="true" tabindex="-1"></a><span class="co">        str</span></span>
<span id="annotated-cell-9-120"><a href="#annotated-cell-9-120" aria-hidden="true" tabindex="-1"></a><span class="co">            The category violations if flagged, otherwise "good prompt".</span></span>
<span id="annotated-cell-9-121"><a href="#annotated-cell-9-121" aria-hidden="true" tabindex="-1"></a><span class="co">        """</span></span>
<button class="code-annotation-anchor" data-target-cell="annotated-cell-9" data-target-annotation="2">2</button><span id="annotated-cell-9-122" class="code-annotation-target"><a href="#annotated-cell-9-122" aria-hidden="true" tabindex="-1"></a>        client <span class="op">=</span> openai.AsyncOpenAI(api_key<span class="op">=</span><span class="bu">input</span>.key_input_text())</span>
<span id="annotated-cell-9-123"><a href="#annotated-cell-9-123" aria-hidden="true" tabindex="-1"></a>        response <span class="op">=</span> <span class="cf">await</span> client.moderations.create(</span>
<span id="annotated-cell-9-124"><a href="#annotated-cell-9-124" aria-hidden="true" tabindex="-1"></a>            <span class="bu">input</span><span class="op">=</span>prompt)</span>
<span id="annotated-cell-9-125"><a href="#annotated-cell-9-125" aria-hidden="true" tabindex="-1"></a>        content <span class="op">=</span> response.results[<span class="dv">0</span>].to_dict()</span>
<button class="code-annotation-anchor" data-target-cell="annotated-cell-9" data-target-annotation="3">3</button><span id="annotated-cell-9-126" class="code-annotation-target"><a href="#annotated-cell-9-126" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> content[<span class="st">"flagged"</span>]:</span>
<span id="annotated-cell-9-127"><a href="#annotated-cell-9-127" aria-hidden="true" tabindex="-1"></a>            infringements <span class="op">=</span> []</span>
<span id="annotated-cell-9-128"><a href="#annotated-cell-9-128" aria-hidden="true" tabindex="-1"></a>            <span class="cf">for</span> key, val <span class="kw">in</span> content[<span class="st">"categories"</span>].items():</span>
<span id="annotated-cell-9-129"><a href="#annotated-cell-9-129" aria-hidden="true" tabindex="-1"></a>                <span class="cf">if</span> val:</span>
<span id="annotated-cell-9-130"><a href="#annotated-cell-9-130" aria-hidden="true" tabindex="-1"></a>                    infringements.append(key)</span>
<button class="code-annotation-anchor" data-target-cell="annotated-cell-9" data-target-annotation="4">4</button><span id="annotated-cell-9-131" class="code-annotation-target"><a href="#annotated-cell-9-131" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span> <span class="st">" &amp; "</span>.join(infringements)</span>
<span id="annotated-cell-9-132"><a href="#annotated-cell-9-132" aria-hidden="true" tabindex="-1"></a>        <span class="cf">else</span>:</span>
<button class="code-annotation-anchor" data-target-cell="annotated-cell-9" data-target-annotation="5">5</button><span id="annotated-cell-9-133" class="code-annotation-target"><a href="#annotated-cell-9-133" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span> <span class="st">"good prompt"</span></span>
<span id="annotated-cell-9-134"><a href="#annotated-cell-9-134" aria-hidden="true" tabindex="-1"></a></span>
<span id="annotated-cell-9-135"><a href="#annotated-cell-9-135" aria-hidden="true" tabindex="-1"></a></span>
<span id="annotated-cell-9-136"><a href="#annotated-cell-9-136" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Define a callback to run when the user submits a message</span></span>
<span id="annotated-cell-9-137"><a href="#annotated-cell-9-137" aria-hidden="true" tabindex="-1"></a>    <span class="at">@chat.on_user_submit</span></span>
<span id="annotated-cell-9-138"><a href="#annotated-cell-9-138" aria-hidden="true" tabindex="-1"></a>    <span class="cf">async</span> <span class="kw">def</span> respond():</span>
<span id="annotated-cell-9-139"><a href="#annotated-cell-9-139" aria-hidden="true" tabindex="-1"></a>        <span class="co">"""Respond to the user's message."""</span></span>
<span id="annotated-cell-9-140"><a href="#annotated-cell-9-140" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Get the user's input</span></span>
<span id="annotated-cell-9-141"><a href="#annotated-cell-9-141" aria-hidden="true" tabindex="-1"></a>        usr_prompt <span class="op">=</span> chat.user_input()</span>
<span id="annotated-cell-9-142"><a href="#annotated-cell-9-142" aria-hidden="true" tabindex="-1"></a></span>
<span id="annotated-cell-9-143"><a href="#annotated-cell-9-143" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Check moderations endpoint incase openai policies are violated</span></span>
<span id="annotated-cell-9-144"><a href="#annotated-cell-9-144" aria-hidden="true" tabindex="-1"></a>        flag_check <span class="op">=</span> <span class="cf">await</span> check_moderation(prompt<span class="op">=</span>usr_prompt)</span>
<button class="code-annotation-anchor" data-target-cell="annotated-cell-9" data-target-annotation="6">6</button><span id="annotated-cell-9-145" class="code-annotation-target"><a href="#annotated-cell-9-145" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> flag_check <span class="op">!=</span> <span class="st">"good prompt"</span>:</span>
<span id="annotated-cell-9-146"><a href="#annotated-cell-9-146" aria-hidden="true" tabindex="-1"></a>            <span class="cf">await</span> chat.append_message({</span>
<span id="annotated-cell-9-147"><a href="#annotated-cell-9-147" aria-hidden="true" tabindex="-1"></a>                <span class="st">"role"</span>: <span class="st">"assistant"</span>,</span>
<span id="annotated-cell-9-148"><a href="#annotated-cell-9-148" aria-hidden="true" tabindex="-1"></a>                <span class="st">"content"</span>: <span class="ss">f"Your message may violate OpenAI's usage policy, categories: </span><span class="sc">{</span>flag_check<span class="sc">}</span><span class="ss">. Please rephrase your input and try again."</span></span>
<span id="annotated-cell-9-149"><a href="#annotated-cell-9-149" aria-hidden="true" tabindex="-1"></a>            })</span>
<span id="annotated-cell-9-150"><a href="#annotated-cell-9-150" aria-hidden="true" tabindex="-1"></a>        <span class="cf">else</span>:</span>
<span id="annotated-cell-9-151"><a href="#annotated-cell-9-151" aria-hidden="true" tabindex="-1"></a>            <span class="co">#  update the stream list</span></span>
<span id="annotated-cell-9-152"><a href="#annotated-cell-9-152" aria-hidden="true" tabindex="-1"></a>            stream.append({<span class="st">"role"</span>: <span class="st">"user"</span>, <span class="st">"content"</span>: usr_prompt})</span>
<span id="annotated-cell-9-153"><a href="#annotated-cell-9-153" aria-hidden="true" tabindex="-1"></a>            <span class="co"># Append a response to the chat</span></span>
<span id="annotated-cell-9-154"><a href="#annotated-cell-9-154" aria-hidden="true" tabindex="-1"></a>            client <span class="op">=</span> openai.AsyncOpenAI(api_key<span class="op">=</span><span class="bu">input</span>.key_input_text())</span>
<span id="annotated-cell-9-155"><a href="#annotated-cell-9-155" aria-hidden="true" tabindex="-1"></a>            response <span class="op">=</span> <span class="cf">await</span> client.chat.completions.create(</span>
<span id="annotated-cell-9-156"><a href="#annotated-cell-9-156" aria-hidden="true" tabindex="-1"></a>                model<span class="op">=</span><span class="st">"gpt-3.5-turbo"</span>,</span>
<span id="annotated-cell-9-157"><a href="#annotated-cell-9-157" aria-hidden="true" tabindex="-1"></a>                messages<span class="op">=</span>stream,</span>
<span id="annotated-cell-9-158"><a href="#annotated-cell-9-158" aria-hidden="true" tabindex="-1"></a>                temperature<span class="op">=</span><span class="fl">0.7</span>, <span class="co"># increase to make the model more creative</span></span>
<span id="annotated-cell-9-159"><a href="#annotated-cell-9-159" aria-hidden="true" tabindex="-1"></a>                )</span>
<span id="annotated-cell-9-160"><a href="#annotated-cell-9-160" aria-hidden="true" tabindex="-1"></a>            model_response <span class="op">=</span> response.choices[<span class="dv">0</span>].message.content</span>
<span id="annotated-cell-9-161"><a href="#annotated-cell-9-161" aria-hidden="true" tabindex="-1"></a>            <span class="cf">await</span> chat.append_message(model_response)</span>
<span id="annotated-cell-9-162"><a href="#annotated-cell-9-162" aria-hidden="true" tabindex="-1"></a>            <span class="co">#  if the model indicates game over, end game with a message.</span></span>
<span id="annotated-cell-9-163"><a href="#annotated-cell-9-163" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> <span class="st">"the end..."</span> <span class="kw">in</span> model_response.lower():</span>
<span id="annotated-cell-9-164"><a href="#annotated-cell-9-164" aria-hidden="true" tabindex="-1"></a>                <span class="cf">await</span> chat.append_message(</span>
<span id="annotated-cell-9-165"><a href="#annotated-cell-9-165" aria-hidden="true" tabindex="-1"></a>                    {</span>
<span id="annotated-cell-9-166"><a href="#annotated-cell-9-166" aria-hidden="true" tabindex="-1"></a>                        <span class="st">"role"</span>: <span class="st">"assistant"</span>,</span>
<span id="annotated-cell-9-167"><a href="#annotated-cell-9-167" aria-hidden="true" tabindex="-1"></a>                        <span class="st">"content"</span>: <span class="st">"Game Over! Refresh to play again."</span></span>
<span id="annotated-cell-9-168"><a href="#annotated-cell-9-168" aria-hidden="true" tabindex="-1"></a>                        })</span>
<span id="annotated-cell-9-169"><a href="#annotated-cell-9-169" aria-hidden="true" tabindex="-1"></a>                exit()</span>
<span id="annotated-cell-9-170"><a href="#annotated-cell-9-170" aria-hidden="true" tabindex="-1"></a>            <span class="cf">else</span>:</span>
<span id="annotated-cell-9-171"><a href="#annotated-cell-9-171" aria-hidden="true" tabindex="-1"></a>                stream.append(</span>
<span id="annotated-cell-9-172"><a href="#annotated-cell-9-172" aria-hidden="true" tabindex="-1"></a>                    {<span class="st">"role"</span>: <span class="st">"assistant"</span>, <span class="st">"content"</span>: model_response})</span>
<span id="annotated-cell-9-173"><a href="#annotated-cell-9-173" aria-hidden="true" tabindex="-1"></a></span>
<span id="annotated-cell-9-174"><a href="#annotated-cell-9-174" aria-hidden="true" tabindex="-1"></a></span>
<span id="annotated-cell-9-175"><a href="#annotated-cell-9-175" aria-hidden="true" tabindex="-1"></a>app <span class="op">=</span> App(ui<span class="op">=</span>app_ui, server<span class="op">=</span>server)</span><div class="code-annotation-gutter-bg"></div><div class="code-annotation-gutter"></div></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<dl class="code-annotation-container-hidden code-annotation-container-grid">
<dt data-target-cell="annotated-cell-9" data-target-annotation="1">1</dt>
<dd>
<span data-code-cell="annotated-cell-9" data-code-lines="109" data-code-annotation="1">We define a new function that will query the OpenAI moderations endpoint.</span>
</dd>
<dt data-target-cell="annotated-cell-9" data-target-annotation="2">2</dt>
<dd>
<span data-code-cell="annotated-cell-9" data-code-lines="122" data-code-annotation="2">Notice that we create a third openai client in order to handle the communication with the service. In the next iteration we will refactor this.</span>
</dd>
<dt data-target-cell="annotated-cell-9" data-target-annotation="3">3</dt>
<dd>
<span data-code-cell="annotated-cell-9" data-code-lines="126" data-code-annotation="3">If the prompt has violated any category, then the value of the <code>flagged</code> key will be <code>True</code>.</span>
</dd>
<dt data-target-cell="annotated-cell-9" data-target-annotation="4">4</dt>
<dd>
<span data-code-cell="annotated-cell-9" data-code-lines="131" data-code-annotation="4">In cases where multiple categories are violated, we will include each breached category in a message to the user.</span>
</dd>
<dt data-target-cell="annotated-cell-9" data-target-annotation="5">5</dt>
<dd>
<span data-code-cell="annotated-cell-9" data-code-lines="133" data-code-annotation="5">The return value in the case of a prompt that passes the moderation check.</span>
</dd>
<dt data-target-cell="annotated-cell-9" data-target-annotation="6">6</dt>
<dd>
<span data-code-cell="annotated-cell-9" data-code-lines="145,146,147,148,149" data-code-annotation="6">We implement some control flow to only query the chat.completions endpoint if the moderations check passes.</span>
</dd>
</dl>
<p>The updated process diagram clarifies the reactive flow of the app. Now prompts from the user pass through <code>check_moderations()</code> first. The outcome of check moderations is then passed along within the <code>respond()</code> function, determining whether the prompt would be passed along to the <code>chat.completions</code> endpoint.</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="https://i.imgur.com/h51HPSw.png" class="img-fluid figure-img"></p>
<figcaption>Process diagram for iteration 7</figcaption>
</figure>
</div>
<div class="callout callout-style-default callout-important callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Important
</div>
</div>
<div class="callout-body-container callout-body">
<p>I use a real OpenAI API key in these clips to demonstrate the application working. Note that I have since revoked this key and it will no longer work. You should not share your secret keys with anyone.</p>
</div>
</div>
<p>When using this iteration of the app, you can see that certain prompts may now be flagged as inappropriate. Note that this also reduces the performance of our app, as we need to send and process 2 queries for each prompt that the user enters.</p>
<iframe title="Iteration 7 recording" src="https://player.vimeo.com/video/1010112083?h=dc49a29e07" class="iframey" allowfullscreen="" style="overflow:hidden;margin:0;padding:0;width:100%;height:24rem;">
</iframe>
</div>
<div id="tabset-1-8" class="tab-pane" role="tabpanel" aria-labelledby="tabset-1-8-tab">
<p>We have nearly arrived at our final design. In this stage, we refactor the application to ensure we use a single openai client to query the seperate endpoints.</p>
<div class="code-with-filename">
<div class="code-with-filename-file">
<pre><strong>app.py</strong></pre>
</div>
<div class="sourceCode" id="annotated-cell-10" data-filename="app.py"><pre class="sourceCode python code-annotation-code code-with-copy code-annotated"><code class="sourceCode python"><span id="annotated-cell-10-1"><a href="#annotated-cell-10-1" aria-hidden="true" tabindex="-1"></a><span class="co">"""Iteration 8: Refactor OpenAI client instantiation."""</span></span>
<span id="annotated-cell-10-2"><a href="#annotated-cell-10-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> openai</span>
<span id="annotated-cell-10-3"><a href="#annotated-cell-10-3" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> shiny <span class="im">import</span> App, reactive, ui</span>
<span id="annotated-cell-10-4"><a href="#annotated-cell-10-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="annotated-cell-10-5"><a href="#annotated-cell-10-5" aria-hidden="true" tabindex="-1"></a>_SYSTEM_MSG <span class="op">=</span> <span class="st">"""</span></span>
<span id="annotated-cell-10-6"><a href="#annotated-cell-10-6" aria-hidden="true" tabindex="-1"></a><span class="st">You are the guide of a 'choose your own adventure'- style game: a mystical</span></span>
<span id="annotated-cell-10-7"><a href="#annotated-cell-10-7" aria-hidden="true" tabindex="-1"></a><span class="st">journey through the Amazon Rainforest. Your job is to create compelling</span></span>
<span id="annotated-cell-10-8"><a href="#annotated-cell-10-8" aria-hidden="true" tabindex="-1"></a><span class="st">outcomes that correspond with the player's choices. You must navigate the</span></span>
<span id="annotated-cell-10-9"><a href="#annotated-cell-10-9" aria-hidden="true" tabindex="-1"></a><span class="st">player through challenges, providing choices, and consequences, dynamically</span></span>
<span id="annotated-cell-10-10"><a href="#annotated-cell-10-10" aria-hidden="true" tabindex="-1"></a><span class="st">adapting the tale based on the player's inputs. Your goal is to create a</span></span>
<span id="annotated-cell-10-11"><a href="#annotated-cell-10-11" aria-hidden="true" tabindex="-1"></a><span class="st">branching narrative experience where each of the player's choices leads to</span></span>
<span id="annotated-cell-10-12"><a href="#annotated-cell-10-12" aria-hidden="true" tabindex="-1"></a><span class="st">a new path, ultimately determining their fate. The player's goal is to find</span></span>
<span id="annotated-cell-10-13"><a href="#annotated-cell-10-13" aria-hidden="true" tabindex="-1"></a><span class="st">the lost crown of Quetzalcoatl.</span></span>
<span id="annotated-cell-10-14"><a href="#annotated-cell-10-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="annotated-cell-10-15"><a href="#annotated-cell-10-15" aria-hidden="true" tabindex="-1"></a><span class="st">Here are some rules to follow:</span></span>
<span id="annotated-cell-10-16"><a href="#annotated-cell-10-16" aria-hidden="true" tabindex="-1"></a><span class="st">1. Always wait for the player to respond with their input before providing</span></span>
<span id="annotated-cell-10-17"><a href="#annotated-cell-10-17" aria-hidden="true" tabindex="-1"></a><span class="st">any choices. Never provide the player's input yourself. This is most</span></span>
<span id="annotated-cell-10-18"><a href="#annotated-cell-10-18" aria-hidden="true" tabindex="-1"></a><span class="st">important.</span></span>
<span id="annotated-cell-10-19"><a href="#annotated-cell-10-19" aria-hidden="true" tabindex="-1"></a><span class="st">2. Ask the player to provide a name, gender and race.</span></span>
<span id="annotated-cell-10-20"><a href="#annotated-cell-10-20" aria-hidden="true" tabindex="-1"></a><span class="st">3. Ask the player to choose from a selection of weapons that will be used</span></span>
<span id="annotated-cell-10-21"><a href="#annotated-cell-10-21" aria-hidden="true" tabindex="-1"></a><span class="st">later in the game.</span></span>
<span id="annotated-cell-10-22"><a href="#annotated-cell-10-22" aria-hidden="true" tabindex="-1"></a><span class="st">4. Have a few paths that lead to success. </span></span>
<span id="annotated-cell-10-23"><a href="#annotated-cell-10-23" aria-hidden="true" tabindex="-1"></a><span class="st">5. Have some paths that lead to death.</span></span>
<span id="annotated-cell-10-24"><a href="#annotated-cell-10-24" aria-hidden="true" tabindex="-1"></a><span class="st">6. Whether or not the game results in success or death, the response must</span></span>
<span id="annotated-cell-10-25"><a href="#annotated-cell-10-25" aria-hidden="true" tabindex="-1"></a><span class="st">include the text "The End...", I will search for this text to end the game.</span></span>
<span id="annotated-cell-10-26"><a href="#annotated-cell-10-26" aria-hidden="true" tabindex="-1"></a><span class="st">"""</span></span>
<span id="annotated-cell-10-27"><a href="#annotated-cell-10-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="annotated-cell-10-28"><a href="#annotated-cell-10-28" aria-hidden="true" tabindex="-1"></a>WELCOME_MSG <span class="op">=</span> <span class="st">"""</span></span>
<span id="annotated-cell-10-29"><a href="#annotated-cell-10-29" aria-hidden="true" tabindex="-1"></a><span class="st">Welcome to the Amazon Rainforest, adventurer! Your mission is to find the</span></span>
<span id="annotated-cell-10-30"><a href="#annotated-cell-10-30" aria-hidden="true" tabindex="-1"></a><span class="st">lost Crown of Quetzalcoatl.</span></span>
<span id="annotated-cell-10-31"><a href="#annotated-cell-10-31" aria-hidden="true" tabindex="-1"></a><span class="st">However, many challenges stand in your way. Are you brave enough, strong</span></span>
<span id="annotated-cell-10-32"><a href="#annotated-cell-10-32" aria-hidden="true" tabindex="-1"></a><span class="st">enough and clever enough to overcome the perils of the jungle and secure</span></span>
<span id="annotated-cell-10-33"><a href="#annotated-cell-10-33" aria-hidden="true" tabindex="-1"></a><span class="st">the crown?</span></span>
<span id="annotated-cell-10-34"><a href="#annotated-cell-10-34" aria-hidden="true" tabindex="-1"></a></span>
<span id="annotated-cell-10-35"><a href="#annotated-cell-10-35" aria-hidden="true" tabindex="-1"></a><span class="st">Before we begin our journey, choose your name, gender and race. Choose a</span></span>
<span id="annotated-cell-10-36"><a href="#annotated-cell-10-36" aria-hidden="true" tabindex="-1"></a><span class="st">weapon to bring with you. Choose wisely, as the way ahead is filled with</span></span>
<span id="annotated-cell-10-37"><a href="#annotated-cell-10-37" aria-hidden="true" tabindex="-1"></a><span class="st">many dangers.</span></span>
<span id="annotated-cell-10-38"><a href="#annotated-cell-10-38" aria-hidden="true" tabindex="-1"></a><span class="st">"""</span></span>
<span id="annotated-cell-10-39"><a href="#annotated-cell-10-39" aria-hidden="true" tabindex="-1"></a></span>
<span id="annotated-cell-10-40"><a href="#annotated-cell-10-40" aria-hidden="true" tabindex="-1"></a><span class="co"># compose a message stream</span></span>
<span id="annotated-cell-10-41"><a href="#annotated-cell-10-41" aria-hidden="true" tabindex="-1"></a>_SYS <span class="op">=</span> {<span class="st">"role"</span>: <span class="st">"system"</span>, <span class="st">"content"</span>: _SYSTEM_MSG}</span>
<span id="annotated-cell-10-42"><a href="#annotated-cell-10-42" aria-hidden="true" tabindex="-1"></a>_WELCOME <span class="op">=</span> {<span class="st">"role"</span>: <span class="st">"assistant"</span>, <span class="st">"content"</span>: WELCOME_MSG}</span>
<span id="annotated-cell-10-43"><a href="#annotated-cell-10-43" aria-hidden="true" tabindex="-1"></a>stream <span class="op">=</span> [_SYS, _WELCOME]</span>
<span id="annotated-cell-10-44"><a href="#annotated-cell-10-44" aria-hidden="true" tabindex="-1"></a></span>
<span id="annotated-cell-10-45"><a href="#annotated-cell-10-45" aria-hidden="true" tabindex="-1"></a><span class="co"># Shiny User Interface ----------------------------------------------------</span></span>
<span id="annotated-cell-10-46"><a href="#annotated-cell-10-46" aria-hidden="true" tabindex="-1"></a></span>
<span id="annotated-cell-10-47"><a href="#annotated-cell-10-47" aria-hidden="true" tabindex="-1"></a></span>
<span id="annotated-cell-10-48"><a href="#annotated-cell-10-48" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> input_text_with_button(<span class="bu">id</span>, label, button_label, placeholder<span class="op">=</span><span class="st">""</span>):</span>
<span id="annotated-cell-10-49"><a href="#annotated-cell-10-49" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="annotated-cell-10-50"><a href="#annotated-cell-10-50" aria-hidden="true" tabindex="-1"></a><span class="co">    An interface component combining an input text widget with an action</span></span>
<span id="annotated-cell-10-51"><a href="#annotated-cell-10-51" aria-hidden="true" tabindex="-1"></a><span class="co">    button. IDs for the text field and button can be accessed as &lt;id&gt;_text</span></span>
<span id="annotated-cell-10-52"><a href="#annotated-cell-10-52" aria-hidden="true" tabindex="-1"></a><span class="co">    and &lt;id&gt;_btn respectively.</span></span>
<span id="annotated-cell-10-53"><a href="#annotated-cell-10-53" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="annotated-cell-10-54"><a href="#annotated-cell-10-54" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> ui.div(</span>
<span id="annotated-cell-10-55"><a href="#annotated-cell-10-55" aria-hidden="true" tabindex="-1"></a>        ui.input_text(</span>
<span id="annotated-cell-10-56"><a href="#annotated-cell-10-56" aria-hidden="true" tabindex="-1"></a>            <span class="bu">id</span><span class="op">=</span><span class="ss">f"</span><span class="sc">{</span><span class="bu">id</span><span class="sc">}</span><span class="ss">_text"</span>, label<span class="op">=</span>label, placeholder<span class="op">=</span>placeholder),</span>
<span id="annotated-cell-10-57"><a href="#annotated-cell-10-57" aria-hidden="true" tabindex="-1"></a>        ui.input_action_button(</span>
<span id="annotated-cell-10-58"><a href="#annotated-cell-10-58" aria-hidden="true" tabindex="-1"></a>            <span class="bu">id</span><span class="op">=</span><span class="ss">f"</span><span class="sc">{</span><span class="bu">id</span><span class="sc">}</span><span class="ss">_btn"</span>,</span>
<span id="annotated-cell-10-59"><a href="#annotated-cell-10-59" aria-hidden="true" tabindex="-1"></a>            label<span class="op">=</span>button_label,</span>
<span id="annotated-cell-10-60"><a href="#annotated-cell-10-60" aria-hidden="true" tabindex="-1"></a>            style<span class="op">=</span><span class="st">"margin-top:28px;margin-bottom:16px;color:#04bb8c;border-color:#04bb8c;"</span></span>
<span id="annotated-cell-10-61"><a href="#annotated-cell-10-61" aria-hidden="true" tabindex="-1"></a>            ),</span>
<span id="annotated-cell-10-62"><a href="#annotated-cell-10-62" aria-hidden="true" tabindex="-1"></a>        class_<span class="op">=</span><span class="st">"d-flex gap-2"</span></span>
<span id="annotated-cell-10-63"><a href="#annotated-cell-10-63" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="annotated-cell-10-64"><a href="#annotated-cell-10-64" aria-hidden="true" tabindex="-1"></a></span>
<span id="annotated-cell-10-65"><a href="#annotated-cell-10-65" aria-hidden="true" tabindex="-1"></a></span>
<span id="annotated-cell-10-66"><a href="#annotated-cell-10-66" aria-hidden="true" tabindex="-1"></a>app_ui <span class="op">=</span> ui.page_fillable(</span>
<span id="annotated-cell-10-67"><a href="#annotated-cell-10-67" aria-hidden="true" tabindex="-1"></a>    ui.panel_title(<span class="st">"Choose Your Own Adventure: Jungle Quest!"</span>),</span>
<span id="annotated-cell-10-68"><a href="#annotated-cell-10-68" aria-hidden="true" tabindex="-1"></a>    ui.accordion(</span>
<span id="annotated-cell-10-69"><a href="#annotated-cell-10-69" aria-hidden="true" tabindex="-1"></a>    ui.accordion_panel(<span class="st">"Step 1: Your OpenAI API Key"</span>,</span>
<span id="annotated-cell-10-70"><a href="#annotated-cell-10-70" aria-hidden="true" tabindex="-1"></a>        input_text_with_button(</span>
<span id="annotated-cell-10-71"><a href="#annotated-cell-10-71" aria-hidden="true" tabindex="-1"></a>            <span class="bu">id</span><span class="op">=</span><span class="st">"key_input"</span>,</span>
<span id="annotated-cell-10-72"><a href="#annotated-cell-10-72" aria-hidden="true" tabindex="-1"></a>            label<span class="op">=</span><span class="st">"Enter your OpenAI API key"</span>,</span>
<span id="annotated-cell-10-73"><a href="#annotated-cell-10-73" aria-hidden="true" tabindex="-1"></a>            button_label<span class="op">=</span><span class="st">"Submit"</span>,</span>
<span id="annotated-cell-10-74"><a href="#annotated-cell-10-74" aria-hidden="true" tabindex="-1"></a>            placeholder<span class="op">=</span><span class="st">"Enter key here"</span></span>
<span id="annotated-cell-10-75"><a href="#annotated-cell-10-75" aria-hidden="true" tabindex="-1"></a>            )), <span class="bu">id</span><span class="op">=</span><span class="st">"acc"</span>, multiple<span class="op">=</span><span class="va">False</span>),</span>
<span id="annotated-cell-10-76"><a href="#annotated-cell-10-76" aria-hidden="true" tabindex="-1"></a>ui.h6(<span class="st">"Step 2: Choose your adventure"</span>),</span>
<span id="annotated-cell-10-77"><a href="#annotated-cell-10-77" aria-hidden="true" tabindex="-1"></a>    ui.chat_ui(<span class="bu">id</span><span class="op">=</span><span class="st">"chat"</span>),</span>
<span id="annotated-cell-10-78"><a href="#annotated-cell-10-78" aria-hidden="true" tabindex="-1"></a>    fillable_mobile<span class="op">=</span><span class="va">True</span>,</span>
<span id="annotated-cell-10-79"><a href="#annotated-cell-10-79" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="annotated-cell-10-80"><a href="#annotated-cell-10-80" aria-hidden="true" tabindex="-1"></a></span>
<span id="annotated-cell-10-81"><a href="#annotated-cell-10-81" aria-hidden="true" tabindex="-1"></a><span class="co"># Shiny server logic ------------------------------------------------------</span></span>
<span id="annotated-cell-10-82"><a href="#annotated-cell-10-82" aria-hidden="true" tabindex="-1"></a></span>
<span id="annotated-cell-10-83"><a href="#annotated-cell-10-83" aria-hidden="true" tabindex="-1"></a></span>
<span id="annotated-cell-10-84"><a href="#annotated-cell-10-84" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> server(<span class="bu">input</span>, output, session):</span>
<span id="annotated-cell-10-85"><a href="#annotated-cell-10-85" aria-hidden="true" tabindex="-1"></a>    chat <span class="op">=</span> ui.Chat(</span>
<span id="annotated-cell-10-86"><a href="#annotated-cell-10-86" aria-hidden="true" tabindex="-1"></a>        <span class="bu">id</span><span class="op">=</span><span class="st">"chat"</span>, messages<span class="op">=</span>[ui.markdown(WELCOME_MSG)], tokenizer<span class="op">=</span><span class="va">None</span></span>
<span id="annotated-cell-10-87"><a href="#annotated-cell-10-87" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="annotated-cell-10-88"><a href="#annotated-cell-10-88" aria-hidden="true" tabindex="-1"></a>    <span class="co">#  define a reactive value that will store the openai client</span></span>
<button class="code-annotation-anchor" data-target-cell="annotated-cell-10" data-target-annotation="1">1</button><span id="annotated-cell-10-89" class="code-annotation-target"><a href="#annotated-cell-10-89" aria-hidden="true" tabindex="-1"></a>    openai_client <span class="op">=</span> reactive.Value(<span class="va">None</span>)</span>
<span id="annotated-cell-10-90"><a href="#annotated-cell-10-90" aria-hidden="true" tabindex="-1"></a></span>
<span id="annotated-cell-10-91"><a href="#annotated-cell-10-91" aria-hidden="true" tabindex="-1"></a></span>
<span id="annotated-cell-10-92"><a href="#annotated-cell-10-92" aria-hidden="true" tabindex="-1"></a>    <span class="at">@reactive.Effect</span></span>
<span id="annotated-cell-10-93"><a href="#annotated-cell-10-93" aria-hidden="true" tabindex="-1"></a>    <span class="at">@reactive.event</span>(<span class="bu">input</span>.key_input_btn)</span>
<span id="annotated-cell-10-94"><a href="#annotated-cell-10-94" aria-hidden="true" tabindex="-1"></a>    <span class="cf">async</span> <span class="kw">def</span> handle_api_key_submit():</span>
<span id="annotated-cell-10-95"><a href="#annotated-cell-10-95" aria-hidden="true" tabindex="-1"></a>        <span class="co">"""Update the UI with a notification when user submits key.</span></span>
<span id="annotated-cell-10-96"><a href="#annotated-cell-10-96" aria-hidden="true" tabindex="-1"></a><span class="co">        </span></span>
<span id="annotated-cell-10-97"><a href="#annotated-cell-10-97" aria-hidden="true" tabindex="-1"></a><span class="co">        Checks the validity of the API key by querying the models list</span></span>
<span id="annotated-cell-10-98"><a href="#annotated-cell-10-98" aria-hidden="true" tabindex="-1"></a><span class="co">        endpoint."""</span></span>
<span id="annotated-cell-10-99"><a href="#annotated-cell-10-99" aria-hidden="true" tabindex="-1"></a>        api_key <span class="op">=</span> <span class="bu">input</span>.key_input_text()</span>
<span id="annotated-cell-10-100"><a href="#annotated-cell-10-100" aria-hidden="true" tabindex="-1"></a>        client <span class="op">=</span> openai.AsyncOpenAI(api_key<span class="op">=</span>api_key)</span>
<span id="annotated-cell-10-101"><a href="#annotated-cell-10-101" aria-hidden="true" tabindex="-1"></a>        <span class="cf">try</span>:</span>
<span id="annotated-cell-10-102"><a href="#annotated-cell-10-102" aria-hidden="true" tabindex="-1"></a>            resp <span class="op">=</span> <span class="cf">await</span> client.models.<span class="bu">list</span>()</span>
<span id="annotated-cell-10-103"><a href="#annotated-cell-10-103" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> resp:</span>
<button class="code-annotation-anchor" data-target-cell="annotated-cell-10" data-target-annotation="2">2</button><span id="annotated-cell-10-104" class="code-annotation-target"><a href="#annotated-cell-10-104" aria-hidden="true" tabindex="-1"></a>                openai_client.<span class="bu">set</span>(client)</span>
<span id="annotated-cell-10-105"><a href="#annotated-cell-10-105" aria-hidden="true" tabindex="-1"></a>                ui.notification_show(</span>
<span id="annotated-cell-10-106"><a href="#annotated-cell-10-106" aria-hidden="true" tabindex="-1"></a>                    <span class="ss">f"API key validated: </span><span class="sc">{</span>api_key[:<span class="dv">5</span>]<span class="sc">}</span><span class="ss">..."</span>)</span>
<span id="annotated-cell-10-107"><a href="#annotated-cell-10-107" aria-hidden="true" tabindex="-1"></a>        <span class="cf">except</span> openai.AuthenticationError <span class="im">as</span> e:</span>
<span id="annotated-cell-10-108"><a href="#annotated-cell-10-108" aria-hidden="true" tabindex="-1"></a>            ui.notification_show(</span>
<span id="annotated-cell-10-109"><a href="#annotated-cell-10-109" aria-hidden="true" tabindex="-1"></a>                <span class="st">"Bad key provided. Please try again."</span>, <span class="bu">type</span><span class="op">=</span><span class="st">"warning"</span>)</span>
<span id="annotated-cell-10-110"><a href="#annotated-cell-10-110" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="annotated-cell-10-111"><a href="#annotated-cell-10-111" aria-hidden="true" tabindex="-1"></a></span>
<span id="annotated-cell-10-112"><a href="#annotated-cell-10-112" aria-hidden="true" tabindex="-1"></a>    <span class="cf">async</span> <span class="kw">def</span> check_moderation(</span>
<span id="annotated-cell-10-113"><a href="#annotated-cell-10-113" aria-hidden="true" tabindex="-1"></a>            prompt:<span class="bu">str</span>, reactive_client:reactive.Value</span>
<span id="annotated-cell-10-114"><a href="#annotated-cell-10-114" aria-hidden="true" tabindex="-1"></a>            ) <span class="op">-&gt;</span> <span class="bu">str</span>:</span>
<span id="annotated-cell-10-115"><a href="#annotated-cell-10-115" aria-hidden="true" tabindex="-1"></a>        <span class="co">"""Check if prompt is flagged by OpenAI's moderation endpoint.</span></span>
<span id="annotated-cell-10-116"><a href="#annotated-cell-10-116" aria-hidden="true" tabindex="-1"></a></span>
<span id="annotated-cell-10-117"><a href="#annotated-cell-10-117" aria-hidden="true" tabindex="-1"></a><span class="co">        Parameters</span></span>
<span id="annotated-cell-10-118"><a href="#annotated-cell-10-118" aria-hidden="true" tabindex="-1"></a><span class="co">        ----------</span></span>
<span id="annotated-cell-10-119"><a href="#annotated-cell-10-119" aria-hidden="true" tabindex="-1"></a><span class="co">        prompt : str</span></span>
<span id="annotated-cell-10-120"><a href="#annotated-cell-10-120" aria-hidden="true" tabindex="-1"></a><span class="co">            The user's prompt to check.</span></span>
<span id="annotated-cell-10-121"><a href="#annotated-cell-10-121" aria-hidden="true" tabindex="-1"></a><span class="co">        reactive_client : reactive.Value</span></span>
<span id="annotated-cell-10-122"><a href="#annotated-cell-10-122" aria-hidden="true" tabindex="-1"></a><span class="co">            A reactive value that stores the openai client.</span></span>
<span id="annotated-cell-10-123"><a href="#annotated-cell-10-123" aria-hidden="true" tabindex="-1"></a></span>
<span id="annotated-cell-10-124"><a href="#annotated-cell-10-124" aria-hidden="true" tabindex="-1"></a><span class="co">        Returns</span></span>
<span id="annotated-cell-10-125"><a href="#annotated-cell-10-125" aria-hidden="true" tabindex="-1"></a><span class="co">        -------</span></span>
<span id="annotated-cell-10-126"><a href="#annotated-cell-10-126" aria-hidden="true" tabindex="-1"></a><span class="co">        str</span></span>
<span id="annotated-cell-10-127"><a href="#annotated-cell-10-127" aria-hidden="true" tabindex="-1"></a><span class="co">            The category violations if flagged, otherwise "good prompt".</span></span>
<span id="annotated-cell-10-128"><a href="#annotated-cell-10-128" aria-hidden="true" tabindex="-1"></a><span class="co">        """</span></span>
<span id="annotated-cell-10-129"><a href="#annotated-cell-10-129" aria-hidden="true" tabindex="-1"></a>        client <span class="op">=</span> reactive_client.get()</span>
<span id="annotated-cell-10-130"><a href="#annotated-cell-10-130" aria-hidden="true" tabindex="-1"></a>        response <span class="op">=</span> <span class="cf">await</span> client.moderations.create(</span>
<span id="annotated-cell-10-131"><a href="#annotated-cell-10-131" aria-hidden="true" tabindex="-1"></a>            <span class="bu">input</span><span class="op">=</span>prompt)</span>
<span id="annotated-cell-10-132"><a href="#annotated-cell-10-132" aria-hidden="true" tabindex="-1"></a>        content <span class="op">=</span> response.results[<span class="dv">0</span>].to_dict()</span>
<span id="annotated-cell-10-133"><a href="#annotated-cell-10-133" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> content[<span class="st">"flagged"</span>]:</span>
<span id="annotated-cell-10-134"><a href="#annotated-cell-10-134" aria-hidden="true" tabindex="-1"></a>            infringements <span class="op">=</span> []</span>
<span id="annotated-cell-10-135"><a href="#annotated-cell-10-135" aria-hidden="true" tabindex="-1"></a>            <span class="cf">for</span> key, val <span class="kw">in</span> content[<span class="st">"categories"</span>].items():</span>
<span id="annotated-cell-10-136"><a href="#annotated-cell-10-136" aria-hidden="true" tabindex="-1"></a>                <span class="cf">if</span> val:</span>
<span id="annotated-cell-10-137"><a href="#annotated-cell-10-137" aria-hidden="true" tabindex="-1"></a>                    infringements.append(key)</span>
<span id="annotated-cell-10-138"><a href="#annotated-cell-10-138" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span> <span class="st">" &amp; "</span>.join(infringements)</span>
<span id="annotated-cell-10-139"><a href="#annotated-cell-10-139" aria-hidden="true" tabindex="-1"></a>        <span class="cf">else</span>:</span>
<span id="annotated-cell-10-140"><a href="#annotated-cell-10-140" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span> <span class="st">"good prompt"</span></span>
<span id="annotated-cell-10-141"><a href="#annotated-cell-10-141" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="annotated-cell-10-142"><a href="#annotated-cell-10-142" aria-hidden="true" tabindex="-1"></a></span>
<span id="annotated-cell-10-143"><a href="#annotated-cell-10-143" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Define a callback to run when the user submits a message</span></span>
<span id="annotated-cell-10-144"><a href="#annotated-cell-10-144" aria-hidden="true" tabindex="-1"></a>    <span class="at">@chat.on_user_submit</span></span>
<span id="annotated-cell-10-145"><a href="#annotated-cell-10-145" aria-hidden="true" tabindex="-1"></a>    <span class="cf">async</span> <span class="kw">def</span> respond():</span>
<span id="annotated-cell-10-146"><a href="#annotated-cell-10-146" aria-hidden="true" tabindex="-1"></a>        <span class="co">"""Respond to the user's message."""</span></span>
<span id="annotated-cell-10-147"><a href="#annotated-cell-10-147" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Get the user's input</span></span>
<span id="annotated-cell-10-148"><a href="#annotated-cell-10-148" aria-hidden="true" tabindex="-1"></a>        usr_prompt <span class="op">=</span> chat.user_input()</span>
<span id="annotated-cell-10-149"><a href="#annotated-cell-10-149" aria-hidden="true" tabindex="-1"></a></span>
<span id="annotated-cell-10-150"><a href="#annotated-cell-10-150" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Check moderations endpoint incase openai policies are violated</span></span>
<span id="annotated-cell-10-151"><a href="#annotated-cell-10-151" aria-hidden="true" tabindex="-1"></a>        flag_check <span class="op">=</span> <span class="cf">await</span> check_moderation(</span>
<button class="code-annotation-anchor" data-target-cell="annotated-cell-10" data-target-annotation="3">3</button><span id="annotated-cell-10-152" class="code-annotation-target"><a href="#annotated-cell-10-152" aria-hidden="true" tabindex="-1"></a>            prompt<span class="op">=</span>usr_prompt, reactive_client<span class="op">=</span>openai_client)</span>
<span id="annotated-cell-10-153"><a href="#annotated-cell-10-153" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> flag_check <span class="op">!=</span> <span class="st">"good prompt"</span>:</span>
<span id="annotated-cell-10-154"><a href="#annotated-cell-10-154" aria-hidden="true" tabindex="-1"></a>            <span class="cf">await</span> chat.append_message({</span>
<span id="annotated-cell-10-155"><a href="#annotated-cell-10-155" aria-hidden="true" tabindex="-1"></a>                <span class="st">"role"</span>: <span class="st">"assistant"</span>,</span>
<span id="annotated-cell-10-156"><a href="#annotated-cell-10-156" aria-hidden="true" tabindex="-1"></a>                <span class="st">"content"</span>: <span class="ss">f"Your message may violate OpenAI's usage policy, categories: </span><span class="sc">{</span>flag_check<span class="sc">}</span><span class="ss">. Please rephrase your input and try again."</span></span>
<span id="annotated-cell-10-157"><a href="#annotated-cell-10-157" aria-hidden="true" tabindex="-1"></a>            })</span>
<span id="annotated-cell-10-158"><a href="#annotated-cell-10-158" aria-hidden="true" tabindex="-1"></a>        <span class="cf">else</span>:</span>
<span id="annotated-cell-10-159"><a href="#annotated-cell-10-159" aria-hidden="true" tabindex="-1"></a>            <span class="co">#  update the stream list</span></span>
<span id="annotated-cell-10-160"><a href="#annotated-cell-10-160" aria-hidden="true" tabindex="-1"></a>            stream.append({<span class="st">"role"</span>: <span class="st">"user"</span>, <span class="st">"content"</span>: usr_prompt})</span>
<span id="annotated-cell-10-161"><a href="#annotated-cell-10-161" aria-hidden="true" tabindex="-1"></a>            <span class="co"># Append a response to the chat</span></span>
<button class="code-annotation-anchor" data-target-cell="annotated-cell-10" data-target-annotation="4">4</button><span id="annotated-cell-10-162" class="code-annotation-target"><a href="#annotated-cell-10-162" aria-hidden="true" tabindex="-1"></a>            response <span class="op">=</span> <span class="cf">await</span> openai_client.get().chat.completions.create(</span>
<span id="annotated-cell-10-163"><a href="#annotated-cell-10-163" aria-hidden="true" tabindex="-1"></a>                model<span class="op">=</span><span class="st">"gpt-3.5-turbo"</span>,</span>
<span id="annotated-cell-10-164"><a href="#annotated-cell-10-164" aria-hidden="true" tabindex="-1"></a>                messages<span class="op">=</span>stream,</span>
<span id="annotated-cell-10-165"><a href="#annotated-cell-10-165" aria-hidden="true" tabindex="-1"></a>                temperature<span class="op">=</span><span class="fl">0.7</span>, <span class="co"># increase to make the model more creative</span></span>
<span id="annotated-cell-10-166"><a href="#annotated-cell-10-166" aria-hidden="true" tabindex="-1"></a>                )</span>
<span id="annotated-cell-10-167"><a href="#annotated-cell-10-167" aria-hidden="true" tabindex="-1"></a>            model_response <span class="op">=</span> response.choices[<span class="dv">0</span>].message.content</span>
<span id="annotated-cell-10-168"><a href="#annotated-cell-10-168" aria-hidden="true" tabindex="-1"></a>            <span class="cf">await</span> chat.append_message(model_response)</span>
<span id="annotated-cell-10-169"><a href="#annotated-cell-10-169" aria-hidden="true" tabindex="-1"></a>            <span class="co">#  if the model indicates game over, end game with a message.</span></span>
<span id="annotated-cell-10-170"><a href="#annotated-cell-10-170" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> <span class="st">"the end..."</span> <span class="kw">in</span> model_response.lower():</span>
<span id="annotated-cell-10-171"><a href="#annotated-cell-10-171" aria-hidden="true" tabindex="-1"></a>                <span class="cf">await</span> chat.append_message(</span>
<span id="annotated-cell-10-172"><a href="#annotated-cell-10-172" aria-hidden="true" tabindex="-1"></a>                    {</span>
<span id="annotated-cell-10-173"><a href="#annotated-cell-10-173" aria-hidden="true" tabindex="-1"></a>                        <span class="st">"role"</span>: <span class="st">"assistant"</span>,</span>
<span id="annotated-cell-10-174"><a href="#annotated-cell-10-174" aria-hidden="true" tabindex="-1"></a>                        <span class="st">"content"</span>: <span class="st">"Game Over! Refresh to play again."</span></span>
<span id="annotated-cell-10-175"><a href="#annotated-cell-10-175" aria-hidden="true" tabindex="-1"></a>                        })</span>
<span id="annotated-cell-10-176"><a href="#annotated-cell-10-176" aria-hidden="true" tabindex="-1"></a>                exit()</span>
<span id="annotated-cell-10-177"><a href="#annotated-cell-10-177" aria-hidden="true" tabindex="-1"></a>            <span class="cf">else</span>:</span>
<span id="annotated-cell-10-178"><a href="#annotated-cell-10-178" aria-hidden="true" tabindex="-1"></a>                stream.append(</span>
<span id="annotated-cell-10-179"><a href="#annotated-cell-10-179" aria-hidden="true" tabindex="-1"></a>                    {<span class="st">"role"</span>: <span class="st">"assistant"</span>, <span class="st">"content"</span>: model_response})</span>
<span id="annotated-cell-10-180"><a href="#annotated-cell-10-180" aria-hidden="true" tabindex="-1"></a></span>
<span id="annotated-cell-10-181"><a href="#annotated-cell-10-181" aria-hidden="true" tabindex="-1"></a></span>
<span id="annotated-cell-10-182"><a href="#annotated-cell-10-182" aria-hidden="true" tabindex="-1"></a>app <span class="op">=</span> App(ui<span class="op">=</span>app_ui, server<span class="op">=</span>server)</span><div class="code-annotation-gutter-bg"></div><div class="code-annotation-gutter"></div></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<dl class="code-annotation-container-hidden code-annotation-container-grid">
<dt data-target-cell="annotated-cell-10" data-target-annotation="1">1</dt>
<dd>
<span data-code-cell="annotated-cell-10" data-code-lines="89" data-code-annotation="1">Shiny <a href="https://shiny.posit.co/py/api/core/reactive.value.html" target="_blank">reactive values</a> are often good choices for objects that you intend to update at multiple points within a shiny server. Here we are defining an empty reactive value that we can subsequently use to store and access an openai client.</span>
</dd>
<dt data-target-cell="annotated-cell-10" data-target-annotation="2">2</dt>
<dd>
<span data-code-cell="annotated-cell-10" data-code-lines="104" data-code-annotation="2">It’s a subtle change, but now if the client returns a list of models, validating the api key that the user passed, then we set that client as the return value of the reactive value <code>openai_client</code>.</span>
</dd>
<dt data-target-cell="annotated-cell-10" data-target-annotation="3">3</dt>
<dd>
<span data-code-cell="annotated-cell-10" data-code-lines="152" data-code-annotation="3">The <code>check_moderations()</code> function expects to receive the reactive value object and will use it to <code>.get()</code> the stored client.</span>
</dd>
<dt data-target-cell="annotated-cell-10" data-target-annotation="4">4</dt>
<dd>
<span data-code-cell="annotated-cell-10" data-code-lines="162" data-code-annotation="4">This is the last occasion that we access the reactive client value. We initiated the client once and used it in three places to query 3 different endpoints.</span>
</dd>
</dl>
<p>This refactoring reduces the complexity of the app, ensuring that once the api key has been validated, that same openai client will be passed to the moderations and chat.completions endpoints.</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="https://i.imgur.com/cfdOQeS.png%22" class="img-fluid figure-img"></p>
<figcaption>Process diagram for iteration 8</figcaption>
</figure>
</div>
</div>
<div id="tabset-1-9" class="tab-pane" role="tabpanel" aria-labelledby="tabset-1-9-tab">
<p>In this final stage, we introduce some aesthetic changes - adding a theme and an image to add to the theme of the adventure.</p>
</div>
</div>
</div>
<p><a href="#iterations">Click to return to the start of the iteration tabsets</a></p>
<p>Finally, we have arrived at the end of the application development and we have a fully functional game with some additional safeguards against intentional misuse. If you’ve stuck with it this far - well done, I’d say you’ve earned yourself a pat on the back!</p>
<p>If you’d like to consider how to continue improving the app, then here are some suggestions:</p>
<ul>
<li>Pass more context to the moderations endpoint to minimise false positives.</li>
<li>Add a temperature control, so that the user can adjust how creative the models can be.</li>
<li>Add a model selection widget so that the user can try out responses with different openai models.</li>
<li>Experiment with <a href="https://github.com/r-leyshon/adventure-app/tree/stream-example" target="_blanks">streaming the responses</a> for a more responsive design.</li>
<li>Restructure your app to make use of <a href="https://shiny.posit.co/py/docs/modules.html" target="_blank">shiny modules</a>, increasing the application’s maintainability.</li>
</ul>
</section>
<section id="conclusion" class="level2">
<h2 class="anchored" data-anchor-id="conclusion">Conclusion</h2>
<ul>
<li>Recap the journey of building the app, from idea to deployment.</li>
<li>Mention potential future improvements (e.g., adding more complex storylines, user authentication, etc.).</li>
<li>Invite readers to try out the app or explore the code on GitHub.</li>
</ul>
</section>
<section id="call-to-action" class="level2">
<h2 class="anchored" data-anchor-id="call-to-action">Call to Action</h2>
<ul>
<li><strong>GitHub Link</strong>: Provide a link to the source code repository.</li>
<li><strong>Demo Link</strong>: If applicable, include a link to a live version of the app.</li>
<li><strong>Invitation for Feedback</strong>: Encourage readers to share their thoughts or improvements in the comments.</li>
</ul>
<p>If you spot an error with this article, or have a suggested improvement then feel free to leave a comment (GitHub login required) or <a href="https://github.com/r-leyshon/blogging/issues">raise an issue on GitHub</a>.</p>
<p id="fin">
<i>fin!</i>
</p>


</section>

</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const disableStylesheet = (stylesheets) => {
    for (let i=0; i < stylesheets.length; i++) {
      const stylesheet = stylesheets[i];
      stylesheet.rel = 'prefetch';
    }
  }
  const enableStylesheet = (stylesheets) => {
    for (let i=0; i < stylesheets.length; i++) {
      const stylesheet = stylesheets[i];
      stylesheet.rel = 'stylesheet';
    }
  }
  const manageTransitions = (selector, allowTransitions) => {
    const els = window.document.querySelectorAll(selector);
    for (let i=0; i < els.length; i++) {
      const el = els[i];
      if (allowTransitions) {
        el.classList.remove('notransition');
      } else {
        el.classList.add('notransition');
      }
    }
  }
  const toggleGiscusIfUsed = (isAlternate, darkModeDefault) => {
    const baseTheme = document.querySelector('#giscus-base-theme')?.value ?? 'light';
    const alternateTheme = document.querySelector('#giscus-alt-theme')?.value ?? 'dark';
    let newTheme = '';
    if(darkModeDefault) {
      newTheme = isAlternate ? baseTheme : alternateTheme;
    } else {
      newTheme = isAlternate ? alternateTheme : baseTheme;
    }
    const changeGiscusTheme = () => {
      // From: https://github.com/giscus/giscus/issues/336
      const sendMessage = (message) => {
        const iframe = document.querySelector('iframe.giscus-frame');
        if (!iframe) return;
        iframe.contentWindow.postMessage({ giscus: message }, 'https://giscus.app');
      }
      sendMessage({
        setConfig: {
          theme: newTheme
        }
      });
    }
    const isGiscussLoaded = window.document.querySelector('iframe.giscus-frame') !== null;
    if (isGiscussLoaded) {
      changeGiscusTheme();
    }
  }
  const toggleColorMode = (alternate) => {
    // Switch the stylesheets
    const alternateStylesheets = window.document.querySelectorAll('link.quarto-color-scheme.quarto-color-alternate');
    manageTransitions('#quarto-margin-sidebar .nav-link', false);
    if (alternate) {
      enableStylesheet(alternateStylesheets);
      for (const sheetNode of alternateStylesheets) {
        if (sheetNode.id === "quarto-bootstrap") {
          toggleBodyColorMode(sheetNode);
        }
      }
    } else {
      disableStylesheet(alternateStylesheets);
      toggleBodyColorPrimary();
    }
    manageTransitions('#quarto-margin-sidebar .nav-link', true);
    // Switch the toggles
    const toggles = window.document.querySelectorAll('.quarto-color-scheme-toggle');
    for (let i=0; i < toggles.length; i++) {
      const toggle = toggles[i];
      if (toggle) {
        if (alternate) {
          toggle.classList.add("alternate");     
        } else {
          toggle.classList.remove("alternate");
        }
      }
    }
    // Hack to workaround the fact that safari doesn't
    // properly recolor the scrollbar when toggling (#1455)
    if (navigator.userAgent.indexOf('Safari') > 0 && navigator.userAgent.indexOf('Chrome') == -1) {
      manageTransitions("body", false);
      window.scrollTo(0, 1);
      setTimeout(() => {
        window.scrollTo(0, 0);
        manageTransitions("body", true);
      }, 40);  
    }
  }
  const isFileUrl = () => { 
    return window.location.protocol === 'file:';
  }
  const hasAlternateSentinel = () => {  
    let styleSentinel = getColorSchemeSentinel();
    if (styleSentinel !== null) {
      return styleSentinel === "alternate";
    } else {
      return false;
    }
  }
  const setStyleSentinel = (alternate) => {
    const value = alternate ? "alternate" : "default";
    if (!isFileUrl()) {
      window.localStorage.setItem("quarto-color-scheme", value);
    } else {
      localAlternateSentinel = value;
    }
  }
  const getColorSchemeSentinel = () => {
    if (!isFileUrl()) {
      const storageValue = window.localStorage.getItem("quarto-color-scheme");
      return storageValue != null ? storageValue : localAlternateSentinel;
    } else {
      return localAlternateSentinel;
    }
  }
  const darkModeDefault = false;
  let localAlternateSentinel = darkModeDefault ? 'alternate' : 'default';
  // Dark / light mode switch
  window.quartoToggleColorScheme = () => {
    // Read the current dark / light value 
    let toAlternate = !hasAlternateSentinel();
    toggleColorMode(toAlternate);
    setStyleSentinel(toAlternate);
    toggleGiscusIfUsed(toAlternate, darkModeDefault);
  };
  // Ensure there is a toggle, if there isn't float one in the top right
  if (window.document.querySelector('.quarto-color-scheme-toggle') === null) {
    const a = window.document.createElement('a');
    a.classList.add('top-right');
    a.classList.add('quarto-color-scheme-toggle');
    a.href = "";
    a.onclick = function() { try { window.quartoToggleColorScheme(); } catch {} return false; };
    const i = window.document.createElement("i");
    i.classList.add('bi');
    a.appendChild(i);
    window.document.body.appendChild(a);
  }
  // Switch to dark mode if need be
  if (hasAlternateSentinel()) {
    toggleColorMode(true);
  } else {
    toggleColorMode(false);
  }
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const onCopySuccess = function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  }
  const getTextToCopy = function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
    text: getTextToCopy
  });
  clipboard.on('success', onCopySuccess);
  if (window.document.getElementById('quarto-embedded-source-code-modal')) {
    // For code content inside modals, clipBoardJS needs to be initialized with a container option
    // TODO: Check when it could be a function (https://github.com/zenorocha/clipboard.js/issues/860)
    const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
      text: getTextToCopy,
      container: window.document.getElementById('quarto-embedded-source-code-modal')
    });
    clipboardModal.on('success', onCopySuccess);
  }
    var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
    var mailtoRegex = new RegExp(/^mailto:/);
      var filterRegex = new RegExp("https:\/\/thedatasavvycorner\.netlify\.app\/");
    var isInternal = (href) => {
        return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
    }
    // Inspect non-navigation links and adorn them if external
 	var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
    for (var i=0; i<links.length; i++) {
      const link = links[i];
      if (!isInternal(link.href)) {
        // undo the damage that might have been done by quarto-nav.js in the case of
        // links that we want to consider external
        if (link.dataset.originalHref !== undefined) {
          link.href = link.dataset.originalHref;
        }
      }
    }
  function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
    const config = {
      allowHTML: true,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start',
    };
    if (contentFn) {
      config.content = contentFn;
    }
    if (onTriggerFn) {
      config.onTrigger = onTriggerFn;
    }
    if (onUntriggerFn) {
      config.onUntrigger = onUntriggerFn;
    }
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      if (note) {
        return note.innerHTML;
      } else {
        return "";
      }
    });
  }
  const xrefs = window.document.querySelectorAll('a.quarto-xref');
  const processXRef = (id, note) => {
    // Strip column container classes
    const stripColumnClz = (el) => {
      el.classList.remove("page-full", "page-columns");
      if (el.children) {
        for (const child of el.children) {
          stripColumnClz(child);
        }
      }
    }
    stripColumnClz(note)
    if (id === null || id.startsWith('sec-')) {
      // Special case sections, only their first couple elements
      const container = document.createElement("div");
      if (note.children && note.children.length > 2) {
        container.appendChild(note.children[0].cloneNode(true));
        for (let i = 1; i < note.children.length; i++) {
          const child = note.children[i];
          if (child.tagName === "P" && child.innerText === "") {
            continue;
          } else {
            container.appendChild(child.cloneNode(true));
            break;
          }
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(container);
        }
        return container.innerHTML
      } else {
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        return note.innerHTML;
      }
    } else {
      // Remove any anchor links if they are present
      const anchorLink = note.querySelector('a.anchorjs-link');
      if (anchorLink) {
        anchorLink.remove();
      }
      if (window.Quarto?.typesetMath) {
        window.Quarto.typesetMath(note);
      }
      // TODO in 1.5, we should make sure this works without a callout special case
      if (note.classList.contains("callout")) {
        return note.outerHTML;
      } else {
        return note.innerHTML;
      }
    }
  }
  for (var i=0; i<xrefs.length; i++) {
    const xref = xrefs[i];
    tippyHover(xref, undefined, function(instance) {
      instance.disable();
      let url = xref.getAttribute('href');
      let hash = undefined; 
      if (url.startsWith('#')) {
        hash = url;
      } else {
        try { hash = new URL(url).hash; } catch {}
      }
      if (hash) {
        const id = hash.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note !== null) {
          try {
            const html = processXRef(id, note.cloneNode(true));
            instance.setContent(html);
          } finally {
            instance.enable();
            instance.show();
          }
        } else {
          // See if we can fetch this
          fetch(url.split('#')[0])
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.getElementById(id);
            if (note !== null) {
              const html = processXRef(id, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      } else {
        // See if we can fetch a full url (with no hash to target)
        // This is a special case and we should probably do some content thinning / targeting
        fetch(url)
        .then(res => res.text())
        .then(html => {
          const parser = new DOMParser();
          const htmlDoc = parser.parseFromString(html, "text/html");
          const note = htmlDoc.querySelector('main.content');
          if (note !== null) {
            // This should only happen for chapter cross references
            // (since there is no id in the URL)
            // remove the first header
            if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
              note.children[0].remove();
            }
            const html = processXRef(null, note);
            instance.setContent(html);
          } 
        }).finally(() => {
          instance.enable();
          instance.show();
        });
      }
    }, function(instance) {
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            div.style.left = 0;
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
        // Handle positioning of the toggle
    window.addEventListener(
      "resize",
      throttle(() => {
        elRect = undefined;
        if (selectedAnnoteEl) {
          selectCodeLines(selectedAnnoteEl);
        }
      }, 10)
    );
    function throttle(fn, ms) {
    let throttle = false;
    let timer;
      return (...args) => {
        if(!throttle) { // first call gets through
            fn.apply(this, args);
            throttle = true;
        } else { // all the others get throttled
            if(timer) clearTimeout(timer); // cancel #2
            timer = setTimeout(() => {
              fn.apply(this, args);
              timer = throttle = false;
            }, ms);
        }
      };
    }
      const annoteTargets = window.document.querySelectorAll('.code-annotation-anchor');
      for (let i=0; i<annoteTargets.length; i++) {
        const annoteTarget = annoteTargets[i];
        const targetCell = annoteTarget.getAttribute("data-target-cell");
        const targetAnnotation = annoteTarget.getAttribute("data-target-annotation");
        const contentFn = () => {
          const content = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
          if (content) {
            const tipContent = content.cloneNode(true);
            tipContent.classList.add("code-annotation-tip-content");
            return tipContent.outerHTML;
          }
        }
        const config = {
          allowHTML: true,
          content: contentFn,
          onShow: (instance) => {
            selectCodeLines(instance.reference);
            instance.reference.classList.add('code-annotation-active');
            window.tippy.hideAll();
          },
          onHide: (instance) => {
            unselectCodeLines();
            instance.reference.classList.remove('code-annotation-active');
          },
          maxWidth: 300,
          delay: [50, 0],
          duration: [200, 0],
          offset: [5, 10],
          arrow: true,
          trigger: 'click',
          appendTo: function(el) {
            return el.parentElement.parentElement.parentElement;
          },
          interactive: true,
          interactiveBorder: 10,
          theme: 'quarto',
          placement: 'right',
          positionFixed: true,
          popperOptions: {
            modifiers: [
            {
              name: 'flip',
              options: {
                flipVariations: false, // true by default
                allowedAutoPlacements: ['right'],
                fallbackPlacements: ['right', 'top', 'top-start', 'top-end', 'bottom', 'bottom-start', 'bottom-end', 'left'],
              },
            },
            {
              name: 'preventOverflow',
              options: {
                mainAxis: false,
                altAxis: false
              }
            }
            ]        
          }      
        };
        window.tippy(annoteTarget, config); 
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
<script src="https://giscus.app/client.js" data-repo="r-leyshon/blogging" data-repo-id="R_kgDOJ7xM-w" data-category="Announcements" data-category-id="DIC_kwDOJ7xM-84Chxs3" data-mapping="url" data-reactions-enabled="1" data-emit-metadata="0" data-input-position="top" data-theme="cobalt" data-lang="en" crossorigin="anonymous" async="">
</script>
<input type="hidden" id="giscus-base-theme" value="cobalt">
<input type="hidden" id="giscus-alt-theme" value="cobalt">
</div> <!-- /content -->




</body></html>